<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BloodGurgler</title>
<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Schoolbell&family=Architects+Daughter&family=Patrick+Hand&display=swap" rel="stylesheet">
<style>
  :root {
    --paper:        #ffffff;
    --paper-bg:     #f5f7fa;
    --ink:          #1a1a2e;
    --ink-soft:     #2d2d4a;
    --blue-pale:    #e8f4fd;
    --blue-rule:    #b8d8f0;
    --blue-mid:     #4a90c4;
    --blue-dark:    #1e5f8a;
    --blue-punch:   #0d3d6b;
    --red-dmg:      #d63031;
    --green-hp:     #00b894;
    --yellow-hp:    #f9ca24;
    --gold:         #e8a020;
    --choice-hover: #d4ebf8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background-color: var(--paper-bg);
    min-height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    font-family: 'Schoolbell', cursive;
    padding: 32px 16px 60px;
  }

  .game-container { width: 100%; max-width: 740px; }

  /* ===== MAIN CARD ===== */
  .card {
    background: var(--paper);
    border: 3px solid var(--blue-mid);
    border-top: 6px solid var(--blue-dark);
    border-radius: 4px;
    padding: 28px 36px 44px;
    position: relative;
    box-shadow: 0 4px 0 var(--blue-rule), 0 8px 24px rgba(30,95,138,0.1);
  }

  /* Blue accent strip at top */
  .card::before {
    content: '';
    position: absolute;
    top: -6px; left: 20px; right: 20px; height: 6px;
    background: var(--blue-dark);
    border-radius: 3px 3px 0 0;
    display: none; /* handled by border-top */
  }

  .version-tag {
    position: absolute; bottom: 14px; right: 16px;
    font-family: 'Architects Daughter', cursive;
    font-size: 0.62rem; color: var(--blue-rule); letter-spacing: 1px;
  }

  /* ===== TYPOGRAPHY ===== */
  .game-title {
    font-family: 'Permanent Marker', cursive;
    font-size: clamp(2.8rem, 9vw, 4.8rem);
    color: var(--ink);
    line-height: 0.92;
    text-align: center;
    letter-spacing: 1px;
    /* Blue underline scribble feel */
    text-shadow: 3px 4px 0 var(--blue-rule);
  }

  .game-subtitle {
    font-family: 'Architects Daughter', cursive;
    font-size: 0.85rem; color: var(--blue-mid);
    text-align: center; margin-top: 8px; margin-bottom: 14px;
    letter-spacing: 3px; text-transform: lowercase;
  }

  /* Hand-drawn divider: a scrawled line */
  .divider {
    border: none;
    border-top: 2.5px solid var(--blue-rule);
    margin: 14px 0;
    position: relative;
    /* Slight wobble via border-radius trick */
    border-radius: 50% / 4px;
  }

  /* ===== BUTTONS ===== */
  .btn-primary {
    display: inline-block;
    background: var(--blue-dark);
    color: white;
    border: 3px solid var(--ink);
    padding: 10px 26px;
    font-family: 'Permanent Marker', cursive;
    font-size: 1rem; letter-spacing: 1px;
    cursor: pointer; border-radius: 4px;
    box-shadow: 4px 4px 0 var(--ink);
    transition: all 0.08s; text-transform: uppercase;
    text-decoration: none;
  }
  .btn-primary:hover { transform: translate(-2px,-2px); box-shadow: 6px 6px 0 var(--ink); background: var(--blue-punch); }
  .btn-primary:active { transform: translate(3px,3px); box-shadow: 1px 1px 0 var(--ink); }

  .btn-secondary {
    display: inline-block;
    background: white;
    color: var(--blue-dark);
    border: 2.5px solid var(--blue-mid);
    padding: 10px 20px;
    font-family: 'Architects Daughter', cursive;
    font-size: 0.9rem;
    cursor: pointer; border-radius: 4px;
    box-shadow: 3px 3px 0 var(--blue-rule);
    transition: all 0.08s;
    text-decoration: none;
  }
  .btn-secondary:hover { transform: translate(-1px,-1px); box-shadow: 4px 4px 0 var(--blue-mid); }
  .btn-secondary:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 var(--blue-mid); }

  .btns-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 18px; }

  /* ===== SCREEN TRANSITIONS ===== */
  .screen-active { animation: fadeUp 0.28s ease both; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* ===== TITLE SCREEN ===== */
  #screen-title { text-align: center; }

  .title-doodle {
    font-family: 'Schoolbell', cursive;
    font-size: 1.05rem; color: var(--ink-soft);
    line-height: 1.65; margin: 10px 0 16px;
  }
  .title-doodle em {
    font-style: italic; color: var(--blue-mid); font-size: 0.95rem;
  }

  .rules-box {
    background: var(--blue-pale);
    border: 2.5px solid var(--blue-rule);
    border-left: 5px solid var(--blue-mid);
    border-radius: 4px;
    padding: 12px 16px; margin-bottom: 6px;
    text-align: left;
  }
  .rules-box p {
    font-family: 'Schoolbell', cursive;
    color: var(--ink-soft); font-size: 1.05rem;
    margin-bottom: 4px; line-height: 1.5;
  }
  .rules-box p:last-child { margin-bottom: 0; }
  .rules-box strong { color: var(--blue-dark); font-weight: normal; }

  /* ===== BATTLE SCREEN ===== */
  #screen-battle { display: none; padding-bottom: 58px; }

  /* HUD strip */
  .battle-hud {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 8px; padding: 7px 12px;
    background: var(--blue-pale);
    border: 2.5px solid var(--blue-rule);
    border-radius: 4px;
  }
  .hud-block { text-align: center; min-width: 44px; }
  .hud-label {
    font-family: 'Architects Daughter', cursive;
    font-size: 0.54rem; letter-spacing: 2px;
    color: var(--blue-mid); text-transform: uppercase;
    display: block; margin-bottom: 1px;
  }
  .hud-value {
    font-family: 'Permanent Marker', cursive;
    font-size: 1.45rem; color: var(--ink); line-height: 1;
  }
  .hud-streak { color: var(--blue-dark); }
  .hud-gold   { color: var(--gold); }

  .hp-bar-wrap {
    flex: 1; height: 13px;
    background: white; border: 2px solid var(--ink);
    border-radius: 3px; overflow: hidden;
  }
  .hp-bar { height: 100%; transition: width 0.4s ease, background 0.4s; }
  .hp-bar.player { background: var(--green-hp); }
  .hp-bar.boss   { background: var(--red-dmg); }

  /* Boss progress pips */
  .boss-progress {
    display: flex; gap: 8px; justify-content: center; margin-bottom: 10px;
  }
  .boss-pip {
    width: 34px; height: 34px; border-radius: 4px;
    border: 2.5px solid var(--blue-rule);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.05rem; background: white;
  }
  .boss-pip.defeated { border-color: var(--green-hp); background: #effffa; }
  .boss-pip.current  { border-color: var(--red-dmg); background: #fff3f3; animation: pipBeat 0.9s infinite alternate; }
  @keyframes pipBeat { from{box-shadow:0 0 0 0 rgba(214,48,49,0.5)} to{box-shadow:0 0 0 5px rgba(214,48,49,0)} }

  /* ===== BATTLEFIELD ===== */
  /* Graph/grid paper look */
  .battlefield {
    display: flex; align-items: flex-end; justify-content: space-between;
    gap: 8px; margin: 6px 0 10px; min-height: 160px;
    padding: 10px 12px;
    background: white;
    border: 2.5px solid var(--blue-rule);
    border-radius: 4px;
    position: relative;
  }

  .combatant {
    display: flex; flex-direction: column; align-items: center; gap: 5px; flex: 1;
  }
  .combatant-name {
    font-family: 'Architects Daughter', cursive;
    font-size: 0.62rem; letter-spacing: 1px;
    color: var(--blue-dark); text-transform: uppercase;
  }
  .combatant-sprite { display: flex; align-items: center; justify-content: center; }
  .combatant-hp-row {
    display: flex; align-items: center; gap: 5px; width: 100%;
  }
  .combatant-hp-label {
    font-family: 'Schoolbell', cursive; font-size: 0.7rem;
    color: var(--ink-soft); white-space: nowrap;
  }

  /* Imps */
  .imp-row { display: flex; gap: 6px; align-items: flex-end; justify-content: center; flex: 1; }
  .imp-unit { display: flex; flex-direction: column; align-items: center; gap: 3px; transition: opacity 0.4s; }
  .imp-unit.dead { opacity: 0.15; filter: grayscale(1); }
  .imp-hp-wrap { width: 30px; height: 5px; background: white; border: 1.5px solid var(--ink); border-radius: 1px; overflow: hidden; }
  .imp-hp-bar  { height: 100%; background: var(--red-dmg); transition: width 0.4s; }
  .imp-label   { font-family: 'Schoolbell', cursive; font-size: 0.48rem; color: var(--blue-mid); }

  .vs-text {
    font-family: 'Permanent Marker', cursive;
    font-size: 1.5rem; color: var(--blue-rule);
    align-self: center; padding-bottom: 18px;
    text-shadow: 2px 2px 0 var(--blue-pale);
  }

  /* Hit flash */
  .hit-flash { animation: hitF 0.32s ease; }
  @keyframes hitF { 0%{filter:brightness(1)} 35%{filter:brightness(2.2) saturate(2) hue-rotate(30deg)} 100%{filter:brightness(1)} }

  /* ===== QUESTION TIMER ===== */
  .q-timer-wrap {
    height: 8px; background: white;
    border: 2px solid var(--ink); border-radius: 3px;
    overflow: hidden; margin-bottom: 10px;
  }
  .q-timer-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--blue-punch), var(--blue-mid));
    transition: width 0.25s linear;
  }
  .q-timer-bar.urgent { background: var(--red-dmg); animation: urgPulse 0.3s infinite alternate; }
  @keyframes urgPulse { from{opacity:1} to{opacity:0.45} }

  /* ===== QUESTION AREA ===== */
  .question-area {
    text-align: center; min-height: 68px;
    display: flex; flex-direction: column; justify-content: center;
    margin-bottom: 10px; padding: 10px 12px;
    background: var(--blue-pale);
    border: 2.5px solid var(--blue-rule);
    border-radius: 4px;
  }
  .question-type-tag {
    font-family: 'Architects Daughter', cursive;
    font-size: 0.6rem; letter-spacing: 3px;
    color: var(--blue-mid); text-transform: uppercase; margin-bottom: 5px;
  }
  .question-text {
    font-family: 'Patrick Hand', cursive;
    font-size: clamp(1.1rem, 3.5vw, 1.5rem);
    color: var(--ink); line-height: 1.3;
  }
  .angle-val { color: var(--blue-dark); }

  /* ===== CHOICES ===== */
  .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .choice-btn {
    background: white;
    border: 2.5px solid var(--blue-rule);
    border-radius: 4px; padding: 11px 10px;
    font-family: 'Patrick Hand', cursive; font-size: 1.1rem;
    color: var(--ink); cursor: pointer;
    box-shadow: 3px 3px 0 var(--blue-rule);
    transition: all 0.08s; min-height: 48px;
  }
  .choice-btn:hover:not(:disabled) {
    background: var(--choice-hover); border-color: var(--blue-mid);
    transform: translate(-1px,-1px); box-shadow: 4px 4px 0 var(--blue-mid);
  }
  .choice-btn:active:not(:disabled) { transform: translate(2px,2px); box-shadow: 1px 1px 0 var(--blue-mid); }
  .choice-btn.correct { background:#e8fff5; border-color:var(--green-hp); color:#007a55; box-shadow:3px 3px 0 var(--green-hp); animation:cPop 0.28s ease; }
  .choice-btn.wrong   { background:#fff0f0; border-color:var(--red-dmg); color:var(--red-dmg); box-shadow:3px 3px 0 var(--red-dmg); animation:wShake 0.28s ease; }
  .choice-btn.reveal  { background:#e8fff5; border-color:var(--green-hp); color:#007a55; }
  .choice-btn:disabled { cursor:not-allowed; }
  @keyframes cPop   { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
  @keyframes wShake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} 100%{transform:translateX(0)} }

  /* Feedback */
  .battle-feedback {
    text-align: center; min-height: 20px;
    font-family: 'Architects Daughter', cursive;
    font-size: 0.88rem; color: var(--blue-dark); letter-spacing: 1px;
  }

  /* ===== FLAMES ===== */
  .flame-row {
    position: absolute; bottom:0; left:0; right:0; height:48px;
    pointer-events:none; display:flex; align-items:flex-end; justify-content:center;
    padding-bottom:2px; opacity:0; transition:opacity 0.7s;
    overflow:hidden; border-radius:0 0 4px 4px;
  }
  .flame-row.active { opacity:1; }
  .flame { display:inline-block; line-height:1; transform-origin:bottom center; }
  @keyframes flameSize {
    0%{font-size:var(--fs-a)} 25%{font-size:var(--fs-b)}
    50%{font-size:var(--fs-c)} 75%{font-size:var(--fs-b)}
    100%{font-size:var(--fs-a)}
  }

  /* ===== INTERSTITIALS ===== */
  #screen-victory, #screen-gameover, #screen-win { display: none; text-align: center; }

  .inter-title {
    font-family: 'Permanent Marker', cursive;
    font-size: clamp(1.9rem, 6vw, 3rem);
    line-height: 1.05; margin-bottom: 6px;
  }
  .title-victory { color: var(--blue-dark);  text-shadow: 3px 3px 0 var(--blue-rule); }
  .title-defeat  { color: var(--red-dmg);    text-shadow: 3px 3px 0 #ffc8c8; }

  .gold-earned {
    font-family: 'Permanent Marker', cursive;
    font-size: 1.8rem; color: var(--gold); margin: 12px 0 3px;
  }
  .gold-total {
    font-family: 'Architects Daughter', cursive;
    font-size: 0.82rem; color: var(--blue-mid); letter-spacing: 2px;
  }
  .inter-msg {
    font-family: 'Schoolbell', cursive; font-size: 1.1rem;
    color: var(--ink-soft); line-height: 1.65; margin: 10px 0 14px;
  }
  .sprite-display {
    margin: 10px auto; display: flex; justify-content: center; gap: 8px; align-items: flex-end;
  }

  .big-gold {
    font-family: 'Permanent Marker', cursive;
    font-size: clamp(3.5rem, 12vw, 6.5rem);
    color: var(--gold); text-shadow: 4px 4px 0 #b07010;
    line-height: 1;
  }
</style>
</head>
<body>
<div class="game-container">
  <div class="card" id="main-card">

    <span class="version-tag">v0.20</span>

    <!-- ===== TITLE SCREEN ===== -->
    <div id="screen-title">
      <div class="game-title">BLOOD</div>
      <div class="game-title" style="margin-bottom:10px;">GURGLER</div>
      <div class="game-subtitle">phase 2 ‚Äî the four trials</div>

      <!-- Placeholder hero (daughter's drawing goes here) -->
      <svg width="72" height="96" viewBox="0 0 72 96" style="display:block;margin:8px auto 4px;" xmlns="http://www.w3.org/2000/svg">
        <!-- Intentionally wobbly, like drawn by a kid during math class -->
        <circle cx="36" cy="15" r="12" fill="none" stroke="#1a1a2e" stroke-width="2.8"/>
        <circle cx="31" cy="13" r="2" fill="#1a1a2e"/>
        <circle cx="41" cy="13" r="2" fill="#1a1a2e"/>
        <path d="M31 19 Q36 23 41 19" stroke="#1a1a2e" stroke-width="1.8" fill="none" stroke-linecap="round"/>
        <!-- body - slightly wobbly -->
        <path d="M36 27 Q35 45 37 64" stroke="#1a1a2e" stroke-width="3.2" fill="none" stroke-linecap="round"/>
        <!-- arms -->
        <path d="M36 38 Q22 42 14 55" stroke="#1a1a2e" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <path d="M36 38 Q50 36 60 46" stroke="#1a1a2e" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <!-- sword! -->
        <path d="M60 46 Q67 37 70 22" stroke="#4a90c4" stroke-width="3.2" fill="none" stroke-linecap="round"/>
        <path d="M64 40 Q67 43 70 40" stroke="#4a90c4" stroke-width="2.2" fill="none" stroke-linecap="round"/>
        <!-- legs -->
        <path d="M37 64 Q28 76 22 88" stroke="#1a1a2e" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <path d="M37 64 Q46 76 52 88" stroke="#1a1a2e" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <!-- cape squiggle -->
        <path d="M25 28 Q16 42 19 56" stroke="#4a90c4" stroke-width="1.8" fill="none" stroke-linecap="round" opacity="0.6"/>
      </svg>
      <div class="title-doodle">
        Four bosses. One hero. Zero mercy.<br>
        <em>(The monsters were drawn by a 5-year-old.<br>They are absolutely terrifying.)</em>
      </div>

      <div class="rules-box">
        <p>‚öî <strong>Correct answer</strong> ‚Äî you hit the boss!</p>
        <p>üíÄ <strong>Wrong or too slow</strong> ‚Äî boss hits you. Streak resets.</p>
        <p>‚è± <strong>15 seconds</strong> per question. Think fast.</p>
        <p>üî• <strong>Streak 1-2</strong> = 1 dmg &nbsp;|&nbsp; <strong>3-4</strong> = 2 dmg &nbsp;|&nbsp; <strong>5+</strong> = 3 dmg</p>
        <p>üí∞ Defeat each boss to earn <strong>gold</strong>. Spend it in Phase III.</p>
        <p>‚ò† HP = 0 means <strong>PERMADEATH</strong>. Keep your gold. Respawn. Avenge yourself.</p>
      </div>

      <div class="btns-row">
        <button class="btn-primary" onclick="startGame()">ENTER THE DUNGEON</button>
      </div>
    </div>

    <!-- ===== BATTLE SCREEN ===== -->
    <div id="screen-battle">
      <div class="battle-hud">
        <div class="hud-block">
          <span class="hud-label">HP</span>
          <span class="hud-value" id="player-hp-val">20</span>
        </div>
        <div class="hp-bar-wrap">
          <div class="hp-bar player" id="player-hp-bar" style="width:100%"></div>
        </div>
        <div class="hud-block">
          <span class="hud-label">Streak</span>
          <span class="hud-value hud-streak" id="streak-display">0</span>
        </div>
        <div class="hud-block" style="margin-left:6px">
          <span class="hud-label">Gold</span>
          <span class="hud-value hud-gold" id="gold-display">0</span>
        </div>
      </div>

      <div class="boss-progress" id="boss-progress"></div>
      <div class="battlefield" id="battlefield"></div>

      <div class="q-timer-wrap">
        <div class="q-timer-bar" id="q-timer-bar"></div>
      </div>

      <div class="question-area">
        <div class="question-type-tag" id="q-type-tag"></div>
        <div class="question-text" id="q-text"></div>
      </div>

      <div class="choices-grid" id="choices-grid"></div>
      <div class="battle-feedback" id="battle-feedback"></div>
      <div class="flame-row" id="flame-row"></div>
    </div>

    <!-- ===== BOSS VICTORY ===== -->
    <div id="screen-victory">
      <div class="inter-title title-victory" id="victory-title">DEFEATED!</div>
      <div class="divider"></div>
      <div class="sprite-display" id="victory-sprite"></div>
      <div class="inter-msg" id="victory-msg"></div>
      <div class="gold-earned" id="gold-earned-display"></div>
      <div class="gold-total" id="gold-total-display"></div>
      <div class="btns-row">
        <button class="btn-primary" id="next-boss-btn" onclick="advanceToNextBoss()">ONWARD!</button>
      </div>
    </div>

    <!-- ===== GAME OVER ===== -->
    <div id="screen-gameover">
      <div class="inter-title title-defeat">YOU DIED.</div>
      <div class="divider"></div>
      <div class="sprite-display" id="gameover-sprite"></div>
      <div class="inter-msg" id="gameover-msg"></div>
      <div class="gold-earned" id="gameover-gold-display"></div>
      <div class="gold-total" style="margin-bottom:20px">gold pieces kept</div>
      <div class="btns-row">
        <button class="btn-primary" onclick="startGame()">TRY AGAIN</button>
        <button class="btn-secondary" onclick="showTitle()">Main Menu</button>
      </div>
    </div>

    <!-- ===== FINAL WIN ===== -->
    <div id="screen-win">
      <div class="inter-title title-victory">DUNGEON CLEARED!!</div>
      <div class="game-subtitle">all four bosses destroyed</div>
      <div class="divider"></div>
      <!-- Win hero SVG -->
      <svg width="72" height="96" viewBox="0 0 72 96" style="display:block;margin:8px auto;" xmlns="http://www.w3.org/2000/svg">
        <circle cx="36" cy="15" r="12" fill="none" stroke="#1e5f8a" stroke-width="2.8"/>
        <circle cx="31" cy="13" r="2" fill="#1e5f8a"/>
        <circle cx="41" cy="13" r="2" fill="#1e5f8a"/>
        <path d="M31 20 Q36 24 41 20" stroke="#1e5f8a" stroke-width="2" fill="none" stroke-linecap="round"/>
        <path d="M36 27 Q35 45 37 64" stroke="#1e5f8a" stroke-width="3.2" fill="none" stroke-linecap="round"/>
        <path d="M36 38 Q22 42 14 55" stroke="#1e5f8a" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <path d="M36 38 Q50 36 60 46" stroke="#1e5f8a" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <path d="M60 46 Q67 37 70 22" stroke="#e8a020" stroke-width="3.2" fill="none" stroke-linecap="round"/>
        <path d="M64 40 Q67 43 70 40" stroke="#e8a020" stroke-width="2.2" fill="none" stroke-linecap="round"/>
        <path d="M37 64 Q28 76 22 88" stroke="#1e5f8a" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <path d="M37 64 Q46 76 52 88" stroke="#1e5f8a" stroke-width="2.8" fill="none" stroke-linecap="round"/>
        <text x="2"  y="18" font-size="12" fill="#e8a020">‚òÖ</text>
        <text x="56" y="18" font-size="12" fill="#e8a020">‚òÖ</text>
        <text x="30" y="96" font-size="12" fill="#e8a020">‚òÖ</text>
      </svg>
      <div style="font-family:'Architects Daughter',cursive;font-size:0.78rem;color:var(--blue-mid);margin:14px 0 4px;letter-spacing:3px;">TOTAL GOLD</div>
      <div class="big-gold" id="win-gold-display">0</div>
      <div style="font-family:'Schoolbell',cursive;font-size:0.9rem;color:var(--blue-mid);margin:4px 0 8px;">üí∞ gold pieces</div>
      <div class="inter-msg" id="win-msg"></div>
      <div class="btns-row">
        <button class="btn-primary" onclick="startGame()">DESCEND AGAIN</button>
        <button class="btn-secondary" onclick="showTitle()">Main Menu</button>
      </div>
    </div>

  </div><!-- .card -->
</div><!-- .game-container -->

<script>
// ================================================================
//  UNIT CIRCLE DATA ‚Äî identical to Phase 1
// ================================================================
const ANGLES = [
  {deg:0,   rad:'0',     sin:'0',     cos:'1',     tan:'0'        },
  {deg:30,  rad:'œÄ/6',   sin:'1/2',   cos:'‚àö3/2',  tan:'‚àö3/3'     },
  {deg:45,  rad:'œÄ/4',   sin:'‚àö2/2',  cos:'‚àö2/2',  tan:'1'        },
  {deg:60,  rad:'œÄ/3',   sin:'‚àö3/2',  cos:'1/2',   tan:'‚àö3'       },
  {deg:90,  rad:'œÄ/2',   sin:'1',     cos:'0',     tan:'undefined'},
  {deg:120, rad:'2œÄ/3',  sin:'‚àö3/2',  cos:'-1/2',  tan:'-‚àö3'      },
  {deg:135, rad:'3œÄ/4',  sin:'‚àö2/2',  cos:'-‚àö2/2', tan:'-1'       },
  {deg:150, rad:'5œÄ/6',  sin:'1/2',   cos:'-‚àö3/2', tan:'-‚àö3/3'    },
  {deg:180, rad:'œÄ',     sin:'0',     cos:'-1',    tan:'0'        },
  {deg:210, rad:'7œÄ/6',  sin:'-1/2',  cos:'-‚àö3/2', tan:'‚àö3/3'     },
  {deg:225, rad:'5œÄ/4',  sin:'-‚àö2/2', cos:'-‚àö2/2', tan:'1'        },
  {deg:240, rad:'4œÄ/3',  sin:'-‚àö3/2', cos:'-1/2',  tan:'‚àö3'       },
  {deg:270, rad:'3œÄ/2',  sin:'-1',    cos:'0',     tan:'undefined'},
  {deg:300, rad:'5œÄ/3',  sin:'-‚àö3/2', cos:'1/2',   tan:'-‚àö3'      },
  {deg:315, rad:'7œÄ/4',  sin:'-‚àö2/2', cos:'‚àö2/2',  tan:'-1'       },
  {deg:330, rad:'11œÄ/6', sin:'-1/2',  cos:'‚àö3/2',  tan:'-‚àö3/3'    },
];
const SIN_COS_POOL=['0','1','-1','1/2','-1/2','‚àö2/2','-‚àö2/2','‚àö3/2','-‚àö3/2'];
const TAN_POOL    =['0','1','-1','‚àö3','-‚àö3','‚àö3/3','-‚àö3/3','undefined'];
const RAD_POOL    =['0','œÄ/6','œÄ/4','œÄ/3','œÄ/2','2œÄ/3','3œÄ/4','5œÄ/6','œÄ','7œÄ/6','5œÄ/4','4œÄ/3','3œÄ/2','5œÄ/3','7œÄ/4','11œÄ/6','2œÄ'];
const DEG_POOL    =['0¬∞','30¬∞','45¬∞','60¬∞','90¬∞','120¬∞','135¬∞','150¬∞','180¬∞','210¬∞','225¬∞','240¬∞','270¬∞','300¬∞','315¬∞','330¬∞','360¬∞'];

function buildQuestionPool() {
  const pool=[];
  for(const a of ANGLES){
    const deg=a.deg+'¬∞', rad=a.deg===0?'0':a.rad;
    pool.push({tag:'Degrees ‚Üí Radians', html:`Convert <span class="angle-val">${deg}</span> to radians`, answer:rad, pool:RAD_POOL});
    pool.push({tag:'Radians ‚Üí Degrees', html:`Convert <span class="angle-val">${rad}</span> to degrees`, answer:deg, pool:DEG_POOL});
    pool.push({tag:'Sine',    html:`sin(<span class="angle-val">${deg}</span>) = ?`, answer:a.sin, pool:SIN_COS_POOL});
    pool.push({tag:'Cosine',  html:`cos(<span class="angle-val">${deg}</span>) = ?`, answer:a.cos, pool:SIN_COS_POOL});
    pool.push({tag:'Tangent', html:`tan(<span class="angle-val">${deg}</span>) = ?`, answer:a.tan, pool:TAN_POOL});
    if(a.deg!==0){
      pool.push({tag:'Sine',   html:`sin(<span class="angle-val">${rad}</span>) = ?`, answer:a.sin, pool:SIN_COS_POOL});
      pool.push({tag:'Cosine', html:`cos(<span class="angle-val">${rad}</span>) = ?`, answer:a.cos, pool:SIN_COS_POOL});
    }
  }
  return pool;
}

function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
function getChoices(ans,pool,n=4){
  return shuffle([ans,...shuffle(pool.filter(p=>p!==ans)).slice(0,n-1)]);
}

// ================================================================
//  PLACEHOLDER SPRITES (replaced with kids' drawings in Phase III)
//  All drawn in a deliberately wobbly, 5-year-old style
// ================================================================

function heroSVG(sz=60){
  return `<svg width="${sz}" height="${Math.round(sz*1.33)}" viewBox="0 0 60 80" xmlns="http://www.w3.org/2000/svg">
    <circle cx="30" cy="12" r="10" fill="none" stroke="#1a1a2e" stroke-width="2.5"/>
    <circle cx="26" cy="11" r="1.8" fill="#1a1a2e"/>
    <circle cx="34" cy="11" r="1.8" fill="#1a1a2e"/>
    <path d="M26 16 Q30 19 34 16" stroke="#1a1a2e" stroke-width="1.6" fill="none" stroke-linecap="round"/>
    <path d="M30 22 Q29 38 31 54" stroke="#1a1a2e" stroke-width="3" fill="none" stroke-linecap="round"/>
    <path d="M30 32 Q19 36 12 46" stroke="#1a1a2e" stroke-width="2.4" fill="none" stroke-linecap="round"/>
    <path d="M30 32 Q42 30 50 40" stroke="#1a1a2e" stroke-width="2.4" fill="none" stroke-linecap="round"/>
    <path d="M50 40 Q56 32 58 19" stroke="#4a90c4" stroke-width="2.8" fill="none" stroke-linecap="round"/>
    <path d="M53 35 Q56 37 58 35" stroke="#4a90c4" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <path d="M31 54 Q23 65 18 76" stroke="#1a1a2e" stroke-width="2.4" fill="none" stroke-linecap="round"/>
    <path d="M31 54 Q38 65 44 76" stroke="#1a1a2e" stroke-width="2.4" fill="none" stroke-linecap="round"/>
  </svg>`;
}

function impSVG(color, sz=38){
  return `<svg width="${sz}" height="${Math.round(sz*1.5)}" viewBox="0 0 38 57" xmlns="http://www.w3.org/2000/svg">
    <path d="M13 10 Q9 4 6 0" stroke="${color}" stroke-width="2.2" fill="none" stroke-linecap="round"/>
    <path d="M25 10 Q29 4 32 0" stroke="${color}" stroke-width="2.2" fill="none" stroke-linecap="round"/>
    <path d="M9 17 Q8 8 19 7 Q30 7 29 17 Q30 26 19 26 Q8 26 9 17Z" fill="none" stroke="${color}" stroke-width="2.3"/>
    <circle cx="14" cy="16" r="2" fill="${color}"/>
    <circle cx="24" cy="16" r="2" fill="${color}"/>
    <path d="M12 12 Q15 10 17 12" stroke="${color}" stroke-width="1.4" fill="none"/>
    <path d="M21 12 Q24 10 26 12" stroke="${color}" stroke-width="1.4" fill="none"/>
    <path d="M14 22 Q19 26 24 22" stroke="${color}" stroke-width="1.4" fill="none"/>
    <line x1="17" y1="22" x2="16" y2="26" stroke="${color}" stroke-width="1.4" stroke-linecap="round"/>
    <line x1="21" y1="22" x2="22" y2="26" stroke="${color}" stroke-width="1.4" stroke-linecap="round"/>
    <path d="M19 26 Q18 35 19 43" stroke="${color}" stroke-width="3.2" fill="none" stroke-linecap="round"/>
    <path d="M19 32 Q9 34 5 40" stroke="${color}" stroke-width="2.2" fill="none" stroke-linecap="round"/>
    <path d="M5 40 Q2 37 1 35" stroke="${color}" stroke-width="1.4" fill="none" stroke-linecap="round"/>
    <path d="M5 40 Q2 42 3 44" stroke="${color}" stroke-width="1.4" fill="none" stroke-linecap="round"/>
    <path d="M19 32 Q29 30 33 36" stroke="${color}" stroke-width="2.2" fill="none" stroke-linecap="round"/>
    <path d="M33 36 Q36 34 37 32" stroke="${color}" stroke-width="1.4" fill="none" stroke-linecap="round"/>
    <path d="M33 36 Q36 38 35 40" stroke="${color}" stroke-width="1.4" fill="none" stroke-linecap="round"/>
    <path d="M19 43 Q13 49 11 55" stroke="${color}" stroke-width="2.2" fill="none" stroke-linecap="round"/>
    <path d="M19 43 Q25 49 27 55" stroke="${color}" stroke-width="2.2" fill="none" stroke-linecap="round"/>
    <path d="M19 40 Q26 44 28 51 Q29 55 25 53" stroke="${color}" stroke-width="1.4" fill="none" stroke-linecap="round"/>
  </svg>`;
}

function dragonSVG(sz=82){
  const c='#c0392b';
  return `<svg width="${sz}" height="${Math.round(sz*1.1)}" viewBox="0 0 82 90" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="41" cy="58" rx="26" ry="20" fill="none" stroke="${c}" stroke-width="2.8"/>
    <path d="M30 40 Q28 26 36 17" stroke="${c}" stroke-width="3.2" fill="none" stroke-linecap="round"/>
    <path d="M27 15 Q32 6 46 8 Q58 9 56 21 Q54 29 41 29 Q28 29 27 15Z" fill="none" stroke="${c}" stroke-width="2.5"/>
    <path d="M54 17 Q62 15 64 20 Q62 25 54 22" fill="none" stroke="${c}" stroke-width="1.8"/>
    <text x="56" y="21" font-size="9">üî•</text>
    <circle cx="46" cy="15" r="2.8" fill="${c}"/>
    <circle cx="47" cy="14" r="1" fill="white"/>
    <path d="M34 27 L32 34 L36 27" stroke="${c}" stroke-width="1.5" fill="none" stroke-linecap="round"/>
    <path d="M42 29 L41 36 L45 29" stroke="${c}" stroke-width="1.5" fill="none" stroke-linecap="round"/>
    <path d="M22 46 Q4 33 7 20 Q16 30 22 46" fill="none" stroke="${c}" stroke-width="2.4"/>
    <path d="M60 46 Q78 33 75 20 Q66 30 60 46" fill="none" stroke="${c}" stroke-width="2.4"/>
    <path d="M21 73 Q13 82 9 89" stroke="${c}" stroke-width="2.8" fill="none" stroke-linecap="round"/>
    <path d="M9 89 Q7 85 5 83" stroke="${c}" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <path d="M61 73 Q69 82 73 89" stroke="${c}" stroke-width="2.8" fill="none" stroke-linecap="round"/>
    <path d="M73 89 Q75 85 77 83" stroke="${c}" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <path d="M67 62 Q78 66 81 76 Q79 82 75 78" stroke="${c}" stroke-width="2.2" fill="none" stroke-linecap="round"/>
  </svg>`;
}

function robotSVG(sz=70){
  const c='#2980b9';
  return `<svg width="${sz}" height="${Math.round(sz*1.3)}" viewBox="0 0 70 91" xmlns="http://www.w3.org/2000/svg">
    <line x1="35" y1="3" x2="35" y2="12" stroke="${c}" stroke-width="2.2" stroke-linecap="round"/>
    <circle cx="35" cy="2.5" r="2.5" fill="${c}"/>
    <rect x="19" y="12" width="32" height="26" rx="3" fill="none" stroke="${c}" stroke-width="2.5"/>
    <rect x="23" y="18" width="9" height="7" rx="1" fill="${c}" opacity="0.25"/>
    <rect x="38" y="18" width="9" height="7" rx="1" fill="${c}" opacity="0.25"/>
    <rect x="25" y="19" width="5" height="4" rx="1" fill="${c}"/>
    <rect x="40" y="19" width="5" height="4" rx="1" fill="${c}"/>
    <rect x="24" y="29" width="22" height="5" rx="1" fill="none" stroke="${c}" stroke-width="1.5"/>
    <line x1="30" y1="29" x2="30" y2="34" stroke="${c}" stroke-width="1" opacity="0.5"/>
    <line x1="35" y1="29" x2="35" y2="34" stroke="${c}" stroke-width="1" opacity="0.5"/>
    <line x1="40" y1="29" x2="40" y2="34" stroke="${c}" stroke-width="1" opacity="0.5"/>
    <rect x="15" y="40" width="40" height="28" rx="3" fill="none" stroke="${c}" stroke-width="2.5"/>
    <circle cx="28" cy="52" r="4.5" fill="none" stroke="${c}" stroke-width="1.5"/>
    <circle cx="28" cy="52" r="1.8" fill="${c}"/>
    <rect x="36" y="48" width="12" height="7" rx="2" fill="none" stroke="${c}" stroke-width="1.5"/>
    <line x1="39" y1="51.5" x2="45" y2="51.5" stroke="${c}" stroke-width="1.5"/>
    <rect x="3"  y="42" width="10" height="22" rx="4" fill="none" stroke="${c}" stroke-width="2.2"/>
    <line x1="3" y1="54" x2="-1" y2="54" stroke="#00d4ff" stroke-width="2.5" stroke-linecap="round"/>
    <circle cx="-1" cy="54" r="2.5" fill="#00d4ff" opacity="0.9"/>
    <rect x="57" y="42" width="10" height="22" rx="4" fill="none" stroke="${c}" stroke-width="2.2"/>
    <rect x="20" y="68" width="11" height="17" rx="3" fill="none" stroke="${c}" stroke-width="2.2"/>
    <rect x="39" y="68" width="11" height="17" rx="3" fill="none" stroke="${c}" stroke-width="2.2"/>
    <rect x="16" y="82" width="17" height="6" rx="2" fill="none" stroke="${c}" stroke-width="1.8"/>
    <rect x="37" y="82" width="17" height="6" rx="2" fill="none" stroke="${c}" stroke-width="1.8"/>
  </svg>`;
}

function bloodGurglerSVG(sz=82){
  const c='#6c3483';
  return `<svg width="${sz}" height="${Math.round(sz*1.1)}" viewBox="0 0 82 90" xmlns="http://www.w3.org/2000/svg">
    <path d="M10 42 Q8 16 28 9 Q46 3 64 13 Q78 22 76 44 Q74 68 56 74 Q38 80 22 70 Q8 60 10 42Z" fill="none" stroke="${c}" stroke-width="2.8"/>
    <ellipse cx="41" cy="38" rx="16" ry="15" fill="none" stroke="${c}" stroke-width="2.3"/>
    <circle cx="41" cy="38" r="9" fill="none" stroke="${c}" stroke-width="1.8"/>
    <circle cx="41" cy="38" r="5" fill="${c}" opacity="0.65"/>
    <circle cx="43.5" cy="35.5" r="1.8" fill="white"/>
    <path d="M25 34 Q30 36 32 38" stroke="${c}" stroke-width="0.9" fill="none" opacity="0.45"/>
    <path d="M25 42 Q30 40 32 38" stroke="${c}" stroke-width="0.9" fill="none" opacity="0.45"/>
    <path d="M57 34 Q52 36 50 38" stroke="${c}" stroke-width="0.9" fill="none" opacity="0.45"/>
    <circle cx="20" cy="26" r="5.5" fill="none" stroke="${c}" stroke-width="1.8"/>
    <circle cx="20" cy="26" r="2.8" fill="${c}" opacity="0.55"/>
    <circle cx="62" cy="22" r="4.5" fill="none" stroke="${c}" stroke-width="1.8"/>
    <circle cx="62" cy="22" r="2.2" fill="${c}" opacity="0.55"/>
    <path d="M26 62 Q41 70 56 62" stroke="${c}" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <line x1="33" y1="63" x2="32" y2="70" stroke="${c}" stroke-width="1.4" stroke-linecap="round"/>
    <line x1="41" y1="66" x2="41" y2="74" stroke="${c}" stroke-width="1.4" stroke-linecap="round"/>
    <line x1="49" y1="63" x2="50" y2="70" stroke="${c}" stroke-width="1.4" stroke-linecap="round"/>
    <path d="M14 54 Q3 60 1 70 Q5 78 9 72" stroke="${c}" stroke-width="2.3" fill="none" stroke-linecap="round"/>
    <path d="M18 66 Q9 76 7 88 Q13 94 15 86" stroke="${c}" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <path d="M68 54 Q79 58 80 70 Q76 78 72 72" stroke="${c}" stroke-width="2.3" fill="none" stroke-linecap="round"/>
    <path d="M64 66 Q73 74 74 88 Q68 94 66 86" stroke="${c}" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <path d="M38 76 Q36 86 34 90" stroke="${c}" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <path d="M28 5 Q24 0 20 3" stroke="${c}" stroke-width="1.4" fill="none" stroke-linecap="round" opacity="0.35"/>
    <path d="M54 3 Q58 -2 62 1" stroke="${c}" stroke-width="1.4" fill="none" stroke-linecap="round" opacity="0.35"/>
  </svg>`;
}

// ================================================================
//  BOSS DEFINITIONS
// ================================================================
function streakDmg(s){ return s>=5?3:s>=3?2:1; }

const BOSSES=[
  {
    id:'imps', name:'The Three Imps', isImps:true,
    imps:[
      {name:'Imp I',   color:'#c0392b', maxHp:4, hp:4},
      {name:'Imp II',  color:'#8e44ad', maxHp:4, hp:4},
      {name:'Imp III', color:'#e67e22', maxHp:4, hp:4},
    ],
    playerDamage:()=>Math.max(1, BOSSES[0].imps.filter(i=>i.hp>0).length),
    gold:10,
    defeatMsg:"The three imps shriek and explode in a puff of purple smoke. They were not ready for your math.",
  },
  {
    id:'dragon', name:'Ignarath the Dragon', isImps:false,
    maxHp:15, hp:15, playerDamage:()=>1,
    getSvg:()=>dragonSVG(76),
    gold:25,
    defeatMsg:'The dragon crashes to earth. Its fire goes cold. Turns out square roots are its one weakness.',
  },
  {
    id:'robot', name:'Unit-9', isImps:false,
    maxHp:20, hp:20, playerDamage:()=>1,
    getSvg:()=>robotSVG(64),
    gold:50,
    defeatMsg:'CRITICAL ERROR: TRIG OVERFLOW. Unit-9 shuts down permanently. Its last words were "undefined".',
  },
  {
    id:'bloodgurgler', name:'The Blood Gurgler', isImps:false,
    maxHp:30, hp:30, playerDamage:()=>2,
    getSvg:()=>bloodGurglerSVG(76),
    gold:100,
    defeatMsg:'*gurgle*... *gurgle*... The Blood Gurgler gurgles its last gurgle. The dungeon is silent. You are the master of the unit circle.',
  },
];

const PLAYER_MAX_HP=20;

// ================================================================
//  SCREEN MANAGEMENT
// ================================================================
const ALL_SCREENS=['screen-title','screen-battle','screen-victory','screen-gameover','screen-win'];
function setScreen(id){
  ALL_SCREENS.forEach(s=>{const e=document.getElementById(s);e.style.display='none';e.classList.remove('screen-active');});
  const e=document.getElementById(id);e.style.display='block';
  requestAnimationFrame(()=>e.classList.add('screen-active'));
}
function showTitle(){ clearAllTimers(); setScreen('screen-title'); }

// ================================================================
//  GAME STATE
// ================================================================
let playerHp,gold,streak,currentBossIdx,questionPool,currentQ,busy,qTimerInterval;

function clearAllTimers(){ clearInterval(qTimerInterval); }

function resetBosses(){
  BOSSES[0].imps.forEach(i=>{i.hp=i.maxHp;});
  BOSSES.slice(1).forEach(b=>{b.hp=b.maxHp;});
}

function startGame(){
  clearAllTimers();
  playerHp=PLAYER_MAX_HP; gold=0; streak=0; currentBossIdx=0;
  resetBosses();
  questionPool=shuffle(buildQuestionPool());
  startBattle();
}

// ================================================================
//  BOSS PROGRESS PIPS
// ================================================================
function renderPips(){
  const emojis=['üëπ','üêâ','ü§ñ','üíÄ'];
  document.getElementById('boss-progress').innerHTML=
    BOSSES.map((b,i)=>`<div class="boss-pip ${i<currentBossIdx?'defeated':i===currentBossIdx?'current':''}" title="${b.name}">${emojis[i]}</div>`).join('');
}

// ================================================================
//  BATTLEFIELD
// ================================================================
function renderBattlefield(){
  const boss=BOSSES[currentBossIdx];

  const playerHtml=`
    <div class="combatant" id="combatant-player">
      <div class="combatant-name">Hero</div>
      <div class="combatant-sprite">${heroSVG(58)}</div>
    </div>`;

  const vsHtml=`<div class="vs-text">VS</div>`;

  let bossHtml='';
  if(boss.isImps){
    const parts=boss.imps.map((imp,i)=>{
      const pct=Math.max(0,(imp.hp/imp.maxHp)*100);
      return `<div class="imp-unit${imp.hp<=0?' dead':''}" id="imp-${i}">
        ${impSVG(imp.color,36)}
        <div class="imp-hp-wrap"><div class="imp-hp-bar" id="imp-hp-${i}" style="width:${pct}%"></div></div>
        <span class="imp-label">${imp.name}</span>
      </div>`;
    }).join('');
    const alive=boss.imps.filter(i=>i.hp>0).length;
    bossHtml=`
      <div class="combatant" style="flex:1.5" id="combatant-boss">
        <div class="combatant-name">${boss.name}</div>
        <div class="imp-row">${parts}</div>
        <div style="font-family:'Patrick Hand',cursive;font-size:0.72rem;color:var(--blue-mid);margin-top:4px;text-align:center;" id="imp-alive-label">${alive} alive ‚Äî ${alive} damage per wrong answer</div>
      </div>`;
  } else {
    const bPct=Math.max(0,(boss.hp/boss.maxHp)*100);
    bossHtml=`
      <div class="combatant" id="combatant-boss">
        <div class="combatant-name">${boss.name}</div>
        <div class="combatant-sprite">${boss.getSvg()}</div>
        <div class="combatant-hp-row">
          <span class="combatant-hp-label" id="boss-hp-label">HP ${boss.hp}</span>
          <div class="hp-bar-wrap" style="flex:1"><div class="hp-bar boss" id="boss-hp-bar" style="width:${bPct}%"></div></div>
        </div>
      </div>`;
  }

  document.getElementById('battlefield').innerHTML=playerHtml+vsHtml+bossHtml;
}

function updatePlayerHpBar(){
  const pct=Math.max(0,(playerHp/PLAYER_MAX_HP)*100);
  const color=pct>50?'var(--green-hp)':pct>25?'var(--yellow-hp)':'var(--red-dmg)';
  const bar=document.getElementById('player-hp-bar');
  if(bar){bar.style.width=pct+'%';bar.style.background=color;}
  document.getElementById('player-hp-val').textContent=Math.max(0,playerHp);
}

function updateBossHpBar(){
  const boss=BOSSES[currentBossIdx];
  if(boss.isImps){
    boss.imps.forEach((imp,i)=>{
      const bar=document.getElementById(`imp-hp-${i}`);
      const unit=document.getElementById(`imp-${i}`);
      if(bar)bar.style.width=Math.max(0,(imp.hp/imp.maxHp)*100)+'%';
      if(unit)unit.classList.toggle('dead',imp.hp<=0);
    });
    const alive=boss.imps.filter(i=>i.hp>0).length;
    const lbl=document.getElementById('imp-alive-label');
    if(lbl)lbl.textContent=`${alive} alive ‚Äî ${alive} damage per wrong answer`;
  } else {
    const pct=Math.max(0,(boss.hp/boss.maxHp)*100);
    const bar=document.getElementById('boss-hp-bar');
    const lbl=document.getElementById('boss-hp-label');
    if(bar)bar.style.width=pct+'%';
    if(lbl)lbl.textContent='HP '+Math.max(0,boss.hp);
  }
}

function updateHud(){
  document.getElementById('player-hp-val').textContent=Math.max(0,playerHp);
  document.getElementById('streak-display').textContent=streak;
  document.getElementById('gold-display').textContent=gold;
  updatePlayerHpBar();
}

// ================================================================
//  BATTLE FLOW
// ================================================================
function startBattle(){
  setScreen('screen-battle');
  renderPips();
  renderBattlefield();
  updateHud();
  document.getElementById('flame-row').classList.remove('active');
  nextQuestion();
}

// ================================================================
//  QUESTION TIMER
// ================================================================
function startQTimer(){
  clearInterval(qTimerInterval);
  let timeLeft=15;
  const bar=document.getElementById('q-timer-bar');
  bar.style.width='100%'; bar.className='q-timer-bar';
  qTimerInterval=setInterval(()=>{
    timeLeft--;
    bar.style.width=(timeLeft/15*100)+'%';
    if(timeLeft<=5)bar.className='q-timer-bar urgent';
    if(timeLeft<=0){clearInterval(qTimerInterval);handleTimeout();}
  },1000);
}

function handleTimeout(){
  if(busy)return; busy=true;
  document.querySelectorAll('.choice-btn').forEach(b=>{
    b.disabled=true;
    if(b.textContent===currentQ.answer)b.classList.add('reveal');
  });
  const dmg=BOSSES[currentBossIdx].playerDamage();
  streak=0; playerHp-=dmg; updateHud(); updateFlames();
  document.getElementById('battle-feedback').textContent=`‚è± Time's up! ‚àí${dmg} HP  ‚Üí  ${currentQ.answer}`;
  flashEl('combatant-player');
  setTimeout(checkGameState,1600);
}

// ================================================================
//  NEXT QUESTION
// ================================================================
function nextQuestion(){
  if(questionPool.length===0)questionPool=shuffle(buildQuestionPool());
  currentQ=questionPool.pop(); busy=false;
  document.getElementById('q-type-tag').textContent=currentQ.tag;
  document.getElementById('q-text').innerHTML=currentQ.html;
  document.getElementById('battle-feedback').textContent='';
  const choices=getChoices(currentQ.answer,currentQ.pool,4);
  const grid=document.getElementById('choices-grid');
  grid.innerHTML=''; grid.style.pointerEvents='none';
  setTimeout(()=>{grid.style.pointerEvents='';},120);
  choices.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='choice-btn'; btn.textContent=c;
    btn.onclick=()=>handleAnswer(c,btn);
    grid.appendChild(btn);
  });
  if(document.activeElement)document.activeElement.blur();
  startQTimer();
}

// ================================================================
//  ANSWER HANDLING
// ================================================================
function handleAnswer(choice,btn){
  if(busy)return; busy=true; clearInterval(qTimerInterval);
  document.querySelectorAll('.choice-btn').forEach(b=>b.disabled=true);
  if(choice===currentQ.answer){
    btn.classList.add('correct'); streak++;
    const dmg=streakDmg(streak);
    dealDamageToBoss(dmg); updateHud();
    document.getElementById('streak-display').textContent=streak;
    updateFlames();
    const msg=streak>=5?`üî• x${streak} STREAK! ‚àí${dmg} boss HP`:
              streak>=3?`‚ö° x${streak} streak! ‚àí${dmg} boss HP`:
                        `‚úì Correct! ‚àí${dmg} boss HP`;
    document.getElementById('battle-feedback').textContent=msg;
    setTimeout(checkGameState,700);
  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.choice-btn').forEach(b=>{if(b.textContent===currentQ.answer)b.classList.add('reveal');});
    const dmg=BOSSES[currentBossIdx].playerDamage();
    const old=streak; streak=0; playerHp-=dmg;
    updateHud(); updateFlames();
    document.getElementById('battle-feedback').textContent=
      (old>=2?`‚úó Streak lost! ‚àí${dmg} HP`:`‚úó Wrong! ‚àí${dmg} HP`)+`  ‚Üí  ${currentQ.answer}`;
    flashEl('combatant-player');
    setTimeout(checkGameState,1600);
  }
}

function dealDamageToBoss(dmg){
  const boss=BOSSES[currentBossIdx];
  if(boss.isImps){
    const target=boss.imps.find(i=>i.hp>0);
    if(target){ target.hp=Math.max(0,target.hp-dmg); flashEl('imp-'+boss.imps.indexOf(target)); }
  } else {
    boss.hp=Math.max(0,boss.hp-dmg); flashEl('combatant-boss');
  }
  updateBossHpBar();
}

function flashEl(id){
  const el=document.getElementById(id); if(!el)return;
  el.classList.remove('hit-flash'); void el.offsetWidth;
  el.classList.add('hit-flash');
  setTimeout(()=>el.classList.remove('hit-flash'),350);
}

// ================================================================
//  GAME STATE CHECKS
// ================================================================
function checkGameState(){
  if(playerHp<=0){triggerGameOver();return;}
  const boss=BOSSES[currentBossIdx];
  const dead=boss.isImps?boss.imps.every(i=>i.hp<=0):boss.hp<=0;
  if(dead){triggerBossVictory();return;}
  nextQuestion();
}

function triggerBossVictory(){
  clearAllTimers();
  const boss=BOSSES[currentBossIdx];
  gold+=boss.gold;
  const isLast=currentBossIdx===BOSSES.length-1;
  document.getElementById('victory-title').textContent=isLast?'DUNGEON CLEARED!!':boss.name.toUpperCase()+' DEFEATED!';
  document.getElementById('victory-msg').textContent=boss.defeatMsg;
  document.getElementById('gold-earned-display').textContent=`+${boss.gold} üí∞ Gold`;
  document.getElementById('gold-total-display').textContent=`Total: ${gold} gold`;
  const sp=document.getElementById('victory-sprite');
  sp.innerHTML=boss.isImps?boss.imps.map(i=>impSVG(i.color,40)).join(''):boss.getSvg();
  const btn=document.getElementById('next-boss-btn');
  if(isLast){btn.textContent='SEE RESULTS';btn.onclick=triggerFinalWin;}
  else      {btn.textContent='ONWARD!';    btn.onclick=advanceToNextBoss;}
  setScreen('screen-victory');
}

function advanceToNextBoss(){
  currentBossIdx++; streak=0;
  questionPool=shuffle(buildQuestionPool());
  startBattle();
}

function triggerGameOver(){
  clearAllTimers();
  const boss=BOSSES[currentBossIdx];
  document.getElementById('gameover-msg').textContent=`You fell before ${boss.name}. The dungeon claims another soul.`;
  document.getElementById('gameover-gold-display').textContent=`${gold} üí∞`;
  const sp=document.getElementById('gameover-sprite');
  sp.innerHTML=boss.isImps?impSVG(boss.imps[0].color,52):boss.getSvg();
  setScreen('screen-gameover');
}

function triggerFinalWin(){
  clearAllTimers();
  document.getElementById('win-gold-display').textContent=gold;
  document.getElementById('win-msg').textContent='All four bosses destroyed. Save your gold ‚Äî Phase III is coming.';
  setScreen('screen-win');
}

// ================================================================
//  FLAMES ‚Äî identical to Phase 1
// ================================================================
(function buildFlames(){
  const row=document.getElementById('flame-row');
  for(let i=0;i<18;i++){
    const span=document.createElement('span');
    span.className='flame'; span.textContent='üî•';
    const dur=(0.6+Math.random()*0.8).toFixed(2);
    const del=(Math.random()*1.0).toFixed(2);
    const a=(1.3+Math.random()*0.4).toFixed(1);
    const b=(1.8+Math.random()*0.4).toFixed(1);
    const c=(1.1+Math.random()*0.4).toFixed(1);
    span.style.cssText=`font-size:${a}rem;--fs-a:${a}rem;--fs-b:${b}rem;--fs-c:${c}rem;animation:flameSize ${dur}s ${del}s ease-in-out infinite;`;
    row.appendChild(span);
  }
})();

function updateFlames(){
  document.getElementById('flame-row').classList.toggle('active',streak>=5);
}
</script>
</body>
</html>
