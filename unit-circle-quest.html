<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unit Circle Quest</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --parchment: #f2e8d0;
    --parchment-dark: #e0cfaa;
    --ink: #2c1810;
    --ink-light: #4a2f20;
    --crimson: #8b1a1a;
    --gold: #c9a227;
    --gold-light: #f0c84a;
    --stone: #7a6a55;
    --stone-light: #a08c70;
    --green-correct: #2d6a2d;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background-color: #1a1008;
    background-image:
      radial-gradient(ellipse at 50% 0%, #3d1f08 0%, transparent 70%),
      repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.05) 2px, rgba(0,0,0,0.05) 4px);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Crimson Text', Georgia, serif;
    padding: 20px;
  }

  .game-container { width: 100%; max-width: 720px; }

  .frame {
    background: var(--parchment);
    background-image:
      radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.3) 0%, transparent 60%),
      radial-gradient(ellipse at 70% 80%, rgba(180,140,80,0.2) 0%, transparent 50%);
    border: 3px solid var(--gold);
    border-radius: 4px;
    box-shadow:
      0 0 0 6px var(--ink),
      0 0 0 9px var(--gold),
      0 0 0 12px var(--ink),
      0 20px 60px rgba(0,0,0,0.8),
      inset 0 0 40px rgba(180,140,60,0.1);
    padding: 40px 48px;
    position: relative;
  }

  .frame::before, .frame::after {
    content: '‚ú¶'; position: absolute; color: var(--gold); font-size: 20px; line-height: 1;
  }
  .frame::before { top: 12px; left: 14px; }
  .frame::after  { bottom: 12px; right: 14px; }
  .corner-tr { position: absolute; top: 12px; right: 14px; color: var(--gold); font-size: 20px; }
  .corner-bl { position: absolute; bottom: 12px; left: 14px; color: var(--gold); font-size: 20px; }
  .version-tag {
    position: absolute; bottom: 11px; right: 36px;
    font-family: 'Cinzel', serif; font-size: 0.6rem;
    color: var(--stone-light); letter-spacing: 2px; opacity: 0.6;
  }

  /* ===== SHARED TYPOGRAPHY ===== */
  .game-title {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: clamp(2rem, 6vw, 3.2rem);
    color: var(--crimson);
    text-shadow: 2px 2px 0 var(--gold), 3px 3px 0 var(--ink);
    letter-spacing: 3px;
    line-height: 1.1;
    text-align: center;
  }
  .game-subtitle {
    font-family: 'Cinzel', serif;
    font-size: clamp(0.75rem, 1.8vw, 0.95rem);
    color: var(--stone);
    letter-spacing: 6px;
    text-transform: uppercase;
    text-align: center;
    margin-top: 4px;
    margin-bottom: 20px;
  }
  .divider {
    border: none;
    border-top: 1px solid var(--stone-light);
    margin: 20px auto;
    width: 80%;
    position: relative;
  }
  .divider::after {
    content: '‚öî';
    position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
    background: var(--parchment); padding: 0 8px;
    color: var(--gold); font-size: 16px;
  }

  /* ===== JACKALOPE ===== */
  .jackalope-container {
    margin: 0 auto 4px; margin-left: calc(50% - 178px); width: 287px; height: 287px;
    display: block; filter: drop-shadow(2px 4px 8px rgba(0,0,0,0.25));
    object-fit: contain;
  }

  /* ===== TITLE SCREEN ===== */
  #screen-title { text-align: center; }
  .intro-text {
    font-size: 1.3rem; color: var(--ink-light);
    line-height: 1.7; margin: 12px 0 20px; font-style: italic;
  }
  .rules-box {
    background: rgba(44,24,16,0.05);
    border: 1px solid var(--parchment-dark);
    border-radius: 2px; padding: 16px 20px; margin-bottom: 20px; text-align: left;
  }
  .rules-box p { color: var(--ink-light); font-size: 1.15rem; margin-bottom: 6px; line-height: 1.5; }
  .rules-box p:last-child { margin-bottom: 0; }
  .rules-box strong { color: var(--crimson); font-weight: 600; }

  .title-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

  /* ===== BUTTONS ===== */
  .btn-primary {
    display: inline-block;
    background: linear-gradient(180deg, #a52020 0%, #6b1212 100%);
    color: var(--parchment); border: 2px solid var(--gold);
    padding: 14px 40px; font-family: 'Cinzel', serif;
    font-size: 1.1rem; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
    transition: all 0.15s; text-transform: uppercase;
  }
  .btn-primary:hover {
    background: linear-gradient(180deg, #c52828 0%, #8b1a1a 100%);
    box-shadow: 0 6px 20px rgba(139,26,26,0.5); transform: translateY(-1px);
  }
  .btn-primary:active { transform: translateY(1px); }

  .btn-secondary {
    display: inline-block;
    background: linear-gradient(180deg, #8a7450 0%, #5a4a30 100%);
    color: var(--parchment); border: 2px solid var(--stone-light);
    padding: 14px 28px; font-family: 'Cinzel', serif;
    font-size: 0.95rem; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.15s; text-transform: uppercase;
  }
  .btn-secondary:hover {
    background: linear-gradient(180deg, #a08860 0%, #6a5a40 100%);
    transform: translateY(-1px);
  }

  /* ===== GAME HUD ===== */
  #screen-game { display: none; padding-bottom: 64px; }
  .hud { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .hud-stat { text-align: center; }
  .hud-label {
    font-family: 'Cinzel', serif; font-size: 0.8rem; letter-spacing: 3px;
    color: var(--stone); text-transform: uppercase; display: block; margin-bottom: 2px;
  }
  .hud-value { font-family: 'Cinzel', serif; font-size: 1.8rem; font-weight: 900; color: var(--crimson); line-height: 1; }
  .timer-bar-wrap {
    flex: 1; margin: 0 24px; height: 12px;
    background: rgba(44,24,16,0.12); border: 1px solid var(--stone-light);
    border-radius: 2px; overflow: hidden;
  }
  .timer-bar {
    height: 100%; background: linear-gradient(90deg, var(--crimson), var(--gold));
    width: 100%; transition: width 1s linear; border-radius: 2px;
  }
  .timer-bar.warning { animation: pulse 0.5s infinite alternate; }
  @keyframes pulse { from { opacity: 1; } to { opacity: 0.5; } }

  /* ===== QUESTION ===== */
  .question-area {
    text-align: center; margin-bottom: 28px; min-height: 80px;
    display: flex; flex-direction: column; justify-content: center;
  }
  .question-type-tag {
    font-family: 'Cinzel', serif; font-size: 0.85rem; letter-spacing: 4px;
    color: var(--stone); text-transform: uppercase; margin-bottom: 8px;
  }
  .question-text {
    font-family: 'Cinzel', serif; font-size: clamp(1.2rem, 4vw, 1.7rem);
    font-weight: 700; color: var(--ink); line-height: 1.3;
  }
  .angle-val { color: var(--crimson); }

  /* ===== CHOICES ===== */
  .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .choice-btn {
    background: rgba(44,24,16,0.04); border: 2px solid var(--stone-light);
    border-radius: 2px; padding: 16px 12px; font-family: 'Crimson Text', serif;
    font-size: 1.2rem; font-weight: 600; color: var(--ink);
    cursor: pointer; transition: all 0.12s; min-height: 60px;
  }
  .choice-btn:hover:not(:disabled) {
    background: rgba(201,162,39,0.1); border-color: var(--gold);
    transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.12);
  }
  .choice-btn.correct {
    background: rgba(45,106,45,0.15); border-color: var(--green-correct);
    color: var(--green-correct); animation: correctPop 0.3s ease;
  }
  .choice-btn.wrong {
    background: rgba(139,26,26,0.1); border-color: var(--crimson);
    color: var(--crimson); animation: wrongShake 0.3s ease;
  }
  .choice-btn.reveal {
    background: rgba(45,106,45,0.15); border-color: var(--green-correct); color: var(--green-correct);
  }
  .choice-btn:disabled { cursor: not-allowed; }
  @keyframes correctPop { 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }
  @keyframes wrongShake { 0%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} 100%{transform:translateX(0)} }

  .feedback-msg {
    text-align: center; min-height: 26px; font-family: 'Cinzel', serif;
    font-size: 1rem; font-weight: 700; letter-spacing: 2px; color: var(--stone);
    margin-bottom: 10px;
  }

  /* ===== FLAMES ===== */
  .flame-row {
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 52px; pointer-events: none;
    display: flex; align-items: flex-end; justify-content: center;
    padding-bottom: 2px; opacity: 0;
    transition: opacity 0.7s ease;
    overflow: hidden; border-radius: 0 0 4px 4px;
  }
  .flame-row.active { opacity: 1; }

  .flame {
    display: inline-block;
    line-height: 1;
    transform-origin: bottom center;
  }

  @keyframes flameSize {
    0%   { font-size: var(--fs-a); }
    25%  { font-size: var(--fs-b); }
    50%  { font-size: var(--fs-c); }
    75%  { font-size: var(--fs-b); }
    100% { font-size: var(--fs-a); }
  }

  /* ===== END SCREEN ===== */
  #screen-end { display: none; text-align: center; }
  .score-label {
    font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 5px;
    color: var(--stone); text-transform: uppercase; display: block; margin: 20px 0 6px;
  }
  .score-big {
    font-family: 'Cinzel', serif; font-size: clamp(4rem, 15vw, 7rem); font-weight: 900;
    color: var(--crimson); text-shadow: 3px 3px 0 var(--gold), 5px 5px 0 var(--ink); line-height: 1;
  }
  .score-total { font-family: 'Cinzel', serif; font-size: 1rem; color: var(--stone); margin-top: 4px; margin-bottom: 16px; }
  .rank-text { font-family: 'Cinzel', serif; font-size: 1.2rem; font-weight: 700; color: var(--gold); margin-bottom: 10px; letter-spacing: 1px; }
  .end-message { font-size: 1.1rem; color: var(--ink-light); font-style: italic; margin-bottom: 20px; line-height: 1.6; }
  .end-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 8px; }

  /* ===== INITIALS ENTRY ===== */
  #screen-initials { display: none; text-align: center; }
  .initials-prompt {
    font-family: 'Cinzel', serif; font-size: 1rem; color: var(--ink-light);
    letter-spacing: 2px; margin: 16px 0 24px; line-height: 1.6;
  }
  .initials-prompt strong { color: var(--crimson); font-size: 1.3em; }
  .initials-row {
    display: flex; gap: 14px; justify-content: center; margin-bottom: 10px;
  }
  .initial-input {
    width: 64px; height: 80px;
    font-family: 'Cinzel', serif; font-size: 2.4rem; font-weight: 900;
    text-align: center; text-transform: uppercase;
    background: rgba(44,24,16,0.04); border: 3px solid var(--stone-light);
    border-radius: 2px; color: var(--crimson);
    outline: none; transition: border-color 0.15s;
    caret-color: var(--crimson);
  }
  .initial-input:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(201,162,39,0.2); }
  .initials-error {
    font-family: 'Cinzel', serif; font-size: 0.8rem; color: var(--crimson);
    letter-spacing: 2px; min-height: 22px; margin-bottom: 16px;
  }
  .initials-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

  /* ===== LEADERBOARD SCREEN ===== */
  #screen-leaderboard { display: none; }
  .lb-title {
    font-family: 'Cinzel', serif; font-weight: 900;
    font-size: clamp(1.4rem, 4vw, 2rem);
    color: var(--crimson);
    text-shadow: 1px 1px 0 var(--gold), 2px 2px 0 var(--ink);
    letter-spacing: 3px; text-align: center; margin-bottom: 4px;
  }
  .lb-subtitle {
    font-family: 'Cinzel', serif; font-size: 0.65rem; letter-spacing: 5px;
    color: var(--stone); text-transform: uppercase; text-align: center; margin-bottom: 16px;
  }
  .lb-table-wrap {
    border: 2px solid var(--parchment-dark);
    border-radius: 2px; overflow: hidden; margin-bottom: 20px;
  }
  .lb-header {
    display: grid; grid-template-columns: 48px 80px 1fr 70px 120px;
    background: rgba(44,24,16,0.08);
    border-bottom: 2px solid var(--parchment-dark);
    padding: 8px 12px;
  }
  .lb-header span {
    font-family: 'Cinzel', serif; font-size: 0.6rem; letter-spacing: 3px;
    color: var(--stone); text-transform: uppercase; font-weight: 700;
  }
  .lb-row {
    display: grid; grid-template-columns: 48px 80px 1fr 70px 120px;
    padding: 10px 12px; border-bottom: 1px solid rgba(160,140,112,0.25);
    align-items: center; transition: background 0.1s;
  }
  .lb-row:last-child { border-bottom: none; }
  .lb-row:hover { background: rgba(201,162,39,0.06); }
  .lb-row.new-entry { background: rgba(201,162,39,0.12); animation: newEntryGlow 1.5s ease; }
  @keyframes newEntryGlow {
    0%   { background: rgba(201,162,39,0.35); }
    100% { background: rgba(201,162,39,0.12); }
  }
  .lb-rank {
    font-family: 'Cinzel', serif; font-weight: 900; font-size: 1rem;
    color: var(--stone); text-align: center;
  }
  .lb-rank.gold   { color: #c9a227; text-shadow: 0 0 8px rgba(201,162,39,0.5); }
  .lb-rank.silver { color: #909090; }
  .lb-rank.bronze { color: #a0694a; }
  .lb-initials {
    font-family: 'Cinzel', serif; font-weight: 900; font-size: 1.3rem;
    color: var(--crimson); letter-spacing: 4px; text-align: center;
  }
  .lb-rank-title {
    font-family: 'Crimson Text', serif; font-size: 0.95rem;
    color: var(--ink-light); font-style: italic; padding: 0 8px;
  }
  .lb-score {
    font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.1rem;
    color: var(--ink); text-align: center;
  }
  .lb-date {
    font-family: 'Crimson Text', serif; font-size: 0.85rem;
    color: var(--stone); text-align: right;
  }
  .lb-empty {
    text-align: center; padding: 32px;
    font-family: 'Crimson Text', serif; font-style: italic;
    color: var(--stone); font-size: 1.05rem;
  }
  .lb-loading {
    text-align: center; padding: 32px;
    font-family: 'Cinzel', serif; font-size: 0.75rem;
    letter-spacing: 3px; color: var(--stone);
  }
  .lb-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

  /* ===== LORD OF HYPERSPHERES EASTER EGG ===== */
  #hypersphere-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 999;
    background: #000;
    flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center;
    overflow: hidden;
  }
  #hypersphere-overlay.active { display: flex; }

  .hs-title {
    font-family: 'Cinzel', serif; font-weight: 900;
    font-size: clamp(1.8rem, 6vw, 3.5rem);
    color: #fff;
    text-shadow: 0 0 20px #ff6600, 0 0 40px #ff3300, 0 0 80px #ff0000;
    letter-spacing: 4px; z-index: 2; position: relative;
    animation: hsPulse 1s ease-in-out infinite alternate;
  }
  .hs-subtitle {
    font-family: 'Crimson Text', serif; font-style: italic;
    font-size: clamp(1rem, 2.5vw, 1.4rem);
    color: #ffaa44; margin-top: 16px; z-index: 2; position: relative;
    opacity: 0; animation: hsFadeIn 1s 1s forwards;
  }
  @keyframes hsPulse {
    from { text-shadow: 0 0 20px #ff6600, 0 0 40px #ff3300, 0 0 80px #ff0000; }
    to   { text-shadow: 0 0 40px #ffaa00, 0 0 80px #ff6600, 0 0 120px #ff2200; }
  }
  @keyframes hsFadeIn { to { opacity: 1; } }

  .hs-flames {
    position: absolute; inset: 0; z-index: 1;
    pointer-events: none;
  }
  .hs-flame-span {
    position: absolute; bottom: -10px;
    animation: hsRise linear forwards;
    opacity: 0.9;
  }
  @keyframes hsRise {
    0%   { transform: translateY(0) scale(1);   opacity: 0.9; }
    80%  { opacity: 0.8; }
    100% { transform: translateY(-110vh) scale(0.5); opacity: 0; }
  }

  .hs-continue {
    font-family: 'Cinzel', serif; font-size: 0.75rem;
    letter-spacing: 4px; color: rgba(255,200,100,0.6);
    position: absolute; bottom: 32px; z-index: 2;
    opacity: 0; animation: hsFadeIn 0.8s 5.5s forwards;
    cursor: pointer; text-transform: uppercase;
  }

  /* ===== DIFFICULTY POPUP ===== */
  #screen-difficulty { display: none; text-align: center; }
  .diff-intro {
    font-family: 'Crimson Text', serif; font-size: 1.1rem; color: var(--ink-light);
    font-style: italic; margin: 8px 0 24px; line-height: 1.6;
  }
  .diff-cards { display: flex; flex-direction: column; gap: 14px; margin-bottom: 24px; }
  .diff-card {
    border: 2px solid var(--stone-light); border-radius: 2px;
    padding: 18px 24px; cursor: pointer; text-align: left;
    background: rgba(44,24,16,0.03); transition: all 0.15s;
    display: flex; align-items: center; gap: 20px;
  }
  .diff-card:hover {
    border-color: var(--gold); background: rgba(201,162,39,0.07);
    transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }
  .diff-card.selected {
    border-color: var(--crimson); background: rgba(139,26,26,0.07);
  }
  .diff-icon { font-size: 2rem; line-height: 1; flex-shrink: 0; }
  .diff-text { flex: 1; min-width: 0; padding-right: 8px; }
  .diff-label {
    font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.1rem;
    color: var(--crimson); letter-spacing: 2px; text-transform: uppercase;
    display: block; margin-bottom: 6px;
  }
  .diff-desc {
    font-family: 'Crimson Text', serif; font-size: 1.05rem;
    color: var(--ink-light); line-height: 1.55;
  }
  .diff-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

  /* ===== LEADERBOARD ‚Äî RESPONSIVE ===== */
  #screen-leaderboard { display: none; }
  .lb-title {
    font-family: 'Cinzel', serif; font-weight: 900;
    font-size: clamp(1.4rem, 4vw, 2rem);
    color: var(--crimson);
    text-shadow: 1px 1px 0 var(--gold), 2px 2px 0 var(--ink);
    letter-spacing: 3px; text-align: center; margin-bottom: 4px;
  }
  .lb-subtitle {
    font-family: 'Cinzel', serif; font-size: 0.65rem; letter-spacing: 5px;
    color: var(--stone); text-transform: uppercase; text-align: center; margin-bottom: 16px;
  }

  /* Three columns on wide screens, stacked on mobile */
  .lb-columns {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px; margin-bottom: 20px;
  }
  @media (max-width: 540px) {
    .lb-columns { grid-template-columns: 1fr; gap: 14px; }
  }

  .lb-column-wrap { border: 2px solid var(--parchment-dark); border-radius: 2px; overflow: hidden; }
  .lb-column-header {
    background: rgba(44,24,16,0.08); border-bottom: 2px solid var(--parchment-dark);
    padding: 10px 8px; text-align: center;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .lb-column-header-label {
    font-family: 'Cinzel', serif; font-size: clamp(0.75rem, 2.5vw, 0.9rem);
    letter-spacing: 3px; color: var(--stone); text-transform: uppercase; font-weight: 700;
  }
  .lb-column-header-icon { font-size: clamp(1rem, 3vw, 1.3rem); }

  .lb-col-row {
    display: grid; grid-template-columns: 32px 1fr auto;
    padding: 9px 10px; border-bottom: 1px solid rgba(160,140,112,0.25);
    align-items: center; gap: 4px;
  }
  .lb-col-row:last-child { border-bottom: none; }
  .lb-col-row:hover { background: rgba(201,162,39,0.06); }
  .lb-col-row.new-entry { background: rgba(201,162,39,0.12); animation: newEntryGlow 1.5s ease; }
  @keyframes newEntryGlow {
    0%   { background: rgba(201,162,39,0.35); }
    100% { background: rgba(201,162,39,0.12); }
  }
  .lb-col-rank {
    font-family: 'Cinzel', serif; font-weight: 900;
    font-size: clamp(0.8rem, 2.5vw, 1rem);
    color: var(--stone); text-align: center;
  }
  .lb-col-rank.gold   { color: #c9a227; }
  .lb-col-rank.silver { color: #909090; }
  .lb-col-rank.bronze { color: #a0694a; }
  .lb-col-initials {
    font-family: 'Cinzel', serif; font-weight: 900;
    font-size: clamp(1rem, 3vw, 1.2rem);
    color: var(--crimson); letter-spacing: 3px;
  }
  .lb-col-score {
    font-family: 'Cinzel', serif; font-weight: 700;
    font-size: clamp(1rem, 3vw, 1.2rem);
    color: var(--ink); text-align: right; white-space: nowrap;
  }
  .lb-empty {
    text-align: center; padding: 20px 8px;
    font-family: 'Crimson Text', serif; font-style: italic;
    color: var(--stone); font-size: clamp(0.85rem, 2.5vw, 1rem); line-height: 1.4;
  }
  .lb-loading {
    text-align: center; padding: 20px 8px;
    font-family: 'Cinzel', serif; font-size: 0.65rem;
    letter-spacing: 2px; color: var(--stone);
  }
  .lb-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

  /* ===== CHILL MODE TOGGLE ===== */
  .chill-toggle-wrap {
    display: flex; align-items: center; justify-content: center;
    gap: 14px; margin: 20px 0 8px;
  }
  .chill-label {
    font-family: 'Cinzel', serif; font-size: 0.95rem; letter-spacing: 2px;
    color: var(--stone); text-transform: uppercase; cursor: pointer; user-select: none;
  }
  .chill-label span { color: var(--crimson); }
  .toggle-switch {
    position: relative; width: 56px; height: 30px; cursor: pointer;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-track {
    position: absolute; inset: 0;
    background: var(--parchment-dark); border: 2px solid var(--stone-light);
    border-radius: 30px; transition: all 0.2s;
  }
  .toggle-track::after {
    content: ''; position: absolute; left: 3px; top: 3px;
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--stone); transition: all 0.2s;
  }
  .toggle-switch input:checked + .toggle-track { background: rgba(139,26,26,0.15); border-color: var(--crimson); }
  .toggle-switch input:checked + .toggle-track::after { transform: translateX(26px); background: var(--crimson); }
  .chill-desc {
    font-family: 'Crimson Text', serif; font-size: 1.1rem; font-style: italic;
    color: var(--stone); text-align: center; margin-bottom: 16px;
  }

  /* ===== CONTINUE BUTTON (Chill Mode) ===== */
  .btn-continue {
    display: none;
    background: linear-gradient(180deg, #8a7450 0%, #5a4a30 100%);
    color: var(--parchment); border: 2px solid var(--stone-light);
    padding: 12px 36px; font-family: 'Cinzel', serif;
    font-size: 1rem; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.15s; text-transform: uppercase;
  }
  .btn-continue:hover { background: linear-gradient(180deg, #a08860 0%, #6a5a40 100%); transform: translateY(-1px); }
  .btn-continue.visible { display: block; }
  .screen-active { animation: fadeIn 0.35s ease both; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

  /* ===== CHILL TOTALS BAR ===== */
  .chill-totals-wrap { display: none; text-align: center; margin-top: 10px; }
  .chill-totals-wrap.chill-active { display: block; }
  .chill-totals {
    font-family: 'Cinzel', serif; font-size: 0.95rem; letter-spacing: 2px;
    color: var(--stone); text-transform: uppercase;
  }
  .chill-totals .t-correct { color: var(--green-correct); font-weight: 700; }
  .chill-totals .t-wrong   { color: var(--crimson); font-weight: 700; }
  .btn-totals-toggle {
    display: none; margin: 10px auto 0;
    background: none; border: 1px solid var(--stone-light);
    border-radius: 2px; padding: 5px 16px;
    font-family: 'Cinzel', serif; font-size: 0.6rem; letter-spacing: 2px;
    color: var(--stone); text-transform: uppercase; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-totals-toggle:hover { border-color: var(--gold); color: var(--ink); }
  .btn-totals-toggle.chill-active { display: inline-block; }
</style>
</head>
<body>
<div class="game-container">
  <div class="frame">
    <span class="corner-tr">‚ú¶</span>
    <span class="corner-bl">‚ú¶</span>
    <span class="version-tag">v1.0.17</span>

    <!-- ===== TITLE SCREEN ===== -->
    <div id="screen-title">
      <div class="game-title">Unit Circle</div>
      <div class="game-title" style="margin-top:2px; margin-bottom:12px;">Quest</div>
      <div class="game-subtitle">Phase I ‚Äî The Trial Begins</div>
      <hr class="divider">

      <img class="jackalope-container" src="images/character1.png" alt="Mascot">

      <div class="intro-text" style="font-size:1.5rem;">Prove your mastery.</div>

      <div class="rules-box">
        <p>‚è± <strong>60 seconds</strong> ‚Äî answer as many as you can.</p>
        <p>üéØ <strong>+1 point</strong> for your first correct answer.</p>
        <p>üî• <strong>Streak bonus</strong> ‚Äî each consecutive correct answer scores one more point than the last. Miss one and the streak resets!</p>
        <p>üèÜ Score high enough to be memorialized in the <strong>Hall of Champions</strong>!</p>
      </div>

      <div class="title-btns">
        <button class="btn-primary" onclick="showDifficulty()">Begin the Trial</button>
        <button class="btn-secondary" onclick="showLeaderboard(false)">Hall of Champions</button>
      </div>
      <div class="chill-toggle-wrap">
        <label class="toggle-switch">
          <input type="checkbox" id="chill-toggle" onchange="updateChillDesc()">
          <div class="toggle-track"></div>
        </label>
        <span class="chill-label" onclick="document.getElementById('chill-toggle').click()"><span>Chill Mode</span></span>
      </div>
      <div class="chill-desc">No timer ¬∑ No score ¬∑ Go at your own pace</div>
    </div>

    <!-- ===== GAME SCREEN ===== -->
    <div id="screen-game">
      <div class="hud">
        <div class="hud-stat">
          <span class="hud-label">Score</span>
          <span class="hud-value" id="score-display">0</span>
        </div>
        <div class="timer-bar-wrap">
          <div class="timer-bar" id="timer-bar"></div>
        </div>
        <div class="hud-stat">
          <span class="hud-label">Streak</span>
          <span class="hud-value" id="streak-display" style="color:var(--gold)">0</span>
        </div>
        <div class="hud-stat" style="margin-left:16px;">
          <span class="hud-label">Time</span>
          <span class="hud-value" id="timer-display">60</span>
        </div>
      </div>
      <div style="text-align:center; margin-bottom:8px; margin-top:-10px;">
        <span id="difficulty-badge" style="font-family:'Cinzel',serif; font-size:0.85rem; letter-spacing:3px; color:var(--stone); text-transform:uppercase;"></span>
      </div>
      <hr class="divider">
      <div class="question-area">
        <div class="question-type-tag" id="q-type-tag"></div>
        <div class="question-text" id="q-text"></div>
      </div>
      <div class="feedback-msg" id="feedback-msg"></div>
      <div class="choices-grid" id="choices-grid"></div>
      <div class="chill-totals-wrap" id="chill-totals-wrap">
        <div class="chill-totals">
          ‚ú¶ Correct: <span class="t-correct" id="tally-correct">0</span>
          &nbsp;&nbsp;‚úó Incorrect: <span class="t-wrong" id="tally-wrong">0</span>
        </div>
      </div>
      <button class="btn-totals-toggle" id="totals-toggle-btn" onclick="toggleTotals()">Show Totals</button>
      <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:12px;">
        <button class="btn-continue" id="continue-btn" onclick="nextQuestion()">Continue</button>
        <div id="chill-menu-btn-wrap" style="display:none;">
          <button class="btn-secondary" onclick="showTitle()">Main Menu</button>
        </div>
      </div>

      <!-- Flames appear at streak 5+, built dynamically by JS -->
      <div class="flame-row" id="flame-row"></div>
      <div id="restart-btn-wrap" style="text-align:center; margin-top:10px;">
        <button onclick="showDifficulty()" style="background:none; border:none; font-family:'Cinzel',serif; font-size:0.65rem; letter-spacing:2px; color:var(--stone-light); text-transform:uppercase; cursor:pointer; text-decoration:underline; text-underline-offset:3px;">Restart</button>
      </div>
    </div>

    <!-- ===== END SCREEN ===== -->
    <div id="screen-end">
      <div class="game-title" style="font-size:clamp(1.5rem,5vw,2.2rem);">Trial Complete!</div>
      <hr class="divider">
      <span class="score-label">Final Score</span>
      <div class="score-big" id="final-score">0</div>
      <div class="score-total" id="questions-answered"></div>
      <div class="rank-text" id="rank-text"></div>
      <div id="end-difficulty" style="font-family:'Cinzel',serif; font-size:0.65rem; letter-spacing:4px; color:var(--stone); text-transform:uppercase; margin-bottom:6px;"></div>
      <div class="end-message" id="end-message"></div>
      <div class="end-btns">
        <button class="btn-primary" onclick="showDifficulty()">Try Again</button>
        <button class="btn-secondary" onclick="showLeaderboard(false)">Hall of Champions</button>
        <button class="btn-secondary" onclick="showTitle()">Main Menu</button>
      </div>
    </div>

    <!-- ===== INITIALS ENTRY SCREEN ===== -->
    <div id="screen-initials">
      <div class="game-title" style="font-size:clamp(1.4rem,4vw,2rem);">New Champion!</div>
      <hr class="divider">
      <div class="initials-prompt">
        Thy score of <strong id="initials-score-display">0</strong> hath earned a place<br>
        in the Hall of Champions!<br>
        Enter thy initials to claim thy glory.
      </div>
      <div class="initials-row">
        <input class="initial-input" id="init-0" maxlength="1" autocomplete="off" spellcheck="false">
        <input class="initial-input" id="init-1" maxlength="1" autocomplete="off" spellcheck="false">
        <input class="initial-input" id="init-2" maxlength="1" autocomplete="off" spellcheck="false">
      </div>
      <div class="initials-error" id="initials-error"></div>
      <div class="initials-btns">
        <button class="btn-primary" id="claim-glory-btn" onclick="submitInitials()">Claim Glory</button>
        <button class="btn-secondary" onclick="skipInitials()">Skip</button>
      </div>
    </div>

    <!-- ===== DIFFICULTY SCREEN ===== -->
    <div id="screen-difficulty">
      <div class="game-title" style="font-size:clamp(1.4rem,4vw,2rem);">Choose Thy Path</div>
      <hr class="divider">
      <div class="diff-intro">Select your difficulty. The Hall of Champions tracks each path separately.</div>
      <div class="diff-cards">
        <div class="diff-card" onclick="selectDifficulty('easy')">
          <div class="diff-icon">üå±</div>
          <div class="diff-text">
            <span class="diff-label">Easy</span>
            <span class="diff-desc">Angle conversions only ‚Äî degrees to radians and back. Master the language of the circle.</span>
          </div>
        </div>
        <div class="diff-card" onclick="selectDifficulty('medium')">
          <div class="diff-icon">‚öî</div>
          <div class="diff-text">
            <span class="diff-label">Medium</span>
            <span class="diff-desc">Angle conversions plus sine and cosine values.<br>The circle reveals its coordinates.</span>
          </div>
        </div>
        <div class="diff-card" onclick="selectDifficulty('expert')">
          <div class="diff-icon">üåå</div>
          <div class="diff-text">
            <span class="diff-label">Expert</span>
            <span class="diff-desc">Angles, sine, cosine and tangent.<br>Face the full circle.</span>
          </div>
        </div>
      </div>
      <div class="diff-btns">
        <button class="btn-secondary" onclick="showTitle()">Back</button>
      </div>
    </div>

    <!-- ===== LEADERBOARD SCREEN ===== -->
    <div id="screen-leaderboard">
      <div class="lb-title">Hall of Champions</div>
      <div class="lb-subtitle">Top 10 ¬∑ By Difficulty</div>
      <hr class="divider">
      <div class="lb-columns">
        <div class="lb-column-wrap">
          <div class="lb-column-header">
            <span class="lb-column-header-icon">üå±</span>
            <span class="lb-column-header-label">Easy</span>
          </div>
          <div id="lb-rows-easy"><div class="lb-loading">Loading...</div></div>
        </div>
        <div class="lb-column-wrap">
          <div class="lb-column-header">
            <span class="lb-column-header-icon">‚öî</span>
            <span class="lb-column-header-label">Medium</span>
          </div>
          <div id="lb-rows-medium"><div class="lb-loading">Loading...</div></div>
        </div>
        <div class="lb-column-wrap">
          <div class="lb-column-header">
            <span class="lb-column-header-icon">üåå</span>
            <span class="lb-column-header-label">Expert</span>
          </div>
          <div id="lb-rows-expert"><div class="lb-loading">Loading...</div></div>
        </div>
      </div>
      <div class="lb-btns">
        <button class="btn-primary" onclick="showDifficulty()">Play Again</button>
        <button class="btn-secondary" onclick="showTitle()">Main Menu</button>
      </div>
    </div>

  </div><!-- .frame -->
</div><!-- .game-container -->

<!-- ===== LORD OF HYPERSPHERES EASTER EGG ===== -->
<div id="hypersphere-overlay" onclick="dismissHypersphereEgg()">
  <div class="hs-flames" id="hs-flames"></div>
  <div class="hs-title">üåå LORD OF HYPERSPHERES üåå</div>
  <div class="hs-subtitle">You have transcended the Unit Circle itself.<br>The Jackalope weeps tears of pure mathematics.</div>
  <div class="hs-continue">‚Äî click anywhere to continue ‚Äî</div>
</div>

<script>
// ================================================================
//  GOOGLE SHEETS BACKEND CONFIG
//  Paste your Apps Script deployment URL below once it's live.
//  Leave as null to use localStorage only (offline/dev mode).
// ================================================================
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyLPSFxO2iYtjWCiZECtP0B6TKUnRAAgese09W5rh2jga2ze5bX8F9iNxL8UpiJP2Wj/exec';
const SHEETS_KEY = 'jackalope2025';

// ================================================================
//  PROFANITY BLOCKLIST ‚Äî common inappropriate 3-letter combos
// ================================================================
const BLOCKED_INITIALS = new Set([
  'ASS','ARS','FCK','FUK','FUC','CUM','COK','COC','CNT','CNT',
  'DIC','DIK','DIX','FAG','GAY','JIZ','KKK','NGR','NIG','PNS',
  'PNS','PUS','SEX','SHT','SLT','TIT','VAG','WTF','HOR','HOE',
  'SKK','SKK','BAS','FFS','FNG','MFR','SOB','STD','VJJ','XXX',
  'ACE','KYS','SUK','SUC','BJ','BLJ','BWJ','HJB','HJ'
]);

function isBlockedInitials(str) {
  return BLOCKED_INITIALS.has(str.toUpperCase());
}

// ================================================================
//  UNIT CIRCLE DATA
// ================================================================
const ANGLES = [
  { deg: 0,   rad: '0',     sin: '0',      cos: '1',      tan: '0'         },
  { deg: 30,  rad: 'œÄ/6',   sin: '1/2',    cos: '‚àö3/2',   tan: '‚àö3/3'      },
  { deg: 45,  rad: 'œÄ/4',   sin: '‚àö2/2',   cos: '‚àö2/2',   tan: '1'         },
  { deg: 60,  rad: 'œÄ/3',   sin: '‚àö3/2',   cos: '1/2',    tan: '‚àö3'        },
  { deg: 90,  rad: 'œÄ/2',   sin: '1',      cos: '0',      tan: 'undefined' },
  { deg: 120, rad: '2œÄ/3',  sin: '‚àö3/2',   cos: '-1/2',   tan: '-‚àö3'       },
  { deg: 135, rad: '3œÄ/4',  sin: '‚àö2/2',   cos: '-‚àö2/2',  tan: '-1'        },
  { deg: 150, rad: '5œÄ/6',  sin: '1/2',    cos: '-‚àö3/2',  tan: '-‚àö3/3'     },
  { deg: 180, rad: 'œÄ',     sin: '0',      cos: '-1',     tan: '0'         },
  { deg: 210, rad: '7œÄ/6',  sin: '-1/2',   cos: '-‚àö3/2',  tan: '‚àö3/3'      },
  { deg: 225, rad: '5œÄ/4',  sin: '-‚àö2/2',  cos: '-‚àö2/2',  tan: '1'         },
  { deg: 240, rad: '4œÄ/3',  sin: '-‚àö3/2',  cos: '-1/2',   tan: '‚àö3'        },
  { deg: 270, rad: '3œÄ/2',  sin: '-1',     cos: '0',      tan: 'undefined' },
  { deg: 300, rad: '5œÄ/3',  sin: '-‚àö3/2',  cos: '1/2',    tan: '-‚àö3'       },
  { deg: 315, rad: '7œÄ/4',  sin: '-‚àö2/2',  cos: '‚àö2/2',   tan: '-1'        },
  { deg: 330, rad: '11œÄ/6', sin: '-1/2',   cos: '‚àö3/2',   tan: '-‚àö3/3'     },
];

const SIN_COS_POOL = ['0','1','-1','1/2','-1/2','‚àö2/2','-‚àö2/2','‚àö3/2','-‚àö3/2'];
const TAN_POOL     = ['0','1','-1','‚àö3','-‚àö3','‚àö3/3','-‚àö3/3','undefined'];
const RAD_POOL     = ['0','œÄ/6','œÄ/4','œÄ/3','œÄ/2','2œÄ/3','3œÄ/4','5œÄ/6','œÄ',
                      '7œÄ/6','5œÄ/4','4œÄ/3','3œÄ/2','5œÄ/3','7œÄ/4','11œÄ/6','2œÄ'];
const DEG_POOL     = ['0¬∞','30¬∞','45¬∞','60¬∞','90¬∞','120¬∞','135¬∞','150¬∞','180¬∞',
                      '210¬∞','225¬∞','240¬∞','270¬∞','300¬∞','315¬∞','330¬∞','360¬∞'];

// ================================================================
//  QUESTION POOL
// ================================================================
function buildQuestionPool() {
  const pool = [];
  for (const a of ANGLES) {
    const deg = a.deg + '¬∞';
    const rad = a.deg === 0 ? '0' : a.rad;
    // Easy+: angle conversions
    pool.push({ tag:'Degrees ‚Üí Radians', html:`Convert <span class="angle-val">${deg}</span> to radians`, answer:rad, pool:RAD_POOL });
    pool.push({ tag:'Radians ‚Üí Degrees', html:`Convert <span class="angle-val">${rad}</span> radians to degrees`, answer:deg, pool:DEG_POOL });
    // Medium+: sine and cosine
    if (currentDifficulty === 'medium' || currentDifficulty === 'expert') {
      pool.push({ tag:'Sine',   html:`Find <span class="angle-val">sin(${deg})</span>`, answer:a.sin, pool:SIN_COS_POOL });
      pool.push({ tag:'Cosine', html:`Find <span class="angle-val">cos(${deg})</span>`, answer:a.cos, pool:SIN_COS_POOL });
      pool.push({ tag:'Tangent', html:`Find <span class="angle-val">tan(${deg})</span>`, answer:a.tan, pool:TAN_POOL });
      if (a.deg !== 0) {
        pool.push({ tag:'Sine',   html:`Find <span class="angle-val">sin(${rad})</span>`, answer:a.sin, pool:SIN_COS_POOL });
        pool.push({ tag:'Cosine', html:`Find <span class="angle-val">cos(${rad})</span>`, answer:a.cos, pool:SIN_COS_POOL });
      }
    }
    // Expert: tangent (already included above in medium+ block, but only for expert we keep it)
  }
  // Remove tangent from medium
  if (currentDifficulty === 'medium') {
    return pool.filter(q => q.tag !== 'Tangent');
  }
  return pool;
}

// ================================================================
//  HELPERS
// ================================================================
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function getChoices(answer, pool, n = 4) {
  return shuffle([answer, ...shuffle(pool.filter(p => p !== answer)).slice(0, n - 1)]);
}

const ALL_SCREENS = ['screen-title','screen-difficulty','screen-game','screen-end','screen-initials','screen-leaderboard'];

function setScreen(id) {
  ALL_SCREENS.forEach(s => {
    const el = document.getElementById(s);
    el.style.display = 'none';
    el.classList.remove('screen-active');
  });
  const el = document.getElementById(id);
  el.style.display = 'block';
  requestAnimationFrame(() => el.classList.add('screen-active'));
}

function formatDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

// ================================================================
//  RANK HELPERS
// ================================================================
function getRankTitle(score) {
  if (score >= 100) return 'Lord of Hyperspheres';
  if (score >= 80)  return 'Master of Spheres';
  if (score >= 70)  return 'Sorceress of Radii';
  if (score >= 60)  return 'Wizard of Orbs';
  if (score >= 50)  return 'Assistant to the District Manager';
  if (score >= 40)  return 'Grand Master of the Round';
  if (score >= 30)  return 'Circle Knight';
  if (score >= 20)  return 'Scholar';
  if (score >= 10)  return 'Apprentice';
  if (score >= 5)   return 'Initiate';
  return 'Wanderer';
}

function getRankDisplay(s) {
  if (s >= 100) return { rank: 'üåå Lord of Hyperspheres üåå',           msg: 'Inconceivable. You have transcended the circle itself.' };
  if (s >= 80)  return { rank: 'üîÆ Master of Spheres',                 msg: 'Extraordinary mastery. The hypersphere beckons.' };
  if (s >= 70)  return { rank: 'üåô Sorceress of Radii',                msg: 'Radiant command of every angle and arc.' };
  if (s >= 60)  return { rank: 'üßô Wizard of Orbs',                    msg: 'Your orbital wisdom is without equal.' };
  if (s >= 50)  return { rank: 'üìã Assistant to the District Manager', msg: 'Beets. Bears. Battlestar Galactica.' };
  if (s >= 40)  return { rank: '‚öî Grand Master of the Round',          msg: 'A seat at the round table is yours.' };
  if (s >= 30)  return { rank: 'üèÜ Circle Knight',                     msg: 'The unit circle holds few secrets from thee.' };
  if (s >= 20)  return { rank: 'üìú Scholar',                           msg: 'Solid scholarship. The circle yields its secrets.' };
  if (s >= 10)  return { rank: 'üéì Apprentice',                        msg: 'A promising start. Keep sharpening thy blade.' };
  if (s >= 5)   return { rank: 'üå± Initiate',                          msg: 'A humble start. The Jackalope believes in thee.' };
                return { rank: 'üêæ Wanderer',                          msg: 'The circle awaits thy study. Try again!' };
}

function renderColumnLeaderboard(containerId, entries) {
  const container = document.getElementById(containerId);
  if (!entries || entries.length === 0) {
    container.innerHTML = '<div class="lb-empty">No champions yet ‚Äî<br>be the first!</div>';
    return;
  }
  container.innerHTML = entries.map((e, i) => {
    const rankNum = i + 1;
    let rankClass = '';
    let rankDisplay = `#${rankNum}`;
    if (rankNum === 1) { rankClass = 'gold';   rankDisplay = 'üëë'; }
    if (rankNum === 2) { rankClass = 'silver'; rankDisplay = '‚öî'; }
    if (rankNum === 3) { rankClass = 'bronze'; rankDisplay = 'üõ°'; }
    const isNew = e.id === lastNewEntryId;
    return `
      <div class="lb-col-row${isNew ? ' new-entry' : ''}">
        <div class="lb-col-rank ${rankClass}">${rankDisplay}</div>
        <div class="lb-col-initials">${e.initials}</div>
        <div class="lb-col-score">${e.score}</div>
      </div>`;
  }).join('');
}

// ================================================================
//  LEADERBOARD  ‚Äî Google Sheets (global) with localStorage fallback
// ================================================================
const LB_KEY = 'unitcircle:leaderboard:v2';
let lastNewEntryId = null;
let currentDifficulty = null; // 'easy' | 'medium' | 'expert'

// ---------- localStorage helpers (cache only ‚Äî Sheets is source of truth) ----------
function loadLocalLB() {
  try {
    const raw = localStorage.getItem(LB_KEY);
    return raw ? JSON.parse(raw) : { easy: [], medium: [], expert: [] };
  } catch (e) { return { easy: [], medium: [], expert: [] }; }
}
function saveLocalLB(data) {
  try { localStorage.setItem(LB_KEY, JSON.stringify(data)); } catch (e) {}
}
function clearLocalLB() {
  try { localStorage.removeItem(LB_KEY); } catch (e) {}
}

// On load, wipe any old locally-stored scores so Sheets is always source of truth
if (SHEETS_URL) clearLocalLB();

// ---------- Sheets helpers ----------
async function sheetsGet() {
  const res = await fetch(SHEETS_URL + '?action=get&game=ucq&key=' + SHEETS_KEY);
  if (!res.ok) throw new Error('GET failed');
  return res.json();
}

async function sheetsPost(entry) {
  const params = new URLSearchParams({
    action: 'post',
    key:        SHEETS_KEY,
    game:       entry.game,
    difficulty: entry.difficulty,
    initials:   entry.initials,
    score:      entry.score,
    rankTitle:  entry.rankTitle,
    ts:         entry.ts,
    id:         entry.id
  });
  const res = await fetch(SHEETS_URL + '?' + params.toString());
  if (!res.ok) throw new Error('POST-as-GET failed');
}

// ---------- Public API used by the rest of the game ----------
function checkIsTop10(score) {
  const data = loadLocalLB();
  const entries = data[currentDifficulty] || [];
  if (entries.length < 10) return true;
  return score > entries[entries.length - 1].score;
}

async function submitScore(initials, score) {
  const rankTitle = getRankTitle(score);
  const id = Date.now() + Math.random().toString(36).slice(2);
  const entry = { id, initials, score, rankTitle, difficulty: currentDifficulty, game: 'ucq', ts: Date.now() };
  lastNewEntryId = id;

  if (SHEETS_URL) {
    try {
      await sheetsPost(entry);
      // After posting, fetch fresh data from Sheets and cache it locally
      const fresh = await sheetsGet();
      saveLocalLB(fresh);
    } catch (e) {
      console.warn('Sheets unavailable, saving locally:', e);
      // Fallback: write to local cache only
      const data = loadLocalLB();
      const bucket = data[currentDifficulty] || [];
      bucket.push(entry);
      bucket.sort((a, b) => b.score - a.score || a.ts - b.ts);
      data[currentDifficulty] = bucket.slice(0, 10);
      saveLocalLB(data);
    }
  } else {
    // No Sheets configured ‚Äî local only
    const data = loadLocalLB();
    const bucket = data[currentDifficulty] || [];
    bucket.push(entry);
    bucket.sort((a, b) => b.score - a.score || a.ts - b.ts);
    data[currentDifficulty] = bucket.slice(0, 10);
    saveLocalLB(data);
  }

  showLeaderboard(true);
  return Promise.resolve();
}

async function showLeaderboard(highlightNew) {
  setScreen('screen-leaderboard');
  if (!highlightNew) lastNewEntryId = null;
  ['lb-rows-easy','lb-rows-medium','lb-rows-expert'].forEach(id => {
    document.getElementById(id).innerHTML = '<div class="lb-loading">Consulting the ancient scrolls...</div>';
  });

  let data;
  if (SHEETS_URL) {
    try {
      data = await sheetsGet();
      // Merge remote into local so offline still works
      saveLocalLB(data);
    } catch (e) {
      console.warn('Sheets GET failed, using local cache:', e);
      data = loadLocalLB();
    }
  } else {
    await new Promise(r => setTimeout(r, 300)); // brief dramatic pause
    data = loadLocalLB();
  }

  renderColumnLeaderboard('lb-rows-easy',   data.easy   || []);
  renderColumnLeaderboard('lb-rows-medium', data.medium || []);
  renderColumnLeaderboard('lb-rows-expert', data.expert || []);
}

function showDifficulty() {
  setScreen('screen-difficulty');
}

function selectDifficulty(diff) {
  currentDifficulty = diff;
  startGame();
}

// ================================================================
//  INITIALS ENTRY
// ================================================================
function setupInitialInputs() {
  for (let i = 0; i < 3; i++) {
    const input = document.getElementById(`init-${i}`);
    input.value = '';
    input.oninput = (e) => {
      const val = e.target.value.replace(/[^a-zA-Z]/g, '').toUpperCase();
      e.target.value = val ? val[val.length - 1] : '';
      if (e.target.value && i < 2) document.getElementById(`init-${i+1}`).focus();
    };
    input.onkeydown = (e) => {
      if (e.key === 'Backspace' && !e.target.value && i > 0) {
        document.getElementById(`init-${i-1}`).focus();
      }
      if (e.key === 'Enter') submitInitials();
    };
  }
  document.getElementById('initials-error').textContent = '';
}

function getInitialsValue() {
  return ['init-0','init-1','init-2'].map(id => document.getElementById(id).value.toUpperCase()).join('');
}

function submitInitials() {
  if (submitting) return; // prevent double-submission
  const initials = getInitialsValue();
  const errorEl = document.getElementById('initials-error');

  if (initials.length < 3) {
    errorEl.textContent = '‚ö† Enter all three initials to proceed.';
    return;
  }
  if (isBlockedInitials(initials)) {
    errorEl.textContent = '‚ö† Those initials are not permitted. Please choose others.';
    return;
  }

  // Lock the button immediately
  submitting = true;
  const btn = document.getElementById('claim-glory-btn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  errorEl.textContent = '';
  submitScore(initials, score).finally(() => {
    submitting = false;
    btn.disabled = false;
    btn.textContent = 'Claim Glory';
  });
}


function skipInitials() {
  showLeaderboard(false);
}

// ================================================================
//  GAME STATE
// ================================================================
let score = 0;
let streak = 0;
let timeLeft = 60;
let timerInterval = null;
let questionPool = [];
let currentQ = null;
let busy = false;
let attempted = 0;
let chillMode = false;
let submitting = false;
let tallyCorrect = 0;
let tallyWrong = 0;
let showTotals = false;

function showTitle() {
  clearInterval(timerInterval);
  setScreen('screen-title');
}

function toggleTotals() {
  showTotals = !showTotals;
  document.getElementById('chill-totals-wrap').classList.toggle('chill-active', showTotals);
  document.getElementById('totals-toggle-btn').textContent = showTotals ? 'Hide Totals' : 'Show Totals';
}

function updateChillDesc() {
  // desc is always visible, nothing to toggle
}

function startGame() {
  chillMode = document.getElementById('chill-toggle').checked;
  score = 0;
  streak = 0;
  timeLeft = 60;
  attempted = 0;
  questionPool = shuffle(buildQuestionPool());

  const diffIcons = { easy: 'üå± Easy', medium: '‚öî Medium', expert: 'üåå Expert' };
  const chillTag = chillMode ? ' ¬∑ ‚ùÑÔ∏è Chill' : '';
  document.getElementById('difficulty-badge').textContent = (diffIcons[currentDifficulty] || '') + chillTag;
  document.getElementById('score-display').textContent = '0';
  document.getElementById('streak-display').textContent = '0';
  document.getElementById('timer-display').textContent = '60';
  document.getElementById('timer-bar').style.width = '100%';
  document.getElementById('timer-bar').className = 'timer-bar';
  document.getElementById('feedback-msg').textContent = '';
  document.getElementById('flame-row').classList.remove('active');
  document.getElementById('continue-btn').classList.remove('visible');

  // Reset tallies
  tallyCorrect = 0;
  tallyWrong = 0;
  showTotals = false;
  document.getElementById('tally-correct').textContent = '0';
  document.getElementById('tally-wrong').textContent = '0';
  document.getElementById('chill-totals-wrap').classList.remove('chill-active');
  const totalsBtn = document.getElementById('totals-toggle-btn');
  totalsBtn.textContent = 'Show Totals';
  totalsBtn.classList.toggle('chill-active', chillMode);
  document.getElementById('chill-menu-btn-wrap').style.display = chillMode ? 'block' : 'none';
  document.getElementById('restart-btn-wrap').style.display = chillMode ? 'none' : 'block';

  // Hide HUD elements that don't apply in Chill Mode
  const hudScore  = document.getElementById('score-display').closest('.hud-stat');
  const hudStreak = document.getElementById('streak-display').closest('.hud-stat');
  const hudTime   = document.getElementById('timer-display').closest('.hud-stat');
  const timerBar  = document.querySelector('.timer-bar-wrap');
  if (chillMode) {
    hudScore.style.visibility  = 'hidden';
    hudStreak.style.visibility = 'hidden';
    hudTime.style.visibility   = 'hidden';
    timerBar.style.visibility  = 'hidden';
  } else {
    hudScore.style.visibility  = '';
    hudStreak.style.visibility = '';
    hudTime.style.visibility   = '';
    timerBar.style.visibility  = '';
  }

  setScreen('screen-game');
  nextQuestion();
  if (!chillMode) startTimer();
}

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById('timer-display').textContent = timeLeft;
    document.getElementById('timer-bar').style.width = (timeLeft / 60 * 100) + '%';
    if (timeLeft <= 15) document.getElementById('timer-bar').classList.add('warning');
    if (timeLeft <= 0) { clearInterval(timerInterval); endGame(); }
  }, 1000);
}

function nextQuestion() {
  if (questionPool.length === 0) questionPool = shuffle(buildQuestionPool());
  currentQ = questionPool.pop();
  busy = false;

  document.getElementById('continue-btn').classList.remove('visible');
  document.getElementById('q-type-tag').textContent = currentQ.tag;
  document.getElementById('q-text').innerHTML = currentQ.html;
  document.getElementById('feedback-msg').textContent = '';

  // Blur active element BEFORE rebuilding buttons so hover state
  // doesn't carry over to the new button appearing at same position
  if (document.activeElement) document.activeElement.blur();

  const choices = getChoices(currentQ.answer, currentQ.pool, 4);
  const grid = document.getElementById('choices-grid');
  grid.innerHTML = '';
  grid.blur();

  // Briefly disable pointer events so the hovered position doesn't
  // immediately highlight the new button appearing under the cursor
  grid.style.pointerEvents = 'none';
  setTimeout(() => { grid.style.pointerEvents = ''; }, 120);

  choices.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = c;
    btn.onclick = () => handleAnswer(c, btn);
    grid.appendChild(btn);
  });
}

// ================================================================
//  LORD OF HYPERSPHERES EASTER EGG
// ================================================================
function triggerHypersphereEasterEgg() {
  const overlay = document.getElementById('hypersphere-overlay');
  const flamesEl = document.getElementById('hs-flames');
  overlay.classList.add('active');
  flamesEl.innerHTML = '';

  const W = window.innerWidth;
  let launched = 0;
  const totalFlames = 120;
  const duration = 5000; // ms over which all flames spawn

  function launchFlame() {
    const span = document.createElement('span');
    span.className = 'hs-flame-span';
    const size = (1.5 + Math.random() * 2.5).toFixed(1);
    const left = Math.random() * 100;
    const riseDuration = (2.5 + Math.random() * 3).toFixed(1);
    const delay = (Math.random() * 0.3).toFixed(2);
    span.style.cssText = `
      left: ${left}%;
      font-size: ${size}rem;
      animation-duration: ${riseDuration}s;
      animation-delay: ${delay}s;
    `;
    span.textContent = 'üî•';
    flamesEl.appendChild(span);
    // Remove after animation to avoid DOM bloat
    setTimeout(() => span.remove(), (parseFloat(riseDuration) + parseFloat(delay) + 0.5) * 1000);
  }

  // Launch flames in waves over 5 seconds
  const interval = setInterval(() => {
    // Launch 2-4 flames per tick
    const batch = 2 + Math.floor(Math.random() * 3);
    for (let i = 0; i < batch; i++) launchFlame();
    launched += batch;
    if (launched >= totalFlames) clearInterval(interval);
  }, duration / (totalFlames / 3));

  // After egg, prompt for initials if top 10
  setTimeout(() => {
    const qualifies = checkIsTop10(score);
    if (qualifies) {
      document.getElementById('initials-score-display').textContent = score;
      setupInitialInputs();
      // Don't auto-dismiss ‚Äî let them click through first
    }
  }, 5500);
}

function dismissHypersphereEgg() {
  document.getElementById('hypersphere-overlay').classList.remove('active');
  // Now check leaderboard
  const qualifies = checkIsTop10(score);
  if (qualifies && score > 0) {
    document.getElementById('initials-score-display').textContent = score;
    setupInitialInputs();
    setScreen('screen-initials');
    setTimeout(() => document.getElementById('init-0').focus(), 350);
  }
}
(function buildFlames() {
  const row = document.getElementById('flame-row');
  const COUNT = 18;
  for (let i = 0; i < COUNT; i++) {
    const span = document.createElement('span');
    span.className = 'flame';
    span.textContent = 'üî•';
    const duration = (0.6 + Math.random() * 0.8).toFixed(2);
    const delay    = (Math.random() * 1.0).toFixed(2);
    const fsA = (1.4 + Math.random() * 0.4).toFixed(1);
    const fsB = (1.9 + Math.random() * 0.4).toFixed(1);
    const fsC = (1.2 + Math.random() * 0.4).toFixed(1);
    span.style.cssText = `
      font-size: ${fsA}rem;
      --fs-a: ${fsA}rem;
      --fs-b: ${fsB}rem;
      --fs-c: ${fsC}rem;
      animation: flameSize ${duration}s ${delay}s ease-in-out infinite;
    `;
    row.appendChild(span);
  }
})();

function updateFlames() {
  document.getElementById('flame-row').classList.toggle('active', streak >= 5);
}

function handleAnswer(choice, btn) {
  if (busy) return;
  busy = true;
  attempted++;
  document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);

  // Chill mode: always reveal correct answer
  if (chillMode) {
    document.querySelectorAll('.choice-btn').forEach(b => {
      if (b.textContent === currentQ.answer) b.classList.add('reveal');
    });
    if (choice === currentQ.answer) {
      btn.classList.add('correct');
      tallyCorrect++;
      document.getElementById('feedback-msg').textContent = '‚ú¶ Correct!';
    } else {
      btn.classList.add('wrong');
      tallyWrong++;
      document.getElementById('feedback-msg').textContent = `‚úó The answer is ${currentQ.answer}`;
    }
    document.getElementById('tally-correct').textContent = tallyCorrect;
    document.getElementById('tally-wrong').textContent = tallyWrong;
    document.getElementById('continue-btn').classList.add('visible');
    return;
  }

  // Normal mode
  if (choice === currentQ.answer) {
    btn.classList.add('correct');
    streak++;
    const points = streak;
    score += points;
    score = Math.max(0, score);
    document.getElementById('score-display').textContent = score;
    document.getElementById('streak-display').textContent = streak;
    updateFlames();
    const msg = streak >= 5 ? `üî• x${streak} STREAK! +${points}` :
                streak >= 3 ? `‚ö° x${streak} Streak! +${points}` :
                streak >= 2 ? `‚ú¶ x${streak} Streak! +${points}` : `‚ú¶ Correct! +${points}`;
    document.getElementById('feedback-msg').textContent = msg;
    setTimeout(nextQuestion, 600);
  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.choice-btn').forEach(b => {
      if (b.textContent === currentQ.answer) b.classList.add('reveal');
    });
    const oldStreak = streak;
    streak = 0;
    document.getElementById('streak-display').textContent = '0';
    updateFlames();
    const msg = oldStreak >= 2 ? `‚úó Streak lost!` : `‚úó Wrong!`;
    document.getElementById('feedback-msg').textContent = `${msg}  ‚Üí  ${currentQ.answer}`;
    setTimeout(nextQuestion, 1600);
  }
}

function endGame() {
  document.getElementById('final-score').textContent = score;
  document.getElementById('questions-answered').textContent =
    `${score} correct out of ${attempted} attempted`;

  const { rank, msg } = getRankDisplay(score);
  document.getElementById('rank-text').textContent = rank;
  const diffLabels = { easy: 'üå± Easy Mode', medium: '‚öî Medium Mode', expert: 'üåå Expert Mode' };
  document.getElementById('end-difficulty').textContent = diffLabels[currentDifficulty] || '';
  document.getElementById('end-message').textContent = msg;

  setScreen('screen-end');

  // Chill mode ‚Äî no leaderboard, no easter egg
  if (chillMode) return;

  // Lord of Hyperspheres easter egg
  if (score >= 100) {
    setTimeout(triggerHypersphereEasterEgg, 600);
    return; // skip leaderboard prompt ‚Äî they'll get it after the egg
  }

  // Check if score qualifies for top 10
  const qualifies = checkIsTop10(score);
  if (qualifies && score > 0) {
    setTimeout(() => {
      document.getElementById('initials-score-display').textContent = score;
      setupInitialInputs();
      setScreen('screen-initials');
      setTimeout(() => document.getElementById('init-0').focus(), 350);
    }, 2000);
  }
}


</script>
</body>
</html>
