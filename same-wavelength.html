<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAME WAVELENGTH — Synth Lab</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

  :root {
    --bg: #0a0a0f;
    --panel: #0f0f1a;
    --border: #1a1a2e;
    --green: #00ff9f;
    --amber: #ffaa00;
    --red: #ff3355;
    --blue: #00aaff;
    --purple: #aa55ff;
    --text: #c8ffd4;
    --muted: #4a6a4a;
    --glow: 0 0 10px #00ff9f88, 0 0 20px #00ff9f44;
    --amber-glow: 0 0 10px #ffaa0088, 0 0 20px #ffaa0044;
    --red-glow: 0 0 10px #ff335588, 0 0 20px #ff335544;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    padding: 16px;
    background-image:
      radial-gradient(ellipse at 20% 10%, #001a0e44 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, #001020 0%, transparent 50%);
  }

  body::before {
    content: ''; position: fixed; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.07) 2px, rgba(0,0,0,0.07) 4px);
    pointer-events: none; z-index: 200;
  }

  h1 {
    font-family: 'Orbitron', sans-serif; font-weight: 900;
    font-size: clamp(1rem, 2.5vw, 1.6rem); letter-spacing: 0.3em;
    color: var(--green); text-shadow: var(--glow); margin-bottom: 2px;
  }

  /* ── SCREENS ── */
  .screen { display: none; width: 100%; max-width: 1000px; flex-direction: column; align-items: center; }
  .screen.active { display: flex; }

  /* ── TITLE SCREEN ── */
  #titleScreen { min-height: 80vh; justify-content: center; gap: 28px; text-align: center; }
  .title-logo {
    font-family: 'Orbitron', sans-serif; font-weight: 900;
    font-size: clamp(2rem, 6vw, 4rem); letter-spacing: 0.3em;
    color: var(--green); text-shadow: var(--glow); line-height: 1.1;
  }
  .title-sub { font-size: 0.85rem; letter-spacing: 0.3em; color: var(--muted); margin-top: -16px; }
  .title-sine { width: 100%; max-width: 500px; opacity: 0.3; margin: 0 auto; }
  .instructions {
    background: var(--panel); border: 1px solid var(--border); border-radius: 6px;
    padding: 24px 32px; max-width: 560px; text-align: left;
    line-height: 2; font-size: 0.82rem; color: #8aaa8a;
  }
  .instructions h3 {
    font-family: 'Orbitron', sans-serif; font-size: 0.75rem;
    letter-spacing: 0.3em; color: var(--amber); margin-bottom: 12px; text-shadow: var(--amber-glow);
  }
  .instructions .hl  { color: var(--green); }
  .instructions .warn{ color: var(--red); }
  .big-btn {
    font-family: 'Orbitron', sans-serif; font-size: 0.9rem; letter-spacing: 0.25em;
    background: transparent; border: 2px solid var(--green); color: var(--green);
    padding: 16px 48px; border-radius: 4px; cursor: pointer;
    text-shadow: var(--glow); box-shadow: var(--glow); transition: all 0.15s;
  }
  .big-btn:hover { background: #00ff9f22; box-shadow: 0 0 30px #00ff9faa, 0 0 60px #00ff9f44; }
  .big-btn:active { transform: scale(0.98); }

  /* ── WORLD MAP SCREEN ── */
  #mapScreen { gap: 16px; padding: 20px 0; }
  .map-title {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(1.1rem, 3vw, 1.8rem);
    letter-spacing: 0.3em;
    color: var(--green);
    text-shadow: var(--glow);
  }
  .map-hp-row { display: flex; gap: 8px; align-items: center; }
  .map-hp-label {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(0.75rem, 1.8vw, 1rem);
    color: var(--text);
    margin-right: 6px;
    letter-spacing: 0.15em;
  }
  .map-container { position: relative; width: 100%; max-width: 800px; height: 320px; }
  .map-svg { width: 100%; height: 100%; }
  .map-menu-btn {
    font-family: 'Orbitron', sans-serif; font-size: 0.65rem; letter-spacing: 0.2em;
    background: transparent; border: 1px solid #2a3a2a; color: var(--muted);
    padding: 8px 16px; border-radius: 3px; cursor: pointer; transition: all 0.2s;
    white-space: nowrap;
  }
  .map-menu-btn:hover { border-color: var(--green); color: var(--green); box-shadow: var(--glow); }

  /* ── GAME SCREEN ── */
  #gameScreen { gap: 0; }
  .game-header {
    display: flex; justify-content: space-between; align-items: baseline;
    width: 100%; max-width: 1000px; margin-bottom: 4px;
  }
  .world-badge {
    font-family: 'Orbitron', sans-serif; font-size: 0.72rem; letter-spacing: 0.2em;
  }

  /* ── SHIP PANELS ── */
  .ship-status {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 4px; padding: 10px 14px; position: relative; overflow: hidden;
  }
  .ship-status::before {
    content: ''; position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Ctext x='4' y='18' font-size='9' fill='%2300ff9f' opacity='0.06' font-family='monospace'%3Esin%3C/text%3E%3Ctext x='30' y='36' font-size='9' fill='%2300ff9f' opacity='0.06' font-family='monospace'%3E2π%3C/text%3E%3Ctext x='8' y='52' font-size='9' fill='%2300ff9f' opacity='0.06' font-family='monospace'%3E∫%3C/text%3E%3Ctext x='42' y='14' font-size='8' fill='%2300ff9f' opacity='0.06' font-family='monospace'%3Eω%3C/text%3E%3C/svg%3E");
    background-size: 60px 60px; pointer-events: none;
  }
  .ship-status.enemy::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Ctext x='4' y='18' font-size='9' fill='%23ff3355' opacity='0.07' font-family='monospace'%3Esin%3C/text%3E%3Ctext x='30' y='36' font-size='9' fill='%23ff3355' opacity='0.07' font-family='monospace'%3E2π%3C/text%3E%3Ctext x='8' y='52' font-size='9' fill='%23ff3355' opacity='0.07' font-family='monospace'%3E∫%3C/text%3E%3Ctext x='42' y='14' font-size='8' fill='%23ff3355' opacity='0.07' font-family='monospace'%3Eω%3C/text%3E%3C/svg%3E");
  }

  /* ── EQUATION BAR ── */
  .equation-bar { position: relative; overflow: hidden; }
  .equation-bar::before {
    content: ''; position: absolute; inset: 0;
    background-image:
      linear-gradient(rgba(0,255,159,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,159,0.03) 1px, transparent 1px);
    background-size: 20px 20px; pointer-events: none;
  }
  .equation-bar {
    width: 100%; margin-top: 12px; background: #020c07;
    border: 1px solid #00ff9f44; border-radius: 4px; padding: 14px 24px;
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    box-shadow: 0 0 20px #00ff9f11, inset 0 0 30px #001a0a;
  }
  .equation-bar-label { font-family: 'Orbitron', sans-serif; font-size: 0.65rem; letter-spacing: 0.3em; color: var(--muted); text-transform: uppercase; }
  .equation-bar-text { font-family: 'Share Tech Mono', monospace; font-size: clamp(1.3rem, 3vw, 2rem); color: var(--green); text-shadow: var(--glow); letter-spacing: 0.06em; text-align: center; }
  .equation-bar-text .frac { font-size: 1.45em; line-height: 0.85; vertical-align: -0.05em; }

  /* ── BATTLE BAR ── */
  .battle-bar { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; max-width: 1000px; gap: 12px; margin-bottom: 10px; }
  .ship-label { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; letter-spacing: 0.2em; color: var(--muted); margin-bottom: 6px; }
  .ship-svg-wrap { display: flex; justify-content: center; margin-bottom: 6px; }
  .health-pips { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
  .hp-pip { width: 14px; height: 14px; border-radius: 2px; transform: rotate(45deg); border: 1px solid currentColor; transition: all 0.3s; }
  .hp-pip.alive-green { background: var(--green); color: var(--green); box-shadow: 0 0 6px #00ff9f88; }
  .hp-pip.alive-red   { background: var(--red);   color: var(--red);   box-shadow: 0 0 6px #ff335588; }
  .hp-pip.dead        { background: transparent;  color: #2a2a3a; }
  .round-badge { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--amber); text-shadow: var(--amber-glow); text-align: center; letter-spacing: 0.15em; }

  /* ── MAIN LAYOUT ── */
  .main-layout { display: grid; grid-template-columns: 1fr 280px; gap: 14px; width: 100%; max-width: 1000px; }
  .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 4px; padding: 14px; position: relative; }
  .panel-label { font-family: 'Orbitron', sans-serif; font-size: 0.72rem; letter-spacing: 0.25em; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; }

  /* ── SCOPE ── */
  .scope-wrap { position: relative; }
  canvas#scope { display: block; width: 100%; border: 1px solid #0f2a1a; border-radius: 3px; background: #020c07; box-shadow: inset 0 0 30px #000a04, 0 0 15px #00ff9f11; }
  .scope-overlay { position: absolute; top:0;left:0;right:0;bottom:0; pointer-events:none; border-radius:3px; background: radial-gradient(ellipse at 50% 50%, transparent 60%, #020c0799 100%); }
  .scope-sine-border { width:100%; height:12px; margin-bottom:8px; opacity:0.25; }
  .legend { display:flex; gap:16px; margin-top:8px; font-size:0.75rem; flex-wrap:wrap; }
  .legend-item { display:flex; align-items:center; gap:5px; color:var(--muted); }
  .legend-line { width:20px; height:2px; border-radius:1px; }
  .target-hint { font-size:0.72rem; color:#2a5a3a; margin-top:5px; text-align:right; letter-spacing:0.1em; }

  /* ── CONTROLS ── */
  .controls-panel { display:flex; flex-direction:column; gap:10px; }
  .param-block { background:#080812; border:1px solid var(--border); border-radius:3px; padding:12px; }
  .param-header { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:6px; }
  .param-name { font-family:'Orbitron',sans-serif; font-size:1rem; letter-spacing:0.15em; color:var(--amber); text-shadow:var(--amber-glow); }
  .param-formula { font-size:0.85rem; color:#6a6a9a; }
  .param-value { font-size:1.4rem; color:var(--green); text-shadow:var(--glow); text-align:center; margin-bottom:5px; line-height:1.2; }
  .param-value .frac { font-size:1.8rem; }
  input[type=range] { -webkit-appearance:none; width:100%; height:4px; background:#0f2a1a; border-radius:2px; outline:none; cursor:pointer; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:14px; height:14px; background:var(--amber); border-radius:2px; box-shadow:0 0 8px #ffaa0088; cursor:pointer; transform:rotate(45deg); }
  input[type=range]::-webkit-slider-runnable-track { background:linear-gradient(to right,#0f2a1a,#1a3a2a); border-radius:2px; }
  .range-ends { display:flex; justify-content:space-between; font-size:0.7rem; color:var(--muted); margin-top:2px; }

  /* ── FEEDBACK ── */
  .feedback { min-height:54px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; gap:3px; }
  .feedback-score { font-family:'Orbitron',sans-serif; font-size:1.2rem; font-weight:700; }
  .feedback-msg { font-size:0.75rem; letter-spacing:0.08em; color:var(--muted); }
  .score-perfect { color:var(--green); text-shadow:var(--glow); }
  .score-good    { color:var(--amber); text-shadow:var(--amber-glow); }
  .score-miss    { color:var(--red);   text-shadow:var(--red-glow); }
  .attempts-row { display:flex; justify-content:space-between; align-items:center; font-size:0.72rem; color:var(--muted); margin-top:6px; }
  .attempt-pips { display:flex; gap:4px; }
  .pip { width:8px; height:8px; border-radius:1px; transform:rotate(45deg); border:1px solid var(--muted); }
  .pip.used { background:var(--amber); border-color:var(--amber); box-shadow:0 0 5px #ffaa0088; }
  .pip.hit  { background:var(--green); border-color:var(--green); box-shadow:0 0 5px #00ff9f88; }

  /* ── BUTTONS ── */
  .attempt-btn {
    font-family:'Orbitron',sans-serif; font-size:0.7rem; letter-spacing:0.2em; text-transform:uppercase;
    background:transparent; border:2px solid var(--green); color:var(--green);
    padding:11px; border-radius:3px; cursor:pointer; width:100%;
    transition:all 0.15s; text-shadow:var(--glow); box-shadow:var(--glow);
  }
  .attempt-btn:hover { background:#00ff9f22; }
  .attempt-btn:active { transform:scale(0.98); }
  .attempt-btn:disabled { opacity:0.3; cursor:not-allowed; }
  .quit-btn {
    font-family:'Orbitron',sans-serif; font-size:0.65rem; letter-spacing:0.15em;
    background:transparent; border:1px solid #2a1a1a; color:#4a2a2a;
    padding:8px; border-radius:3px; cursor:pointer; width:100%; transition:all 0.2s; margin-top:4px;
  }
  .quit-btn:hover { border-color:var(--red); color:var(--red); box-shadow:0 0 8px #ff335533; }

  /* Inline quit confirm */
  .quit-confirm {
    display:none; background:#0f0810; border:1px solid #ff335544;
    border-radius:3px; padding:10px; margin-top:4px; text-align:center;
  }
  .quit-confirm.visible { display:block; }
  .quit-confirm p { font-size:0.7rem; color:#aa6666; letter-spacing:0.05em; margin-bottom:8px; line-height:1.6; }
  .quit-confirm-btns { display:flex; gap:6px; }
  .quit-yes {
    flex:1; font-family:'Orbitron',sans-serif; font-size:0.65rem; letter-spacing:0.1em;
    background:transparent; border:1px solid var(--red); color:var(--red);
    padding:7px; border-radius:3px; cursor:pointer; transition:all 0.15s;
  }
  .quit-yes:hover { background:#ff335522; }
  .quit-no {
    flex:1; font-family:'Orbitron',sans-serif; font-size:0.65rem; letter-spacing:0.1em;
    background:transparent; border:1px solid #2a2a4a; color:#4a4a8a;
    padding:7px; border-radius:3px; cursor:pointer; transition:all 0.15s;
  }
  .quit-no:hover { border-color:#6a6aaa; color:#8a8acc; }
  @keyframes pulse { 0%,100%{box-shadow:var(--glow);} 50%{box-shadow:0 0 20px #00ff9faa,0 0 40px #00ff9f55;} }

  /* ── FLASH ANIMATIONS ── */
  @keyframes flashGreen { 0%{box-shadow:0 0 0 #00ff9f;} 50%{box-shadow:0 0 50px #00ff9f99,0 0 100px #00ff9f44;} 100%{box-shadow:0 0 0 #00ff9f;} }
  @keyframes flashRed   { 0%{box-shadow:0 0 0 #ff3355;} 50%{box-shadow:0 0 50px #ff335599,0 0 100px #ff335544;} 100%{box-shadow:0 0 0 #ff3355;} }
  .success-flash { animation:flashGreen 0.5s ease; }
  .damage-flash  { animation:flashRed   0.4s ease; }

  /* ── OVERLAYS ── */
  .overlay { display:none; position:fixed; inset:0; z-index:300; background:rgba(5,5,12,0.95); flex-direction:column; align-items:center; justify-content:center; gap:24px; text-align:center; }
  .overlay.active { display:flex; }
  .overlay-title { font-family:'Orbitron',sans-serif; font-weight:900; font-size:clamp(2rem,6vw,3rem); letter-spacing:0.2em; }
  .overlay-title.win  { color:var(--green); text-shadow:0 0 30px #00ff9f,0 0 60px #00ff9f66; }
  .overlay-sub { font-size: clamp(1rem, 2.5vw, 1.3rem); color: var(--text); letter-spacing: 0.08em; max-width: 500px; line-height: 1.9; }
  .overlay-btn { font-family:'Orbitron',sans-serif; font-size:0.8rem; letter-spacing:0.2em; background:transparent; padding:14px 32px; border-radius:3px; cursor:pointer; transition:all 0.15s; }
  .overlay-btn.green-btn { border:2px solid var(--green); color:var(--green); text-shadow:var(--glow); box-shadow:var(--glow); }
  .overlay-btn.green-btn:hover { background:#00ff9f22; }
  .overlay-btn.amber-btn { border:2px solid var(--amber); color:var(--amber); text-shadow:var(--amber-glow); box-shadow:var(--amber-glow); }
  .overlay-btn.amber-btn:hover { background:#ffaa0022; }

  /* ── END SCREEN ── */
  #endScreen { min-height: 80vh; justify-content: center; gap: 28px; text-align: center; }
  .end-title { font-family:'Orbitron',sans-serif; font-weight:900; font-size:clamp(2rem,5vw,3rem); letter-spacing:0.2em; }
  .end-title.victory { color:var(--green); text-shadow:0 0 30px #00ff9f,0 0 60px #00ff9f66; }
  .end-title.defeat  { color:var(--red);   text-shadow:0 0 30px #ff3355,0 0 60px #ff335566; }
  .end-stats { background:var(--panel); border:1px solid var(--border); border-radius:6px; padding:28px 40px; display:flex; flex-direction:column; gap:14px; min-width:340px; }
  .end-stat { display:flex; justify-content:space-between; align-items:baseline; gap:24px; }
  .end-stat-label { font-size:0.75rem; letter-spacing:0.2em; color:var(--muted); }
  .end-stat-value { font-family:'Orbitron',sans-serif; font-size:1.1rem; color:var(--green); text-shadow:var(--glow); }
  .end-stat-value.red { color:var(--red); text-shadow:var(--red-glow); }
  .end-divider { border:none; border-top:1px solid var(--border); }

  @media (max-width:680px) {
    .main-layout{grid-template-columns:1fr;}
    .battle-bar{grid-template-columns:1fr 1fr;}
    .round-badge{display:none;}
    .map-container{height:240px;}
  }

  /* ── DEBUG MODE ── */
  .debug-world-btn {
    font-family: 'Orbitron', sans-serif; font-size: 0.75rem; letter-spacing: 0.15em;
    background: transparent; border: 1px solid; padding: 10px 20px;
    border-radius: 3px; cursor: pointer; transition: all 0.15s; min-width: 120px;
  }
  .debug-world-btn:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); }
</style>
</head>
<body>

<!-- ══════ TITLE SCREEN ══════ -->
<div class="screen active" id="titleScreen">
  <div class="title-logo">Same<br>Wavelength</div>
  <div class="title-sub">Synth Lab · Signal Combat</div>

  <svg class="title-sine" viewBox="0 0 500 40" preserveAspectRatio="none">
    <path d="M0,20 C15,0 15,40 30,20 C45,0 45,40 60,20 C75,0 75,40 90,20 C105,0 105,40 120,20 C135,0 135,40 150,20 C165,0 165,40 180,20 C195,0 195,40 210,20 C225,0 225,40 240,20 C255,0 255,40 270,20 C285,0 285,40 300,20 C315,0 315,40 330,20 C345,0 345,40 360,20 C375,0 375,40 390,20 C405,0 405,40 420,20 C435,0 435,40 450,20 C465,0 465,40 480,20 C495,0 495,40 500,20"
      fill="none" stroke="#00ff9f" stroke-width="1.5"/>
  </svg>

  <div class="instructions">
    <h3>Mission Briefing</h3>
    An alien fleet is advancing through the Saturn system. Your only weapon: <span class="hl">signal matching</span>.<br><br>
    Each wave, the enemy broadcasts an encrypted signal. Tune your parameters to <span class="hl">match the target waveform</span> exactly, then fire.<br><br>
    A <span class="hl">direct hit</span> destroys one enemy section. A <span class="warn">miss on your first shot</span> costs you 1 HP — but earns a second shot for a glancing hit.<br><br>
    You begin at <span class="hl">Titan</span> with limited controls. Defeat each boss to advance and unlock new parameters.<br><br>
    <span class="warn">Lose all HP and your ship is restored — but you restart the level. Cleared levels stay unlocked.</span>
  </div>

  <button class="big-btn" onclick="showMapScreen()">Launch Mission</button>
  <div style="font-size:0.65rem;color:#2a3a2a;letter-spacing:0.15em;margin-top:-12px;">v0.28</div>
  <button onclick="if(confirm('Reset all progress?')){resetProgress();showMapScreen();}" style="font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:#2a2a4a;background:transparent;border:none;cursor:pointer;letter-spacing:0.15em;margin-top:-8px;">Reset Progress</button>
</div>

<!-- ══════ WORLD MAP SCREEN ══════ -->
<div class="screen" id="mapScreen">
  <div style="display:flex;justify-content:space-between;align-items:center;width:100%;max-width:800px;">
    <div class="map-title">Saturn System — Mission Map</div>
    <button class="map-menu-btn" onclick="showScreen('titleScreen')">Main Menu</button>
  </div>

  <div class="map-hp-row">
    <span class="map-hp-label">Hull Integrity</span>
    <div id="mapPlayerHP" style="display:flex;gap:5px;"></div>
  </div>

  <div class="map-container">
    <svg class="map-svg" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
      <!-- Stars -->
      <g opacity="0.5">
        <circle cx="50"  cy="30"  r="1"   fill="white"/>
        <circle cx="130" cy="65"  r="0.8" fill="white"/>
        <circle cx="230" cy="22"  r="1.2" fill="white"/>
        <circle cx="320" cy="75"  r="0.7" fill="white"/>
        <circle cx="415" cy="18"  r="1"   fill="white"/>
        <circle cx="510" cy="58"  r="0.9" fill="white"/>
        <circle cx="605" cy="28"  r="1.1" fill="white"/>
        <circle cx="710" cy="72"  r="0.8" fill="white"/>
        <circle cx="760" cy="38"  r="1"   fill="white"/>
        <circle cx="75"  cy="210" r="0.9" fill="white"/>
        <circle cx="165" cy="250" r="1"   fill="white"/>
        <circle cx="360" cy="230" r="0.8" fill="white"/>
        <circle cx="555" cy="210" r="1.2" fill="white"/>
        <circle cx="660" cy="265" r="0.7" fill="white"/>
        <circle cx="762" cy="185" r="1"   fill="white"/>
        <circle cx="425" cy="268" r="0.9" fill="white"/>
        <circle cx="290" cy="150" r="0.7" fill="white"/>
        <circle cx="490" cy="140" r="0.8" fill="white"/>
      </g>
      <!-- Curved path -->
      <path d="M 100,200 C 200,200 220,100 340,110 C 440,118 460,220 565,200 C 648,184 668,104 700,104"
        fill="none" stroke="#1a3a2a" stroke-width="3" stroke-dasharray="8,6"/>
      <!-- World nodes rendered by JS -->
      <g id="worldNodes"></g>
    </svg>
  </div>
</div>

<!-- ══════ DEBUG BAR ══════ -->
<div id="debugBar" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:400;
  background:#050510ee;border-top:1px solid #ff335544;padding:14px 24px;
  flex-direction:column;align-items:center;gap:10px;backdrop-filter:blur(6px);">
  <div style="font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:0.35em;color:#ff335599;">
    ⚠ DEBUG MODE — SELECT LEVEL
  </div>
  <div id="debugWorldList" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;"></div>
  <div style="font-size:0.6rem;color:#2a2a4a;letter-spacing:0.2em;">ESC or Shift+` to close</div>
</div>

<!-- ══════ GAME SCREEN ══════ -->
<div class="screen" id="gameScreen">

  <div class="game-header">
    <div style="display:flex;align-items:baseline;gap:16px;">
      <h1>Same Wavelength</h1>
      <span class="world-badge" id="worldBadge"></span>
    </div>
    <span style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--muted);opacity:0.8;letter-spacing:0.15em;">v0.28</span>
  </div>

  <span id="targetFreqDisplay" style="display:none;"></span>

  <!-- Battle Bar -->
  <div class="battle-bar">
    <div class="ship-status">
      <div class="ship-label">Player</div>
      <div class="ship-svg-wrap">
        <svg width="90" height="64" viewBox="0 0 90 64">
          <polygon id="ps-body"   points="45,3 68,52 45,44 22,52"  fill="#041a10" stroke="#00ff9f" stroke-width="1.5"/>
          <polygon id="ps-lwing"  points="22,52 2,62 18,40"         fill="#031208" stroke="#00cc77" stroke-width="1"/>
          <polygon id="ps-rwing"  points="68,52 88,62 72,40"         fill="#031208" stroke="#00cc77" stroke-width="1"/>
          <ellipse id="ps-engine" cx="45" cy="49" rx="9" ry="4"     fill="#00ff9f33" stroke="#00ff9f" stroke-width="1"/>
          <ellipse cx="45" cy="22" rx="5" ry="8" fill="#00ff9f15" stroke="#00ff9f88" stroke-width="1"/>
          <circle  cx="45" cy="20" r="2.5" fill="#00ff9f" opacity="0.7"/>
        </svg>
      </div>
      <div class="health-pips" id="playerHP"></div>
    </div>

    <div style="text-align:center;min-width:90px;">
      <div class="round-badge" id="roundBadge">Wave 1</div>
      <div style="font-size:2rem;margin:6px 0;" id="battleIcon">·</div>
      <div style="font-size:0.6rem;color:var(--muted);letter-spacing:0.08em;max-width:110px;" id="battleMsg"></div>
    </div>

    <div class="ship-status enemy" id="enemyPanel" style="border-color:#ff335544;">
      <div class="ship-label" id="enemyLabel" style="color:#ff335577;">Enemy</div>
      <div class="ship-svg-wrap">
        <svg width="110" height="72" viewBox="0 0 110 72">
          <ellipse id="al-hull" cx="55" cy="46" rx="48" ry="16" fill="#1a0407" stroke="#ff3355" stroke-width="1.5"/>
          <ellipse id="al-dome" cx="55" cy="30" rx="24" ry="18" fill="#100205" stroke="#ff3355" stroke-width="1.2"/>
          <ellipse id="al-lpod" cx="14" cy="50" rx="11" ry="7"  fill="#1a0407" stroke="#ff3355" stroke-width="1"/>
          <ellipse id="al-rpod" cx="96" cy="50" rx="11" ry="7"  fill="#1a0407" stroke="#ff3355" stroke-width="1"/>
          <ellipse cx="55" cy="30" rx="9" ry="7" fill="#ff335522"/>
          <ellipse cx="55" cy="30" rx="4" ry="4" fill="#ff3355" opacity="0.85"/>
          <circle cx="36" cy="48" r="2.5" fill="#ff335555"/>
          <circle cx="55" cy="51" r="2.5" fill="#ff335555"/>
          <circle cx="74" cy="48" r="2.5" fill="#ff335555"/>
        </svg>
      </div>
      <div class="health-pips" id="alienHP"></div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main-layout">
    <div class="panel scope-wrap">
      <div class="panel-label">Oscilloscope</div>
      <svg class="scope-sine-border" viewBox="0 0 400 12" preserveAspectRatio="none">
        <path d="M0,6 C12.5,0 12.5,12 25,6 C37.5,0 37.5,12 50,6 C62.5,0 62.5,12 75,6 C87.5,0 87.5,12 100,6 C112.5,0 112.5,12 125,6 C137.5,0 137.5,12 150,6 C162.5,0 162.5,12 175,6 C187.5,0 187.5,12 200,6 C212.5,0 212.5,12 225,6 C237.5,0 237.5,12 250,6 C262.5,0 262.5,12 275,6 C287.5,0 287.5,12 300,6 C312.5,0 312.5,12 325,6 C337.5,0 337.5,12 350,6 C362.5,0 362.5,12 375,6 C387.5,0 387.5,12 400,6"
          fill="none" stroke="#00ff9f" stroke-width="1"/>
      </svg>
      <canvas id="scope" height="300"></canvas>
      <div class="scope-overlay"></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-line" style="background:#00ff9f;box-shadow:0 0 4px #00ff9f;"></div><span style="color:#00ff9f88;">Target signal</span></div>
        <div class="legend-item"><div class="legend-line" style="background:#ffaa00;box-shadow:0 0 4px #ffaa00;"></div><span style="color:#ffaa0088;">Your shot</span></div>
        <div class="legend-item"><div class="legend-line" style="background:#ff335588;border-top:2px dashed #ff335588;height:0;"></div><span>Shot 1 (miss)</span></div>
      </div>
      <div class="target-hint" id="targetHint"></div>
      <div class="equation-bar" style="border-color:#ffaa0044;box-shadow:0 0 20px #ffaa0011,inset 0 0 30px #0d0a00;">
        <div class="equation-bar-label" style="color:#ffaa0077;">Your Signal</div>
        <div class="equation-bar-text" id="equationDisplay" style="color:var(--amber);text-shadow:var(--amber-glow);"></div>
      </div>
      <div id="interferenceDisplay" style="display:none;"></div>
      <div class="equation-bar shot1-bar" id="shot1Bar" style="display:none;border-color:#ff335544;box-shadow:0 0 20px #ff335511,inset 0 0 30px #1a0008;">
        <div class="equation-bar-label" style="color:#ff335588;">Shot 1 (miss)</div>
        <div class="equation-bar-text" id="shot1Display" style="color:#ff3355;text-shadow:0 0 10px #ff335588,0 0 20px #ff335544;font-size:clamp(1rem,2.2vw,1.5rem);"></div>
      </div>
    </div>

    <div class="controls-panel">
      <div class="panel">
        <div class="panel-label">Parameters</div>
        <div class="param-block" id="ampBlock">
          <div class="param-header"><span class="param-name">Amplitude</span><span class="param-formula">A·sin(...)</span></div>
          <div class="param-value" id="ampVal">1</div>
          <input type="range" id="ampSlider" min="1" max="5" step="1" value="1">
          <div class="range-ends"><span>1</span><span>5</span></div>
        </div>
        <div class="param-block" id="freqBlock">
          <div class="param-header"><span class="param-name">Frequency</span><span class="param-formula">sin(B·x)</span></div>
          <div class="param-value" id="freqVal">1</div>
          <input type="range" id="freqSlider" min="0" max="6" step="1" value="3">
          <div class="range-ends"><span>¼×</span><span>4×</span></div>
        </div>
        <div class="param-block" id="phaseBlock">
          <div class="param-header"><span class="param-name">Phase Shift</span><span class="param-formula">sin(Bx + hπ)</span></div>
          <div class="param-value" id="phaseVal">+0</div>
          <input type="range" id="phaseSlider" min="-4" max="4" step="0.5" value="0">
          <div class="range-ends"><span>−4π</span><span>+4π</span></div>
        </div>
        <div class="param-block" id="shiftBlock">
          <div class="param-header"><span class="param-name">Vertical Shift</span><span class="param-formula">sin(...)+D</span></div>
          <div class="param-value" id="shiftVal">+0</div>
          <input type="range" id="shiftSlider" min="-3" max="3" step="1" value="0">
          <div class="range-ends"><span>−3</span><span>+3</span></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-label">Result</div>
        <div class="feedback" id="feedback">
          <div class="feedback-score" style="color:#2a4a3a;font-size:0.7rem;">—</div>
        </div>
        <div class="attempts-row">
          <span>Shots</span>
          <div class="attempt-pips" id="pips"></div>
        </div>
      </div>

      <button class="attempt-btn" id="attemptBtn" onclick="doAttempt()">Fire</button>
      <button class="quit-btn" onclick="showQuitConfirm()">Quit Mission</button>
      <div class="quit-confirm" id="quitConfirm">
        <p>Abandon mission?<br>Your run will end.</p>
        <div class="quit-confirm-btns">
          <button class="quit-yes" onclick="confirmQuit()">Quit</button>
          <button class="quit-no"  onclick="hideQuitConfirm()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════ END SCREEN ══════ -->
<div class="screen" id="endScreen">
  <div class="end-title" id="endTitle">Mission Complete</div>
  <div style="font-size:0.8rem;letter-spacing:0.15em;color:var(--muted);margin-top:-12px;" id="endSubtitle"></div>
  <div class="end-stats" id="endStats"></div>
  <button class="big-btn" onclick="returnToTitle()">Return to Base</button>
</div>

<!-- ══════ BRIEFING OVERLAY ══════ -->
<div class="overlay" id="briefingOverlay">
  <div class="overlay-title win" id="briefingTitle" style="font-size:clamp(1.2rem,3vw,2rem);"></div>
  <div id="briefingBody" style="
    font-size:clamp(0.9rem,2vw,1.1rem); color:var(--text); letter-spacing:0.05em;
    max-width:560px; line-height:2; text-align:left;
    background:var(--panel); border:1px solid var(--border);
    border-radius:6px; padding:24px 32px;
  "></div>
  <div style="display:flex;gap:16px;">
    <button class="overlay-btn green-btn" id="briefingBeginBtn">Begin Mission</button>
    <button class="overlay-btn" id="briefingBackBtn" style="display:none;border-color:#2a3a2a;color:var(--muted);" onclick="document.getElementById('briefingOverlay').classList.remove('active');showMapScreen();">← Back to Map</button>
  </div>
</div>

<!-- ══════ WORLD CLEAR OVERLAY ══════ -->
<div class="overlay" id="worldClearOverlay">
  <div class="overlay-title win" id="worldClearTitle">World Cleared!</div>
  <div class="overlay-sub" id="worldClearSub"></div>
  <button class="overlay-btn amber-btn" onclick="returnToMap()">Return to Map</button>
</div>

<script>
// ═══════════════════════════════════════════════
// WORLD DEFINITIONS
// ═══════════════════════════════════════════════
const FREQ_VALUES = [1/4, 1/3, 1/2, 1, 2, 3, 4];
const FREQ_LABELS = ['¼','⅓','½','1','2','3','4'];

const WORLDS = [
  {
    id:0, name:'Titan', color:'#ffaa00', bossHP:3, maxAttempts:2,
    unlocks:{amp:true, freq:true, phase:false, shift:true},
    hasCosine:false, hasInterference:false,
    briefing:{
      title:'Titan — Signal Basics',
      body:`Match the <span class="hl">Amplitude</span>, <span class="hl">Frequency</span>, and <span class="hl">Vertical Shift</span> of the graph shown to lock on with your equation.\n\n<span class="hl eq">f(x) = A·sin(Bx) + D</span>\n\nA miss on your first attempt costs 1 HP but gives a second shot. Hitting either shot takes 1 HP from the enemy.`
    },
    generate(){
      const A=[1,2,3,4,5], B=pick(FREQ_VALUES), D=[-3,-2,-1,0,1,2,3];
      return { A:pick(A), B, h:0, D:pick(D), isCos:false };
    }
  },
  {
    id:1, name:'Enceladus', color:'#00aaff', bossHP:4, maxAttempts:2,
    unlocks:{amp:true, freq:true, phase:true, shift:true},
    hasCosine:false, hasInterference:false,
    briefing:{
      title:'Enceladus — Phase Shift',
      body:`New control unlocked: <span class="hl">Phase Shift (h)</span>. The enemy signal may now be horizontally shifted along the x-axis.\n\nYour equation:\n<span class="hl eq">f(x) = A·sin(Bx + h) + D</span>\n\nWatch the peak positions carefully — they reveal the phase.`
    },
    generate(){
      const A=[1,2,3,4,5], H=[-4,-3,-2,-1,0,1,2,3,4], D=[-3,-2,-1,0,1,2,3];
      return { A:pick(A), B:pick(FREQ_VALUES), h:pick(H), D:pick(D), isCos:false };
    }
  },
  {
    id:2, name:'Mimas', color:'#aa55ff', bossHP:4, maxAttempts:2,
    unlocks:{amp:true, freq:true, phase:true, shift:true},
    hasCosine:true, hasInterference:false,
    briefing:{
      title:'Mimas — Sine & Cosine',
      body:`Each wave will show you a graph and tell you whether to use <span class="hl">sin</span> or <span class="hl">cos</span> — you can't switch. Your job is to find the right <span class="hl">Phase Shift</span> to make your equation match the graph.\n\nRemember: cosine starts at its peak, sine starts at zero:\n<span class="hl eq">cos(x) = sin(x + π/2)</span>\n\nAdjust the Phase Shift slider until the shape lines up.`
    },
    generate(){
      const A=[1,2,3,4,5], H=[-3,-2,-1,0,1,2,3], D=[-3,-2,-1,0,1,2,3];
      const isCos = Math.random()<0.5;
      return { A:pick(A), B:pick(FREQ_VALUES), h:pick(H), D:pick(D), isCos };
    }
  },
  {
    id:3, name:'Hyperion', color:'#ff3355', bossHP:5, maxAttempts:1,
    unlocks:{amp:true, freq:true, phase:true, shift:true},
    hasCosine:true, hasInterference:true,
    briefing:{
      title:'Hyperion — Interference',
      body:`One shot only. No second chances.\n\nSome waves require <span class="hl">constructive interference</span> — match the target exactly so your signals add together and amplify.\n\nOthers require <span class="warn">destructive interference</span> — match the target but shift phase by π so your signals cancel each other out.\n\nThe objective will be shown below your equation each wave.\n\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 180" style="width:100%;max-width:480px;display:block;margin:12px auto 0;background:#020c07;border:1px solid #1a3a2a;border-radius:4px;font-family:Share Tech Mono,monospace;">
  <!-- Labels -->
  <text x="120" y="22" fill="#00ff9f" font-size="14" letter-spacing="2" text-anchor="middle" opacity="0.9">CONSTRUCTIVE</text>
  <text x="360" y="22" fill="#ff3355" font-size="14" letter-spacing="2" text-anchor="middle" opacity="0.9">DESTRUCTIVE</text>
  <!-- Divider -->
  <line x1="240" y1="8" x2="240" y2="172" stroke="#1a3a2a" stroke-width="1"/>
  <!-- Grid lines left -->
  <line x1="12" y1="90" x2="228" y2="90" stroke="#0a200f" stroke-width="1"/>
  <!-- Grid lines right -->
  <line x1="252" y1="90" x2="468" y2="90" stroke="#0a200f" stroke-width="1"/>

  <!-- CONSTRUCTIVE: target (green) -->
  <path d="M12,90 C34,50 56,50 78,90 C100,130 122,130 144,90 C166,50 188,50 210,90 C220,110 228,118 228,118"
        fill="none" stroke="#00ff9f" stroke-width="2" opacity="0.9"/>
  <!-- CONSTRUCTIVE: player (amber, same phase) -->
  <path d="M12,90 C34,50 56,50 78,90 C100,130 122,130 144,90 C166,50 188,50 210,90 C220,110 228,118 228,118"
        fill="none" stroke="#ffaa00" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.7"/>
  <!-- CONSTRUCTIVE: result (white, double amplitude) -->
  <path d="M12,90 C34,10 56,10 78,90 C100,170 122,170 144,90 C166,10 188,10 210,90"
        fill="none" stroke="#ffffff" stroke-width="2" opacity="0.5"/>
  <!-- Constructive labels -->
  <text x="14" y="36" fill="#00ff9f" font-size="8" opacity="0.8">target</text>
  <text x="14" y="47" fill="#ffaa00" font-size="8" opacity="0.8">your signal</text>
  <text x="14" y="58" fill="#ffffff" font-size="8" opacity="0.5">result ×2</text>

  <!-- DESTRUCTIVE: target (green) -->
  <path d="M252,90 C274,50 296,50 318,90 C340,130 362,130 384,90 C406,50 428,50 450,90 C460,110 468,118 468,118"
        fill="none" stroke="#00ff9f" stroke-width="2" opacity="0.9"/>
  <!-- DESTRUCTIVE: player (amber, inverted — π shift) -->
  <path d="M252,90 C274,130 296,130 318,90 C340,50 362,50 384,90 C406,130 428,130 450,90 C460,70 468,62 468,62"
        fill="none" stroke="#ffaa00" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.7"/>
  <!-- DESTRUCTIVE: result (flat line) -->
  <line x1="252" y1="90" x2="468" y2="90" stroke="#ffffff" stroke-width="2" opacity="0.5"/>
  <!-- Destructive labels -->
  <text x="254" y="36" fill="#00ff9f" font-size="8" opacity="0.8">target</text>
  <text x="254" y="47" fill="#ffaa00" font-size="8" opacity="0.8">your signal (+π)</text>
  <text x="254" y="58" fill="#ffffff" font-size="8" opacity="0.5">result = 0</text>
</svg>`
    },
    generate(){
      const A=[1,2,3,4,5], H=[-3,-2,-1,0,1,2,3], D=[-2,-1,0,1,2];
      const isCos = Math.random()<0.5;
      const interference = Math.random()<0.5 ? 'constructive' : 'destructive';
      return { A:pick(A), B:pick(FREQ_VALUES), h:pick(H), D:pick(D), isCos, interference };
    }
  }
];

// Map node positions (in SVG viewBox 800×300)
const NODE_POS = [
  {x:100, y:200},
  {x:340, y:110},
  {x:565, y:200},
  {x:700, y:104}
];

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

// ═══════════════════════════════════════════════
// CANVAS & SLIDERS
// ═══════════════════════════════════════════════
const canvas    = document.getElementById('scope');
const ctx       = canvas.getContext('2d');
const ampSlider   = document.getElementById('ampSlider');
const freqSlider  = document.getElementById('freqSlider');
const phaseSlider = document.getElementById('phaseSlider');
const shiftSlider = document.getElementById('shiftSlider');

// ═══════════════════════════════════════════════
// GAME PARAMETERS
// ═══════════════════════════════════════════════
const MAX_PLAYER_HP = 3;

// ═══════════════════════════════════════════════
// PERSISTENT PROGRESS (localStorage)
// ═══════════════════════════════════════════════
function loadProgress(){
  try {
    const raw = localStorage.getItem('swProgress');
    if(raw) return JSON.parse(raw);
  } catch(e){}
  return { unlocked:[0], cleared:[] };
}
function saveProgress(){
  try {
    localStorage.setItem('swProgress', JSON.stringify({ unlocked:[...worldsUnlocked], cleared:[...worldsCleared] }));
  } catch(e){}
}
function resetProgress(){
  try { localStorage.removeItem('swProgress'); } catch(e){}
  worldsUnlocked = new Set([0]);
  worldsCleared  = new Set();
  briefingsSeen  = new Set();
  currentWorld   = 0;
}

const _saved = loadProgress();

// ═══════════════════════════════════════════════
// RUN STATE (persists across worlds)
// ═══════════════════════════════════════════════
let playerHP      = MAX_PLAYER_HP;
let currentWorld  = 0;
let worldsUnlocked = new Set(_saved.unlocked || [0]);
let worldsCleared  = new Set(_saved.cleared  || []);
let briefingsSeen  = new Set([...(worldsCleared)]); // already-cleared worlds skip briefing

// ═══════════════════════════════════════════════
// BATTLE STATE (resets each world)
// ═══════════════════════════════════════════════
let alienHP=0, alienMaxHP=0;
let currentWave=1, attemptsUsed=0, maxAttempts=2;
let waveActive=true, firstShotMissed=false, firstShotParams=null, showCurrentAim=false;
let aimTimer=null;
let targetA, targetB, targetC, targetD, targetCN;
let targetIsCos=false;          // World 2+: was target generated as cosine?
let interferenceMode=null;      // World 3: 'constructive' | 'destructive' | null
let playerA, playerB, playerC, playerD;

// ═══════════════════════════════════════════════
// SCREEN NAV
// ═══════════════════════════════════════════════
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function returnToTitle(){
  playerHP = MAX_PLAYER_HP;
  showScreen('titleScreen');
}

function showMapScreen(){
  renderMap();
  renderMapHP();
  showScreen('mapScreen');
}

function showBriefing(worldIdx, debugPreview=false){
  const world = WORLDS[worldIdx];
  const b = world.briefing;
  const overlay = document.getElementById('briefingOverlay');
  const titleEl = document.getElementById('briefingTitle');
  const bodyEl  = document.getElementById('briefingBody');
  const btnEl   = document.getElementById('briefingBeginBtn');
  const backBtn = document.getElementById('briefingBackBtn');

  titleEl.textContent = b.title;
  titleEl.style.color = world.color;
  titleEl.style.textShadow = `0 0 20px ${world.color}, 0 0 40px ${world.color}66`;

  // Split on SVG blocks so the replace chains don't mangle them
  const svgSplit = b.body.split(/(<svg[\s\S]*?<\/svg>)/);
  const processedParts = svgSplit.map((part, i) => {
    if(part.startsWith('<svg')) return part; // pass SVG through raw
    return part
      .replace(/\n/g,'<br>')
      .replace(/<span class="hl eq">(.*?)<\/span>/g,
        '<span style="color:var(--green);font-family:\'Share Tech Mono\',monospace;font-size:1.1em;display:inline-block;margin:4px 0;text-shadow:var(--glow);">$1</span>')
      .replace(/<span class="hl">(.*?)<\/span>/g,
        '<span style="color:var(--green);">$1</span>')
      .replace(/<span class="warn">(.*?)<\/span>/g,
        '<span style="color:var(--red);">$1</span>');
  });
  bodyEl.innerHTML = processedParts.join('');

  backBtn.style.display = debugPreview ? 'inline-flex' : 'none';

  btnEl.onclick = () => {
    overlay.classList.remove('active');
    enterWorldDirect(worldIdx);
  };

  overlay.classList.add('active');
}

function returnToMap(){
  document.getElementById('worldClearOverlay').classList.remove('active');
  renderMap();
  renderMapHP();
  showScreen('mapScreen');
}

// ═══════════════════════════════════════════════
// WORLD MAP
// ═══════════════════════════════════════════════
// ── Moon SVG content generators (drawn inside map nodes) ──
function moonContent(ns, worldIdx, cx, cy, r){
  const g = document.createElementNS(ns,'g');
  const clip = document.createElementNS(ns,'clipPath');
  const clipId = `moonClip${worldIdx}`;
  clip.setAttribute('id', clipId);
  const clipCirc = document.createElementNS(ns,'circle');
  clipCirc.setAttribute('cx',cx); clipCirc.setAttribute('cy',cy); clipCirc.setAttribute('r',r-2);
  clip.appendChild(clipCirc);
  g.appendChild(clip);

  const wrap = document.createElementNS(ns,'g');
  wrap.setAttribute('clip-path',`url(#${clipId})`);

  if(worldIdx===0){
    // TITAN — orange/amber hazy sphere with atmospheric banding
    const base=document.createElementNS(ns,'circle');
    base.setAttribute('cx',cx); base.setAttribute('cy',cy); base.setAttribute('r',r-2);
    base.setAttribute('fill','#7a4010'); wrap.appendChild(base);
    // Haze layers
    [[0,'#c8620a',0.5],[1,'#d97820',0.35],[-3,'#b05010',0.3],[4,'#e08830',0.2]].forEach(([dy,col,op])=>{
      const e=document.createElementNS(ns,'ellipse');
      e.setAttribute('cx',cx); e.setAttribute('cy',cy+dy); e.setAttribute('rx',r-2); e.setAttribute('ry',3+Math.abs(dy));
      e.setAttribute('fill',col); e.setAttribute('opacity',op); wrap.appendChild(e);
    });
    // Atmospheric glow rim
    const rim=document.createElementNS(ns,'circle');
    rim.setAttribute('cx',cx); rim.setAttribute('cy',cy); rim.setAttribute('r',r-2);
    rim.setAttribute('fill','none'); rim.setAttribute('stroke','#ffa030'); rim.setAttribute('stroke-width','4'); rim.setAttribute('opacity','0.4');
    wrap.appendChild(rim);
    // Highlight
    const hl=document.createElementNS(ns,'ellipse');
    hl.setAttribute('cx',cx-5); hl.setAttribute('cy',cy-5); hl.setAttribute('rx',5); hl.setAttribute('ry',3);
    hl.setAttribute('fill','#ffcc88'); hl.setAttribute('opacity','0.25'); wrap.appendChild(hl);

  } else if(worldIdx===1){
    // ENCELADUS — bright white icy sphere, blue cracks
    const base=document.createElementNS(ns,'circle');
    base.setAttribute('cx',cx); base.setAttribute('cy',cy); base.setAttribute('r',r-2);
    base.setAttribute('fill','#cce8f0'); wrap.appendChild(base);
    // Ice cracks
    [[-4,-6,8,4],[-2,2,-5,8],[3,-3,6,-7],[0,5,-8,2]].forEach(([x1,y1,x2,y2])=>{
      const l=document.createElementNS(ns,'line');
      l.setAttribute('x1',cx+x1); l.setAttribute('y1',cy+y1); l.setAttribute('x2',cx+x2); l.setAttribute('y2',cy+y2);
      l.setAttribute('stroke','#5090b0'); l.setAttribute('stroke-width','1.2'); l.setAttribute('opacity','0.7');
      wrap.appendChild(l);
    });
    // Geyser hint at south
    const gy=document.createElementNS(ns,'ellipse');
    gy.setAttribute('cx',cx); gy.setAttribute('cy',cy+r-4); gy.setAttribute('rx',4); gy.setAttribute('ry',2);
    gy.setAttribute('fill','#aaddee'); gy.setAttribute('opacity','0.5'); wrap.appendChild(gy);
    // Specular highlight
    const hl=document.createElementNS(ns,'ellipse');
    hl.setAttribute('cx',cx-4); hl.setAttribute('cy',cy-5); hl.setAttribute('rx',6); hl.setAttribute('ry',4);
    hl.setAttribute('fill','white'); hl.setAttribute('opacity','0.5'); wrap.appendChild(hl);

  } else if(worldIdx===2){
    // MIMAS — grey, with massive Herschel crater (Death Star)
    const base=document.createElementNS(ns,'circle');
    base.setAttribute('cx',cx); base.setAttribute('cy',cy); base.setAttribute('r',r-2);
    base.setAttribute('fill','#6a6a72'); wrap.appendChild(base);
    // Surface texture shading
    const shade=document.createElementNS(ns,'circle');
    shade.setAttribute('cx',cx+4); shade.setAttribute('cy',cy+3); shade.setAttribute('r',r-4);
    shade.setAttribute('fill','#505058'); shade.setAttribute('opacity','0.4'); wrap.appendChild(shade);
    // Small craters
    [[-5,-4,2],[4,-6,1.5],[6,5,1.5],[-3,5,2]].forEach(([dx,dy,cr])=>{
      const c2=document.createElementNS(ns,'circle');
      c2.setAttribute('cx',cx+dx); c2.setAttribute('cy',cy+dy); c2.setAttribute('r',cr);
      c2.setAttribute('fill','none'); c2.setAttribute('stroke','#888898'); c2.setAttribute('stroke-width','0.8'); c2.setAttribute('opacity','0.6');
      wrap.appendChild(c2);
    });
    // Herschel crater — the big one, slightly off-center
    const hOuter=document.createElementNS(ns,'circle');
    hOuter.setAttribute('cx',cx-5); hOuter.setAttribute('cy',cy-2); hOuter.setAttribute('r',7);
    hOuter.setAttribute('fill','#454550'); hOuter.setAttribute('stroke','#909098'); hOuter.setAttribute('stroke-width','1.5'); hOuter.setAttribute('opacity','0.9');
    wrap.appendChild(hOuter);
    const hInner=document.createElementNS(ns,'circle');
    hInner.setAttribute('cx',cx-5); hInner.setAttribute('cy',cy-2); hInner.setAttribute('r',2.5);
    hInner.setAttribute('fill','#8888a0'); hInner.setAttribute('opacity','0.8');
    wrap.appendChild(hInner);
    // Highlight
    const hl=document.createElementNS(ns,'ellipse');
    hl.setAttribute('cx',cx-6); hl.setAttribute('cy',cy-7); hl.setAttribute('rx',4); hl.setAttribute('ry',2.5);
    hl.setAttribute('fill','white'); hl.setAttribute('opacity','0.2'); wrap.appendChild(hl);

  } else if(worldIdx===3){
    // HYPERION — irregular spongy dark shape, chaotic pits
    const base=document.createElementNS(ns,'circle');
    base.setAttribute('cx',cx); base.setAttribute('cy',cy); base.setAttribute('r',r-2);
    base.setAttribute('fill','#2d1e10'); wrap.appendChild(base);
    // Irregular outline suggestion via blobs
    [[0,-10,9,6,0.5],[8,-4,7,5,0.4],[-8,-2,6,7,0.4],[4,8,8,5,0.45],[-5,7,6,4,0.4]].forEach(([dx,dy,rx,ry,op])=>{
      const e=document.createElementNS(ns,'ellipse');
      e.setAttribute('cx',cx+dx); e.setAttribute('cy',cy+dy); e.setAttribute('rx',rx); e.setAttribute('ry',ry);
      e.setAttribute('fill','#3d2a15'); e.setAttribute('opacity',op); wrap.appendChild(e);
    });
    // Deep pits
    [[-4,-3,4],[-1,5,3.5],[6,-1,3],[2,-7,2.5],[-7,3,2.5],[5,6,2]].forEach(([dx,dy,pr])=>{
      const pit=document.createElementNS(ns,'circle');
      pit.setAttribute('cx',cx+dx); pit.setAttribute('cy',cy+dy); pit.setAttribute('r',pr);
      pit.setAttribute('fill','#0a0604'); pit.setAttribute('stroke','#4a3020'); pit.setAttribute('stroke-width','0.8'); pit.setAttribute('opacity','0.9');
      wrap.appendChild(pit);
    });
    // Rusty highlight
    const hl=document.createElementNS(ns,'ellipse');
    hl.setAttribute('cx',cx-4); hl.setAttribute('cy',cy-6); hl.setAttribute('rx',5); hl.setAttribute('ry',3);
    hl.setAttribute('fill','#8a5530'); hl.setAttribute('opacity','0.25'); wrap.appendChild(hl);
  }

  g.appendChild(wrap);
  return g;
}

function renderMap(){
  const g = document.getElementById('worldNodes');
  g.innerHTML = '';

  WORLDS.forEach((world, i) => {
    const pos      = NODE_POS[i];
    const cleared  = worldsCleared.has(i);
    const unlocked = worldsUnlocked.has(i);
    const locked   = !unlocked;
    const isCur    = (i === currentWorld) && unlocked;

    const r = isCur ? 28 : 24;
    const ns = 'http://www.w3.org/2000/svg';
    const grp = document.createElementNS(ns,'g');

    if(unlocked){
      grp.style.cursor = 'pointer';
      grp.onclick = () => enterWorld(i);
    } else {
      grp.style.cursor = 'default';
    }

    // Pulse ring for current world
    if(isCur){
      const ring = document.createElementNS(ns,'circle');
      ring.setAttribute('cx',pos.x); ring.setAttribute('cy',pos.y);
      ring.setAttribute('r',r+10);
      ring.setAttribute('fill','none');
      ring.setAttribute('stroke',world.color);
      ring.setAttribute('stroke-width','1.5');
      ring.setAttribute('opacity','0.25');
      grp.appendChild(ring);
    }

    // Main circle background
    const circ = document.createElementNS(ns,'circle');
    circ.setAttribute('cx',pos.x); circ.setAttribute('cy',pos.y); circ.setAttribute('r',r);
    if(locked){
      circ.setAttribute('fill','#08080f');
      circ.setAttribute('stroke','#1a1a3a');
      circ.setAttribute('stroke-width','1.5');
    } else if(cleared){
      circ.setAttribute('fill','#090914');
      circ.setAttribute('stroke','#2a8a2a');
      circ.setAttribute('stroke-width','2');
    } else {
      circ.setAttribute('fill','#090914');
      circ.setAttribute('stroke',world.color);
      circ.setAttribute('stroke-width','2.5');
    }
    grp.appendChild(circ);

    // Moon illustration
    const moonGrp = moonContent(ns, i, pos.x, pos.y, r);
    if(locked) moonGrp.setAttribute('opacity','0.18');
    else moonGrp.setAttribute('opacity','1');
    grp.appendChild(moonGrp);

    // Cleared badge — small ✓ in corner, doesn't block the moon
    if(cleared){
      const ckBg=document.createElementNS(ns,'circle');
      ckBg.setAttribute('cx',pos.x+r-8); ckBg.setAttribute('cy',pos.y-r+8); ckBg.setAttribute('r',9);
      ckBg.setAttribute('fill','#003300'); ckBg.setAttribute('opacity','0.9');
      grp.appendChild(ckBg);
      const ck=document.createElementNS(ns,'text');
      ck.setAttribute('x',pos.x+r-8); ck.setAttribute('y',pos.y-r+13);
      ck.setAttribute('text-anchor','middle'); ck.setAttribute('font-size','11');
      ck.setAttribute('fill','#00ff9f'); ck.setAttribute('opacity','0.95');
      ck.textContent='✓';
      grp.appendChild(ck);
    }

    // Overlay for locked: dark veil + lock icon
    if(locked){
      const veil=document.createElementNS(ns,'circle');
      veil.setAttribute('cx',pos.x); veil.setAttribute('cy',pos.y); veil.setAttribute('r',r-2);
      veil.setAttribute('fill','#08080f'); veil.setAttribute('opacity','0.55');
      grp.appendChild(veil);
      const lk=document.createElementNS(ns,'text');
      lk.setAttribute('x',pos.x); lk.setAttribute('y',pos.y+6);
      lk.setAttribute('text-anchor','middle'); lk.setAttribute('font-size','14');
      lk.setAttribute('fill','#2a2a5a');
      lk.textContent='🔒';
      grp.appendChild(lk);
    }

    // HP dots for current world (shown as ring of dots around the circle)
    if(isCur){
      for(let h=0; h<world.bossHP; h++){
        const angle = (h/world.bossHP)*2*Math.PI - Math.PI/2;
        const dot = document.createElementNS(ns,'circle');
        dot.setAttribute('cx', pos.x + Math.cos(angle)*(r+8));
        dot.setAttribute('cy', pos.y + Math.sin(angle)*(r+8));
        dot.setAttribute('r','3');
        dot.setAttribute('fill',world.color);
        dot.setAttribute('opacity','0.6');
        grp.appendChild(dot);
      }
    }

    // World name label — bigger and brighter
    const textCol = locked ? '#2a2a5a' : cleared ? '#4aaa4a' : world.color;
    const lbl = document.createElementNS(ns,'text');
    lbl.setAttribute('x',pos.x); lbl.setAttribute('y',pos.y+r+18);
    lbl.setAttribute('text-anchor','middle');
    lbl.setAttribute('font-family','Orbitron,sans-serif');
    lbl.setAttribute('font-size','13'); lbl.setAttribute('fill',textCol);
    lbl.setAttribute('font-weight','700');
    lbl.setAttribute('letter-spacing','1.5');
    lbl.textContent = world.name;
    grp.appendChild(lbl);

    // Equation form hint for current world (shows general form based on unlocked params)
    if(isCur){
      const u = world.unlocks;
      const A = u.amp   ? 'A' : '1';
      const B = u.freq  ? 'B' : '';
      const h = u.phase ? '+h' : '';
      const D = u.shift ? '+D' : '';
      const inner = B ? `${B}x${h}` : `x${h}`;
      // For worlds with cosine possibility, show sin/cos
      const fnPart = world.hasCosine ? 'sin/cos' : 'sin';
      const eqStr = `f(x) = ${A}·${fnPart}(${inner})${D}`;
      // Extra note for interference
      const extraNote = world.hasInterference ? ' ± π' : '';

      const ph = document.createElementNS(ns,'text');
      ph.setAttribute('x',pos.x); ph.setAttribute('y',pos.y+r+34);
      ph.setAttribute('text-anchor','middle');
      ph.setAttribute('font-family','Share Tech Mono,monospace'); ph.setAttribute('font-size','11');
      ph.setAttribute('fill',world.color); ph.setAttribute('opacity','0.85');
      ph.textContent = eqStr + extraNote;
      grp.appendChild(ph);

      // 1-shot badge for Hyperion
      if(i===3){
        const badge = document.createElementNS(ns,'text');
        badge.setAttribute('x',pos.x); badge.setAttribute('y',pos.y+r+50);
        badge.setAttribute('text-anchor','middle');
        badge.setAttribute('font-family','monospace'); badge.setAttribute('font-size','9');
        badge.setAttribute('fill','#ff335588');
        badge.textContent='— 1 shot only —';
        grp.appendChild(badge);
      }
    }

    g.appendChild(grp);
  });
}

function renderMapHP(){
  const c = document.getElementById('mapPlayerHP');
  c.innerHTML='';
  for(let i=0;i<MAX_PLAYER_HP;i++){
    const p=document.createElement('div');
    p.className='hp-pip '+(i<playerHP?'alive-green':'dead');
    c.appendChild(p);
  }
}

// ═══════════════════════════════════════════════
// ENTER WORLD
// ═══════════════════════════════════════════════
function enterWorld(worldIdx){
  // Show briefing overlay first time entering each world
  if(!briefingsSeen.has(worldIdx)){
    briefingsSeen.add(worldIdx);
    showBriefing(worldIdx);
    return; // briefing's "Begin" button will call enterWorldDirect
  }
  enterWorldDirect(worldIdx);
}

function enterWorldDirect(worldIdx){
  currentWorld     = worldIdx;
  const world      = WORLDS[worldIdx];
  alienHP          = world.bossHP;
  alienMaxHP       = world.bossHP;
  currentWave      = 1;
  attemptsUsed     = 0;
  maxAttempts      = world.maxAttempts;
  waveActive       = true;
  firstShotMissed  = false;
  firstShotParams  = null;
  showCurrentAim   = false;
  targetIsCos      = false;
  interferenceMode = null;

  // Show/hide sliders
  document.getElementById('ampBlock').style.display   = world.unlocks.amp   ? '' : 'none';
  document.getElementById('freqBlock').style.display  = world.unlocks.freq  ? '' : 'none';
  document.getElementById('phaseBlock').style.display = world.unlocks.phase ? '' : 'none';
  document.getElementById('shiftBlock').style.display = world.unlocks.shift ? '' : 'none';

  // Badge
  const wb = document.getElementById('worldBadge');
  wb.textContent = world.name.toUpperCase();
  wb.style.color = world.color;

  // Enemy label color
  document.getElementById('enemyLabel').textContent  = world.name;
  document.getElementById('enemyLabel').style.color  = world.color+'aa';
  document.getElementById('enemyPanel').style.borderColor = world.color+'44';

  // Reset sliders
  ampSlider.value=1; freqSlider.value=3; phaseSlider.value=0; shiftSlider.value=0;

  generateTarget(); updateLabels(); buildPips();
  renderPlayerHP(); renderAlienHP(); updateWaveBadge();
  updateInterferenceDisplay();

  document.getElementById('attemptBtn').disabled=false;
  hideQuitConfirm();
  hideFirstShotBar();
  document.getElementById('feedback').innerHTML='<div class="feedback-score" style="color:#2a4a3a;font-size:0.7rem;">—</div>';
  document.getElementById('targetHint').textContent='';
  setBattle('·','');

  showScreen('gameScreen');
  resizeCanvas();
}

// ═══════════════════════════════════════════════
// TARGET GENERATION
// ═══════════════════════════════════════════════
function generateTarget(){
  const world = WORLDS[currentWorld];
  const t = world.generate();
  targetA      = t.A;
  targetB      = t.B;
  targetIsCos  = t.isCos || false;
  interferenceMode = t.interference || null;

  // targetCN: the h value (in π-multiples) the player must dial in
  // targetC:  radians used for drawing — same formula regardless of sin/cos
  //           because drawWave now uses the correct trig function
  targetCN = t.h;          // integer (half-integer not needed anymore)
  targetC  = t.h * Math.PI;
  targetD  = t.D;
}


// ═══════════════════════════════════════════════
// PLAYER VALUES & MATCH
// ═══════════════════════════════════════════════
function getPlayerValues(){
  const w = WORLDS[currentWorld];
  playerA = w.unlocks.amp   ? Number(ampSlider.value)               : 1;
  playerB = w.unlocks.freq  ? FREQ_VALUES[Number(freqSlider.value)] : 1;
  const h = w.unlocks.phase ? Number(phaseSlider.value)             : 0;
  playerC = h * Math.PI;  // h in π-multiples (may be half-integer for cosine)
  playerD = w.unlocks.shift ? Number(shiftSlider.value)             : 0;
}

function isPerfectMatch(){
  const w  = WORLDS[currentWorld];
  const pA = w.unlocks.amp   ? Number(ampSlider.value)               : 1;
  const pB = w.unlocks.freq  ? FREQ_VALUES[Number(freqSlider.value)] : 1;
  const pH = w.unlocks.phase ? Number(phaseSlider.value)             : 0;
  const pD = w.unlocks.shift ? Number(shiftSlider.value)             : 0;
  if(pA !== targetA || pB !== targetB || pD !== targetD) return false;

  // Required h value in π-multiples (adjusted for interference)
  const requiredH = interferenceMode === 'destructive' ? targetCN + 1 : targetCN;

  // Check pH ≡ requiredH (mod 2) — period of both sin and cos is 2π = 2 × π-units
  const diff = pH - requiredH;
  const mod  = ((diff % 2) + 2) % 2;
  return mod < 0.0001 || Math.abs(mod - 2) < 0.0001;
}

// ═══════════════════════════════════════════════
// LABELS
// ═══════════════════════════════════════════════
function wrapFrac(str){
  // Wrap Unicode fraction characters in a .frac span so CSS can enlarge them
  return str.replace(/[¼⅓½¾⅔¾]/g, m=>`<span class="frac">${m}</span>`);
}

function updateLabels(){
  getPlayerValues();
  const w    = WORLDS[currentWorld];
  const h    = w.unlocks.phase ? Number(phaseSlider.value) : 0; // may be half-integer
  const D    = w.unlocks.shift ? Number(shiftSlider.value) : 0;
  const bIdx = w.unlocks.freq  ? Number(freqSlider.value)  : 3;
  const A    = w.unlocks.amp   ? Number(ampSlider.value)   : 1;
  const bStr = FREQ_LABELS[bIdx];

  document.getElementById('ampVal').textContent  = A;
  document.getElementById('freqVal').innerHTML = wrapFrac(bStr);

  // Phase display: format h as a π-fraction label
  document.getElementById('phaseVal').innerHTML = wrapFrac(formatPhaseLabel(h));
  document.getElementById('shiftVal').textContent = (D>=0?'+':'')+D;

  const aStr   = A===1 ? '' : `${A}·`;
  const bEqStr = bStr==='1' ? '' : bStr;
  const dStr   = D===0 ? '' : D>0 ? ` + ${D}` : ` - ${Math.abs(D)}`;
  const cStr   = h===0 ? '' : ` ${h>0?'+':'-'} ${formatPiFrac(Math.abs(h))}`;

  // Function type is locked to target — student can't switch sin/cos
  const fn = targetIsCos ? 'cos' : 'sin';
  const eqStr = `f(x) = ${aStr}${fn}(${bEqStr}x${cStr})${dStr}`;

  document.getElementById('equationDisplay').innerHTML = wrapFrac(eqStr);
}

// Format a number (integer or half-integer) as a π-multiple label e.g. "+½π", "-3π", "+π"
function formatPhaseLabel(h){
  if(h===0) return '+0';
  const sign = h>0 ? '+' : '-';
  const abs  = Math.abs(h);
  if(abs===0.5) return sign+'½π';
  if(abs===1)   return sign+'π';
  if(abs===1.5) return sign+'3π/2';
  if(abs===2)   return sign+'2π';
  if(abs===2.5) return sign+'5π/2';
  if(abs===3)   return sign+'3π';
  if(abs===3.5) return sign+'7π/2';
  if(abs===4)   return sign+'4π';
  return sign+abs+'π';
}

// Format |h| as a π fraction for the equation string (no sign)
function formatPiFrac(abs){
  if(abs===0.5) return '½π';
  if(abs===1)   return 'π';
  if(abs===1.5) return '3π/2';
  if(abs===2)   return '2π';
  if(abs===2.5) return '5π/2';
  if(abs===3)   return '3π';
  if(abs===3.5) return '7π/2';
  if(abs===4)   return '4π';
  return abs+'π';
}

[ampSlider,freqSlider,phaseSlider,shiftSlider].forEach(s=>s.addEventListener('input',updateLabels));

// ═══════════════════════════════════════════════
// CANVAS DRAWING
// ═══════════════════════════════════════════════
function resizeCanvas(){
  canvas.width  = canvas.parentElement.getBoundingClientRect().width - 28;
  canvas.height = 300;
  drawScope();
}

function drawScope(){
  if(!targetA) return;
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#020c07'; ctx.fillRect(0,0,W,H);

  drawGrid(W,H);

  // Target wave — green, drawn with correct trig function
  drawWave(targetA,targetB,targetC,targetD,'#00ff9f',2.5,false,W,H,targetIsCos);
  drawPeakValleyMarkers(targetA,targetB,targetC,targetD,'#00ff9f',W,H,targetIsCos);

  // First shot miss — dim red dashed (same function type as target)
  if(firstShotMissed&&firstShotParams)
    drawWave(firstShotParams.A,firstShotParams.B,firstShotParams.C,firstShotParams.D,'#ff335577',1.5,true,W,H,targetIsCos);

  // Player's current wave — amber, only shown briefly after firing (same function type)
  if(showCurrentAim){
    drawWave(playerA,playerB,playerC,playerD,'#ffaa00',2.5,false,W,H,targetIsCos);
    drawPeakValleyMarkers(playerA,playerB,playerC,playerD,'#ffaa00',W,H,targetIsCos);
  }
}

function drawGrid(W,H){
  const ML=44,MB=28,MT=16,MR=16;
  const plotW=W-ML-MR, plotH=H-MB-MT;
  const xHalfRange=3*Math.PI/targetB;
  canvas._cx     = ML+plotW/2;
  canvas._cy     = MT+plotH/2;
  canvas._xScale = plotW/(2*xHalfRange);
  canvas._yScale = plotH/18;
  const cx=canvas._cx,cy=canvas._cy,xScale=canvas._xScale,yScale=canvas._yScale;

  ctx.strokeStyle='#0a200f'; ctx.lineWidth=1;
  const hp=Math.PI/targetB, nHL=Math.ceil(xHalfRange/hp)+1;
  for(let i=-nHL;i<=nHL;i++){
    const x=cx+i*hp*xScale; if(x<ML||x>W-MR) continue;
    ctx.beginPath(); ctx.moveTo(x,MT); ctx.lineTo(x,H-MB); ctx.stroke();
  }
  for(let i=-8;i<=8;i++){
    const y=cy-i*yScale;
    ctx.beginPath(); ctx.moveTo(ML,y); ctx.lineTo(W-MR,y); ctx.stroke();
  }
  ctx.strokeStyle='#1a4a2a'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(ML,cy); ctx.lineTo(W-MR,cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,MT); ctx.lineTo(cx,H-MB); ctx.stroke();

  ctx.fillStyle='#1a4a2a';
  ctx.beginPath(); ctx.moveTo(W-MR,cy); ctx.lineTo(W-MR-6,cy-4); ctx.lineTo(W-MR-6,cy+4); ctx.fill();
  ctx.beginPath(); ctx.moveTo(cx,MT);   ctx.lineTo(cx-4,MT+6);    ctx.lineTo(cx+4,MT+6);    ctx.fill();

  ctx.fillStyle='#00dd88'; ctx.font='bold 16px Share Tech Mono';
  ctx.textAlign='left';   ctx.fillText('x',W-MR+4,cy+5);
  ctx.textAlign='center'; ctx.fillText('f(x)',cx,MT-2);

  ctx.fillStyle='#00cc77'; ctx.font='15px Share Tech Mono'; ctx.textAlign='center';
  const fp=2*Math.PI/targetB, nPT=Math.ceil(xHalfRange/fp)+1;
  for(let i=-nPT;i<=nPT;i++){
    if(i===0) continue;
    const xVal=i*fp, x=cx+xVal*xScale;
    if(x<ML+10||x>W-MR-10) continue;
    ctx.fillText(formatAsPiFraction(xVal),x,H-MB+16);
    ctx.strokeStyle='#00aa55'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(x,cy-4); ctx.lineTo(x,cy+4); ctx.stroke();
  }
  ctx.textAlign='right';
  [-8,-6,-4,-2,2,4,6,8].forEach(n=>{
    const y=cy-n*yScale;
    if(y<MT||y>H-MB) return;
    ctx.fillStyle='#00cc77'; ctx.font='15px Share Tech Mono';
    ctx.fillText(n,ML-6,y+5);
    ctx.strokeStyle='#00aa55'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(cx-3,y); ctx.lineTo(cx+3,y); ctx.stroke();
  });
  ctx.fillStyle='#00cc77'; ctx.textAlign='right'; ctx.font='15px Share Tech Mono';
  ctx.fillText('0',cx-5,cy+16);
}

function drawWave(A,B,C,D,color,lw,dashed,W,H,isCos=false){
  const cx=canvas._cx,cy=canvas._cy,yScale=canvas._yScale,xScale=canvas._xScale;
  ctx.strokeStyle=color; ctx.lineWidth=lw; ctx.shadowColor=color; ctx.shadowBlur=8;
  if(dashed) ctx.setLineDash([6,4]); else ctx.setLineDash([]);
  ctx.beginPath(); let started=false;
  for(let px=0;px<W;px++){
    const x=(px-cx)/xScale;
    const y = isCos ? A*Math.cos(B*x+C)+D : A*Math.sin(B*x+C)+D;
    const py=cy-y*yScale;
    if(!started){ctx.moveTo(px,py);started=true;} else ctx.lineTo(px,py);
  }
  ctx.stroke(); ctx.shadowBlur=0; ctx.setLineDash([]);
}

function findPeaksValleys(A,B,C,D,isCos=false){
  const cx=canvas._cx,xScale=canvas._xScale;
  const xMin=-cx/xScale, xMax=(canvas.width-cx)/xScale;
  const pts=[];
  // sin peaks at π/2, cos peaks at 0
  const peakOffset = isCos ? 0 : Math.PI/2;
  const valleyOffset = isCos ? Math.PI : -Math.PI/2;
  for(let k=-8;k<=8;k++){
    const xP=(-C+peakOffset+2*Math.PI*k)/B;   if(xP>=xMin&&xP<=xMax) pts.push({x:xP,y:A+D,type:'peak'});
    const xV=(-C+valleyOffset+2*Math.PI*k)/B;  if(xV>=xMin&&xV<=xMax) pts.push({x:xV,y:-A+D,type:'valley'});
  }
  return pts.sort((a,b)=>a.x-b.x);
}

function drawPeakValleyMarkers(A,B,C,D,color,W,H,isCos=false){
  const cx=canvas._cx,cy=canvas._cy,xScale=canvas._xScale,yScale=canvas._yScale;
  const all=findPeaksValleys(A,B,C,D,isCos);
  const sel=[
    ...all.filter(p=>p.type==='peak').sort((a,b)=>Math.abs(a.x)-Math.abs(b.x)).slice(0,2),
    ...all.filter(p=>p.type==='valley').sort((a,b)=>Math.abs(a.x)-Math.abs(b.x)).slice(0,1)
  ];
  ctx.save(); ctx.shadowBlur=0; ctx.setLineDash([]);
  sel.forEach(pt=>{
    const px=cx+pt.x*xScale, py=cy-pt.y*yScale;
    ctx.beginPath(); ctx.arc(px,py,4,0,Math.PI*2);
    ctx.fillStyle=color; ctx.globalAlpha=0.9; ctx.fill(); ctx.globalAlpha=1;
    ctx.strokeStyle=color; ctx.lineWidth=1; ctx.globalAlpha=0.3; ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(px,cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(cx,py); ctx.stroke();
    ctx.setLineDash([]); ctx.globalAlpha=1;
    const xLbl=formatAsPiFraction(pt.x);
    const yLbl=Number.isInteger(pt.y)?pt.y.toString():pt.y.toFixed(1);
    const txt=`(${xLbl}, ${yLbl})`;
    ctx.font='bold 20px Share Tech Mono';
    const tw=ctx.measureText(txt).width, pad=4, bW=tw+pad*2, bH=28;
    let lX=px+8, lY=pt.type==='peak'?py-14:py+32;
    if(lX+bW>W-4) lX=px-bW-8;
    if(lY-bH<4) lY=py+32; if(lY>H-4) lY=py-14;
    ctx.fillStyle='#020c07'; ctx.globalAlpha=0.85;
    ctx.beginPath(); ctx.roundRect(lX-pad,lY-22,bW,bH,3); ctx.fill(); ctx.globalAlpha=1;
    ctx.strokeStyle=color; ctx.lineWidth=1.5; ctx.globalAlpha=0.6;
    ctx.beginPath(); ctx.roundRect(lX-pad,lY-22,bW,bH,3); ctx.stroke(); ctx.globalAlpha=1;
    ctx.fillStyle=color; ctx.textAlign='left'; ctx.fillText(txt,lX,lY-4);
  });
  ctx.restore();
}

function formatAsPiFraction(x){
  if(Math.abs(x)<0.0001) return '0';
  const sign=x<0?-1:1, absX=Math.abs(x);
  for(const d of [1,2,3,4,5,6,7,8,9,10,12]){
    const nRaw=absX*d/Math.PI, n=Math.round(nRaw);
    if(n>0&&Math.abs(n-nRaw)<0.0001){
      const g=gcd(n,d), nr=sign*(n/g), dr=d/g;
      if(dr===1) return nr===1?'π':nr===-1?'-π':`${nr}π`;
      if(nr===1) return `π/${dr}`; if(nr===-1) return `-π/${dr}`;
      return `${nr}π/${dr}`;
    }
  }
  return `${(x/Math.PI).toFixed(2)}π`;
}

function gcd(a,b){ return b===0?a:gcd(b,a%b); }

// ═══════════════════════════════════════════════
// HP RENDERING
// ═══════════════════════════════════════════════
function renderPlayerHP(){
  const c=document.getElementById('playerHP'); c.innerHTML='';
  for(let i=0;i<MAX_PLAYER_HP;i++){
    const p=document.createElement('div');
    p.className='hp-pip '+(i<playerHP?'alive-green':'dead');
    c.appendChild(p);
  }
  // Scale ship part damage: parts fade proportionally as HP drops
  const parts=['ps-body','ps-lwing','ps-rwing','ps-engine'];
  const damaged = MAX_PLAYER_HP - playerHP; // 0=full, MAX=dead
  const threshold = MAX_PLAYER_HP / parts.length;
  parts.forEach((id,i)=>{
    const el=document.getElementById(id);
    if(el) el.style.opacity=(damaged < (i+1)*threshold)?'1':'0.08';
  });
}

function renderAlienHP(){
  const c=document.getElementById('alienHP'); c.innerHTML='';
  for(let i=0;i<alienMaxHP;i++){
    const p=document.createElement('div');
    p.className='hp-pip '+(i<alienHP?'alive-red':'dead');
    c.appendChild(p);
  }
  const destroyed=alienMaxHP-alienHP;
  ['al-hull','al-dome','al-lpod','al-rpod'].forEach((id,i)=>{
    const el=document.getElementById(id);
    if(el) el.style.opacity=(i < Math.floor(destroyed*4/alienMaxHP))?'0.06':'1';
  });
}

function buildPips(){
  const c=document.getElementById('pips'); c.innerHTML='';
  for(let i=0;i<maxAttempts;i++){
    const p=document.createElement('div');
    p.className='pip'; p.id=`pip-${i}`; c.appendChild(p);
  }
}

// ═══════════════════════════════════════════════
// GAME LOOP
// ═══════════════════════════════════════════════
function doAttempt(){
  if(!waveActive||attemptsUsed>=maxAttempts) return;
  getPlayerValues();
  const hit=isPerfectMatch();
  const isFirst=(attemptsUsed===0);
  const pip=document.getElementById(`pip-${attemptsUsed}`);
  attemptsUsed++;

  // Cancel any in-flight aim timer before starting a new one
  if(aimTimer){ clearTimeout(aimTimer); aimTimer=null; }

  showCurrentAim=true; drawScope();
  aimTimer=setTimeout(()=>{ showCurrentAim=false; aimTimer=null; drawScope(); }, 800);

  if(isFirst){
    // ── FIRST SHOT ──
    if(hit){
      pip.classList.add('hit');
      firstShotParams=null; firstShotMissed=false;
      alienHP--;
      renderAlienHP();
      canvas.classList.add('success-flash');
      setTimeout(()=>canvas.classList.remove('success-flash'),600);
      setFeedback('score-perfect','Hit',`${alienHP} section${alienHP!==1?'s':''} remaining.`);
      setBattle('✦','');
      waveActive=false;
      document.getElementById('attemptBtn').disabled=true;
      hideFirstShotBar();
      if(alienHP<=0) setTimeout(onWorldWon,700);
      else setTimeout(nextWave,1400);

    } else {
      // Miss on first shot — lose HP, show equation, give second shot (unless single-shot world)
      pip.classList.add('used');
      firstShotMissed=true;
      firstShotParams={A:playerA,B:playerB,C:playerC,D:playerD};
      showFirstShotBar();

      if(maxAttempts===1){
        // Hyperion: single-shot — miss costs HP
        playerHP--;
        renderPlayerHP();
        canvas.classList.add('damage-flash');
        setTimeout(()=>canvas.classList.remove('damage-flash'),500);
        setFeedback('score-miss','Miss','No second shot here.');
        setBattle('·','');
        waveActive=false;
        document.getElementById('attemptBtn').disabled=true;
        firstShotMissed=false; firstShotParams=null;
        if(playerHP<=0){
          setTimeout(()=>{ hideFirstShotBar(); onGameOver(); }, 800);
        } else {
          setTimeout(()=>{ hideFirstShotBar(); nextWave(); }, 1400);
        }
      } else {
        playerHP--;
        renderPlayerHP();
        canvas.classList.add('damage-flash');
        setTimeout(()=>canvas.classList.remove('damage-flash'),500);
        if(playerHP<=0){
          setFeedback('score-miss','Miss','Hull critical!');
          setBattle('·','');
          waveActive=false;
          document.getElementById('attemptBtn').disabled=true;
          setTimeout(()=>{ hideFirstShotBar(); onGameOver(); }, 800);
        } else {
          setFeedback('score-miss','Miss',`Hull at ${playerHP}. One shot remaining.`);
          setBattle('·','');
          // leave waveActive=true so second shot can fire
        }
      }
    }

  } else {
    // ── SECOND SHOT ──
    firstShotParams=null; firstShotMissed=false;
    if(hit){
      pip.classList.add('hit');
      alienHP--;
      renderAlienHP();
      canvas.classList.add('success-flash');
      setTimeout(()=>canvas.classList.remove('success-flash'),600);
      setFeedback('score-perfect','Hit',`${alienHP} section${alienHP!==1?'s':''} remaining.`);
      setBattle('✦','');
    } else {
      pip.classList.add('used');
      setFeedback('score-miss','Miss','Signal lost. New wave.');
      setBattle('·','');
    }
    waveActive=false;
    document.getElementById('attemptBtn').disabled=true;
    hideFirstShotBar();
    if(alienHP<=0) setTimeout(onWorldWon,700);
    else setTimeout(nextWave,1400);
  }
}

function nextWave(){
  if(alienHP<=0){ onWorldWon(); return; }
  currentWave++;
  attemptsUsed=0; waveActive=true;
  firstShotMissed=false; firstShotParams=null; showCurrentAim=false;
  targetIsCos=false; interferenceMode=null;
  if(aimTimer){ clearTimeout(aimTimer); aimTimer=null; }
  hideFirstShotBar();
  ampSlider.value=1; freqSlider.value=3; phaseSlider.value=0; shiftSlider.value=0;
  generateTarget(); updateLabels(); buildPips(); drawScope();
  updateInterferenceDisplay();
  document.getElementById('attemptBtn').disabled=false;
  document.getElementById('feedback').innerHTML='<div class="feedback-score" style="color:#2a4a3a;font-size:0.7rem;">—</div>';
  document.getElementById('targetHint').textContent='';
  setBattle('·','');
  updateWaveBadge();
}

function showQuitConfirm(){
  document.getElementById('quitConfirm').classList.add('visible');
}

function hideQuitConfirm(){
  document.getElementById('quitConfirm').classList.remove('visible');
}

function confirmQuit(){
  hideQuitConfirm();
  showEndScreen(false);
}

function setFeedback(cls,title,msg){
  document.getElementById('feedback').innerHTML=
    `<div class="feedback-score ${cls}">${title}</div><div class="feedback-msg">${msg}</div>`;
}

function updateInterferenceDisplay(){
  const el = document.getElementById('interferenceDisplay');
  if(!el) return;
  if(!interferenceMode){
    el.style.display='none';
    el.innerHTML='';
    return;
  }
  el.style.display='block';
  if(interferenceMode==='constructive'){
    el.innerHTML=`
      <div style="
        font-family:'Orbitron',sans-serif;
        font-size:clamp(1rem,2.5vw,1.5rem);
        font-weight:700;
        letter-spacing:0.2em;
        color:var(--green);
        text-shadow:var(--glow);
        text-align:center;
        padding:14px 20px;
        margin-top:10px;
        border:1px solid #00ff9f44;
        border-radius:4px;
        background:#00100700;
      ">▲ Constructively interfere with the signal!</div>`;
  } else {
    el.innerHTML=`
      <div style="
        font-family:'Orbitron',sans-serif;
        font-size:clamp(1rem,2.5vw,1.5rem);
        font-weight:700;
        letter-spacing:0.2em;
        color:var(--red);
        text-shadow:var(--red-glow);
        text-align:center;
        padding:14px 20px;
        margin-top:10px;
        border:1px solid #ff335544;
        border-radius:4px;
        background:#00100700;
      ">▼ Destructively interfere with the signal!</div>`;
  }
}

function showFirstShotBar(){
  const bar=document.getElementById('shot1Bar');
  const disp=document.getElementById('shot1Display');
  const w=WORLDS[currentWorld];
  const A=playerA;
  const bIdx=w.unlocks.freq?Number(freqSlider.value):3;
  const bStr=FREQ_LABELS[bIdx];
  const h=w.unlocks.phase?Number(phaseSlider.value):0;
  const D=playerD;

  const aStr=A===1?'':`${A}·`;
  const bEqStr=bStr==='1'?'':bStr;
  const dStr=D===0?'':D>0?` + ${D}`:` - ${Math.abs(D)}`;

  const fn = targetIsCos ? 'cos' : 'sin';
  const cStr = h===0?'':` ${h>0?'+':'-'} ${formatPiFrac(Math.abs(h))}`;
  const eqStr=`f(x) = ${aStr}${fn}(${bEqStr}x${cStr})${dStr}`;
  disp.innerHTML=wrapFrac(eqStr);
  bar.style.display='flex';
}

function hideFirstShotBar(){
  document.getElementById('shot1Bar').style.display='none';
  document.getElementById('shot1Display').textContent='';
}

function setBattle(icon,msg){
  document.getElementById('battleIcon').textContent=icon;
  document.getElementById('battleMsg').textContent=msg;
}

function updateWaveBadge(){
  document.getElementById('roundBadge').textContent=`Wave ${currentWave}`;
}

// ═══════════════════════════════════════════════
// WIN / LOSE
// ═══════════════════════════════════════════════
function onWorldWon(){
  worldsCleared.add(currentWorld);
  const world  = WORLDS[currentWorld];
  const isLast = currentWorld === WORLDS.length-1;

  // Unlock next world permanently
  if(!isLast){
    worldsUnlocked.add(currentWorld+1);
  }
  saveProgress();

  if(isLast){
    showEndScreen(true);
  } else {
    const next = WORLDS[currentWorld+1];
    const unlockMsgs = [
      'Phase Shift controls unlocked.',
      'Cosine waves now possible — watch the peaks.',
      'Final boss — one shot only. Constructive and destructive interference required.'
    ];
    document.getElementById('worldClearTitle').textContent = world.name+' Cleared!';
    document.getElementById('worldClearTitle').className = 'overlay-title win';
    document.getElementById('worldClearTitle').style.color = '';
    document.getElementById('worldClearTitle').style.textShadow = '';
    document.getElementById('worldClearSub').innerHTML =
      `<span style="color:${next.color};font-family:Orbitron,sans-serif;">${next.name}</span> is now unlocked.<br>
       <span style="font-size:0.9rem;">${unlockMsgs[currentWorld]||''}</span>`;
    document.getElementById('worldClearOverlay').classList.add('active');
  }
}

function onGameOver(){
  // Respawn: restore full HP and return to map, keeping cleared worlds and staying on current world
  playerHP = MAX_PLAYER_HP;
  const world = WORLDS[currentWorld];
  document.getElementById('worldClearTitle').textContent = 'Ship Destroyed';
  document.getElementById('worldClearTitle').className = 'overlay-title'; // remove .win
  document.getElementById('worldClearTitle').style.color = 'var(--red)';
  document.getElementById('worldClearTitle').style.textShadow = '0 0 30px #ff3355, 0 0 60px #ff335566';
  document.getElementById('worldClearSub').innerHTML =
    `Hull breached over <span style="color:${world.color};font-family:Orbitron,sans-serif;">${world.name}</span>.<br>
     <span style="font-size:0.8rem;color:var(--muted);">Hull restored. Retrying from this position.</span>`;
  document.getElementById('worldClearOverlay').classList.add('active');
}

function showEndScreen(victory){
  const beaten    = worldsCleared.size;
  const names     = [...worldsCleared].map(i=>WORLDS[i].name).join(', ') || 'None';
  const hpLeft    = playerHP;

  document.getElementById('endTitle').textContent = victory ? 'Fleet Defeated' : 'Ship Destroyed';
  document.getElementById('endTitle').className   = 'end-title '+(victory?'victory':'defeat');
  document.getElementById('endSubtitle').textContent = victory
    ? 'The Saturn system is secure. Mission accomplished.'
    : 'Your signal went dark. The enemy advances.';

  document.getElementById('endStats').innerHTML = `
    <div class="end-stat">
      <span class="end-stat-label">Worlds Cleared</span>
      <span class="end-stat-value">${beaten} / ${WORLDS.length}</span>
    </div>
    <div class="end-stat">
      <span class="end-stat-label">Planets</span>
      <span class="end-stat-value" style="font-size:0.82rem;">${names}</span>
    </div>
    <hr class="end-divider">
    <div class="end-stat">
      <span class="end-stat-label">Hull Integrity</span>
      <span class="end-stat-value ${hpLeft<=1?'red':''}">${hpLeft} / ${MAX_PLAYER_HP}</span>
    </div>
    <div class="end-stat">
      <span class="end-stat-label">Waves Survived</span>
      <span class="end-stat-value">${currentWave}</span>
    </div>
  `;
  showScreen('endScreen');
}

// ═══════════════════════════════════════════════
// DEBUG MODE  (Shift + ` while on map screen)
// ═══════════════════════════════════════════════
let debugMode = false;

function toggleDebugMode(){
  debugMode = !debugMode;
  const bar = document.getElementById('debugBar');
  bar.style.display = debugMode ? 'flex' : 'none';
  if(debugMode) renderDebugBar();
}

function renderDebugBar(){
  const list = document.getElementById('debugWorldList');
  list.innerHTML = '';
  WORLDS.forEach((world, i) => {
    const col = document.createElement('div');
    col.style.cssText = 'display:flex;flex-direction:column;gap:6px;align-items:center;';

    const btn = document.createElement('button');
    btn.className = 'debug-world-btn';
    btn.style.borderColor = world.color;
    btn.style.color = world.color;
    btn.innerHTML = `<span style="font-size:0.6rem;opacity:0.6;display:block;letter-spacing:0.15em;">${i===currentWorld?'► ':''}</span>${world.name}`;
    btn.onclick = () => {
      currentWorld = i;
      playerHP = MAX_PLAYER_HP;
      briefingsSeen.add(i);
      toggleDebugMode();
      enterWorldDirect(i);
    };

    const briefBtn = document.createElement('button');
    briefBtn.className = 'debug-world-btn';
    briefBtn.style.borderColor = world.color + '88';
    briefBtn.style.color = world.color + 'aa';
    briefBtn.style.fontSize = '0.55rem';
    briefBtn.style.padding = '5px 10px';
    briefBtn.textContent = '📋 Briefing';
    briefBtn.onclick = () => {
      toggleDebugMode();
      showBriefing(i, true);
    };

    col.appendChild(btn);
    col.appendChild(briefBtn);
    list.appendChild(col);
  });
}

window.addEventListener('keydown', e => {
  if(e.shiftKey && (e.key === '`' || e.key === '~')){
    if(document.getElementById('mapScreen').classList.contains('active')){
      toggleDebugMode();
    }
  }
  if(e.key === 'Escape' && debugMode){
    toggleDebugMode();
  }
});

// ═══════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════
window.addEventListener('resize', ()=>{
  if(document.getElementById('gameScreen').classList.contains('active')) resizeCanvas();
});
</script>
</body>
</html>
