<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WAVE MATCHER â€” Synth Lab</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

  :root {
    --bg: #0a0a0f;
    --panel: #0f0f1a;
    --border: #1a1a2e;
    --green: #00ff9f;
    --amber: #ffaa00;
    --red: #ff3355;
    --blue: #00aaff;
    --dim: #1e2a1e;
    --text: #c8ffd4;
    --muted: #4a6a4a;
    --glow: 0 0 10px #00ff9f88, 0 0 20px #00ff9f44;
    --amber-glow: 0 0 10px #ffaa0088, 0 0 20px #ffaa0044;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background-image:
      radial-gradient(ellipse at 20% 10%, #001a0e44 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, #001020 0%, transparent 50%);
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 100;
  }

  h1 {
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: clamp(1.2rem, 3vw, 2rem);
    letter-spacing: 0.3em;
    color: var(--green);
    text-shadow: var(--glow);
    margin-bottom: 4px;
    text-transform: uppercase;
  }

  .subtitle {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.2em;
    margin-bottom: 20px;
  }

  .main-layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 16px;
    width: 100%;
    max-width: 1000px;
  }

  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    position: relative;
  }

  .panel-label {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    color: var(--muted);
    margin-bottom: 10px;
    text-transform: uppercase;
  }

  /* OSCILLOSCOPE */
  .scope-wrap {
    position: relative;
  }

  canvas {
    display: block;
    width: 100%;
    border: 1px solid #0f2a1a;
    border-radius: 3px;
    background: #020c07;
    box-shadow: inset 0 0 30px #000a04, 0 0 15px #00ff9f11;
  }

  .scope-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    border-radius: 3px;
    background:
      radial-gradient(ellipse at 50% 50%, transparent 60%, #020c0799 100%);
  }

  /* LEGEND */
  .legend {
    display: flex;
    gap: 20px;
    margin-top: 10px;
    font-size: 0.65rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--muted);
  }

  .legend-line {
    width: 24px;
    height: 2px;
    border-radius: 1px;
  }

  /* CONTROLS PANEL */
  .controls-panel {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .param-block {
    background: #080812;
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 12px;
  }

  .param-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 8px;
  }

  .param-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    color: var(--amber);
    text-shadow: var(--amber-glow);
  }

  .param-formula {
    font-size: 0.6rem;
    color: #4a4a6a;
  }

  .param-value {
    font-size: 1.1rem;
    color: var(--green);
    text-shadow: var(--glow);
    text-align: center;
    margin-bottom: 6px;
    letter-spacing: 0.05em;
  }

  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    background: #0f2a1a;
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }

  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--amber);
    border-radius: 2px;
    box-shadow: 0 0 8px #ffaa0088;
    cursor: pointer;
    transform: rotate(45deg);
  }

  input[type=range]::-webkit-slider-runnable-track {
    background: linear-gradient(to right, #0f2a1a, #1a3a2a);
    border-radius: 2px;
  }

  /* EQUATION DISPLAY */
  .equation-display {
    background: #020c07;
    border: 1px solid #0f2a1a;
    border-radius: 3px;
    padding: 10px;
    text-align: center;
    font-size: 0.85rem;
    color: var(--green);
    text-shadow: var(--glow);
    letter-spacing: 0.05em;
  }

  /* ATTEMPT BUTTON */
  .attempt-btn {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    background: transparent;
    border: 2px solid var(--green);
    color: var(--green);
    padding: 12px;
    border-radius: 3px;
    cursor: pointer;
    width: 100%;
    transition: all 0.15s;
    text-shadow: var(--glow);
    box-shadow: inset 0 0 0 0 var(--green), var(--glow);
  }

  .attempt-btn:hover {
    background: #00ff9f22;
    box-shadow: inset 0 0 20px #00ff9f11, var(--glow);
  }

  .attempt-btn:active {
    background: #00ff9f33;
    transform: scale(0.98);
  }

  .attempt-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* FEEDBACK */
  .feedback {
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 4px;
  }

  .feedback-score {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
  }

  .feedback-msg {
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  .score-perfect { color: var(--green); text-shadow: var(--glow); }
  .score-good { color: var(--amber); text-shadow: var(--amber-glow); }
  .score-miss { color: var(--red); text-shadow: 0 0 10px #ff335588; }

  /* ATTEMPTS COUNTER */
  .attempts-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.6rem;
    color: var(--muted);
  }

  .attempt-pips {
    display: flex;
    gap: 5px;
  }

  .pip {
    width: 8px;
    height: 8px;
    border-radius: 1px;
    border: 1px solid var(--muted);
    transform: rotate(45deg);
  }

  .pip.used { background: var(--amber); border-color: var(--amber); box-shadow: 0 0 6px #ffaa0088; }
  .pip.hit { background: var(--green); border-color: var(--green); box-shadow: 0 0 6px #00ff9f88; }

  /* NEW WAVE BUTTON */
  .new-btn {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    background: transparent;
    border: 1px solid #2a2a4a;
    color: #4a4a8a;
    padding: 8px;
    border-radius: 3px;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
    margin-top: 4px;
  }

  .new-btn:hover {
    border-color: var(--blue);
    color: var(--blue);
    box-shadow: 0 0 10px #00aaff33;
  }

  /* STATUS BAR */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 1000px;
    margin-top: 12px;
    padding: 8px 12px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 3px;
    font-size: 0.6rem;
    color: var(--muted);
  }

  .status-freq {
    color: var(--green);
    text-shadow: var(--glow);
  }

  /* Grid lines in canvas */
  .target-hint {
    font-size: 0.6rem;
    color: #2a4a3a;
    margin-top: 6px;
    text-align: right;
    letter-spacing: 0.1em;
  }

  .success-flash {
    animation: flashGreen 0.5s ease;
  }

  @keyframes flashGreen {
    0% { box-shadow: 0 0 0px #00ff9f; }
    50% { box-shadow: 0 0 40px #00ff9f88, 0 0 80px #00ff9f44; }
    100% { box-shadow: 0 0 0px #00ff9f; }
  }

  @media (max-width: 700px) {
    .main-layout {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<h1>Wave Matcher</h1>
<p class="subtitle">Synth Lab â€” Sinusoidal Function Trainer</p>

<div class="main-layout">

  <!-- LEFT: OSCILLOSCOPE -->
  <div class="panel scope-wrap">
    <div class="panel-label">ðŸ“¡ Oscilloscope Display</div>
    <canvas id="scope" height="320"></canvas>
    <div class="scope-overlay"></div>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-line" style="background:#00ff9f; box-shadow: 0 0 4px #00ff9f;"></div>
        <span>Target wave</span>
      </div>
      <div class="legend-item">
        <div class="legend-line" style="background:#ffaa00; box-shadow: 0 0 4px #ffaa00; border-top: 2px dashed #ffaa00; height:0;"></div>
        <span>Your wave (after attempt)</span>
      </div>
    </div>
    <div class="target-hint" id="targetHint">â–¸ SET YOUR PARAMETERS AND HIT ATTEMPT</div>
  </div>

  <!-- RIGHT: CONTROLS -->
  <div class="controls-panel">

    <div class="panel">
      <div class="panel-label">ðŸŽ› Synthesizer Parameters</div>

      <!-- AMPLITUDE -->
      <div class="param-block">
        <div class="param-header">
          <span class="param-name">Amplitude</span>
          <span class="param-formula">A in AÂ·sin(...)</span>
        </div>
        <div class="param-value" id="ampVal">1.0</div>
        <input type="range" id="ampSlider" min="0.5" max="5" step="0.5" value="1">
        <div style="display:flex;justify-content:space-between;font-size:0.55rem;color:var(--muted);margin-top:3px;">
          <span>0.5</span><span>5.0</span>
        </div>
      </div>

      <!-- FREQUENCY / B -->
      <div class="param-block">
        <div class="param-header">
          <span class="param-name">Frequency</span>
          <span class="param-formula">B in sin(BÂ·x)</span>
        </div>
        <div class="param-value" id="freqVal">1.0</div>
        <input type="range" id="freqSlider" min="0.5" max="4" step="0.5" value="1">
        <div style="display:flex;justify-content:space-between;font-size:0.55rem;color:var(--muted);margin-top:3px;">
          <span>0.5Ã—</span><span>4.0Ã—</span>
        </div>
      </div>

      <!-- PHASE SHIFT -->
      <div class="param-block">
        <div class="param-header">
          <span class="param-name">Phase Shift</span>
          <span class="param-formula">C in sin(Bx + C)</span>
        </div>
        <div class="param-value" id="phaseVal">0</div>
        <input type="range" id="phaseSlider" min="-3" max="3" step="1" value="0">
        <div style="display:flex;justify-content:space-between;font-size:0.55rem;color:var(--muted);margin-top:3px;">
          <span>âˆ’3</span><span>+3</span>
        </div>
      </div>

      <!-- VERTICAL SHIFT -->
      <div class="param-block">
        <div class="param-header">
          <span class="param-name">Vertical Shift</span>
          <span class="param-formula">D in sin(...) + D</span>
        </div>
        <div class="param-value" id="shiftVal">0</div>
        <input type="range" id="shiftSlider" min="-3" max="3" step="1" value="0">
        <div style="display:flex;justify-content:space-between;font-size:0.55rem;color:var(--muted);margin-top:3px;">
          <span>âˆ’3</span><span>+3</span>
        </div>
      </div>

    </div>

    <!-- EQUATION DISPLAY -->
    <div class="panel">
      <div class="panel-label">Your Equation</div>
      <div class="equation-display" id="equationDisplay">f(x) = 1.0Â·sin(1.0x + 0) + 0</div>
    </div>

    <!-- FEEDBACK -->
    <div class="panel">
      <div class="panel-label">Signal Analysis</div>
      <div class="feedback" id="feedback">
        <div class="feedback-score" style="color:#2a4a3a; font-size:0.7rem;">â€” AWAITING ATTEMPT â€”</div>
      </div>
      <div class="attempts-row">
        <span>ATTEMPTS</span>
        <div class="attempt-pips" id="pips"></div>
      </div>
    </div>

    <button class="attempt-btn" id="attemptBtn" onclick="doAttempt()">â¬¡ Attempt Match</button>
    <button class="new-btn" onclick="newWave()">â†º Generate New Target Wave</button>

  </div>
</div>

<div class="status-bar">
  <span>WAVE MATCHER v0.3 â€” SYNTH LAB</span>
  <span id="targetFreqDisplay" class="status-freq">TARGET: â€” Hz</span>
  <span id="roundDisplay">ROUND 1</span>
</div>

<script>
  const canvas = document.getElementById('scope');
  const ctx = canvas.getContext('2d');

  let targetA, targetB, targetC, targetD;
  let playerA, playerB, playerC, playerD;
  let attemptsUsed = 0;
  let maxAttempts = 5;
  let showPlayerWave = false;
  let round = 1;
  let solved = false;

  // Slider refs
  const ampSlider = document.getElementById('ampSlider');
  const freqSlider = document.getElementById('freqSlider');
  const phaseSlider = document.getElementById('phaseSlider');
  const shiftSlider = document.getElementById('shiftSlider');

  function getPlayerValues() {
    playerA = parseFloat(ampSlider.value);
    playerB = parseFloat(freqSlider.value);
    playerC = parseFloat(phaseSlider.value);
    playerD = parseFloat(shiftSlider.value);
  }

  function updateLabels() {
    getPlayerValues();
    document.getElementById('ampVal').textContent = playerA.toFixed(1);
    document.getElementById('freqVal').textContent = playerB.toFixed(1);
    document.getElementById('phaseVal').textContent = (playerC >= 0 ? '+' : '') + playerC;
    document.getElementById('shiftVal').textContent = (playerD >= 0 ? '+' : '') + playerD;

    // Equation
    let eq = `f(x) = ${playerA.toFixed(1)}Â·sin(${playerB.toFixed(1)}x`;
    if (playerC !== 0) eq += ` ${playerC > 0 ? '+' : ''}${playerC}`;
    eq += `)`;
    if (playerD !== 0) eq += ` ${playerD > 0 ? '+' : ''}${playerD}`;
    document.getElementById('equationDisplay').textContent = eq;
  }

  [ampSlider, freqSlider, phaseSlider, shiftSlider].forEach(s => {
    s.addEventListener('input', () => { updateLabels(); });
  });

  function resizeCanvas() {
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width - 32;
    canvas.height = 320;
    drawScope();
  }

  // Convert math x -> pixel x
  function mathToPixelX(x, cx, xScale) { return cx + x * xScale; }
  // Convert math y -> pixel y
  function mathToPixelY(y, cy, yScale) { return cy - y * yScale; }

  function findPeaksValleys(A, B, C, D) {
    const cx = canvas._cx, xScale = canvas._xScale;
    const xMin = -cx / xScale;
    const xMax = (canvas.width - cx) / xScale;
    const points = [];

    for (let k = -8; k <= 8; k++) {
      const xPeak = (Math.PI / 2 - C + 2 * Math.PI * k) / B;
      if (xPeak >= xMin && xPeak <= xMax) {
        points.push({ x: xPeak, y: A + D, type: 'peak' });
      }
      const xValley = (-Math.PI / 2 - C + 2 * Math.PI * k) / B;
      if (xValley >= xMin && xValley <= xMax) {
        points.push({ x: xValley, y: -A + D, type: 'valley' });
      }
    }
    points.sort((a, b) => a.x - b.x);
    return points;
  }

  function drawPeakValleyMarkers(A, B, C, D, color, W, H) {
    const cx = canvas._cx, cy = canvas._cy;
    const xScale = canvas._xScale, yScale = canvas._yScale;

    const allPoints = findPeaksValleys(A, B, C, D);

    const peaks = allPoints.filter(p => p.type === 'peak');
    const valleys = allPoints.filter(p => p.type === 'valley');

    peaks.sort((a, b) => Math.abs(a.x) - Math.abs(b.x));
    valleys.sort((a, b) => Math.abs(a.x) - Math.abs(b.x));

    const selected = [
      ...peaks.slice(0, 2),
      ...valleys.slice(0, 1)
    ];

    ctx.save();
    ctx.shadowBlur = 0;
    ctx.setLineDash([]);

    selected.forEach(pt => {
      const px = cx + pt.x * xScale;
      const py = cy - pt.y * yScale;

      // Dot
      ctx.beginPath();
      ctx.arc(px, py, 4, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.9;
      ctx.fill();
      ctx.globalAlpha = 1;

      // Drop lines to axes
      ctx.strokeStyle = color;
      ctx.lineWidth = 1;
      ctx.globalAlpha = 0.3;
      ctx.setLineDash([3, 3]);
      ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px, cy); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(cx, py); ctx.stroke();
      ctx.setLineDash([]);
      ctx.globalAlpha = 1;

      // Coordinate label
      const xLabel = formatAsPiFraction(pt.x);
      const yLabel = Number.isInteger(pt.y) ? pt.y.toString() : pt.y.toFixed(1);
      const coordText = `(${xLabel}, ${yLabel})`;

      const padding = 4;
      ctx.font = 'bold 40px Share Tech Mono';
      const tw = ctx.measureText(coordText).width;
      const boxW = tw + padding * 2;
      const boxH = 52;

      let labelX = px + 10;
      let labelY = pt.type === 'peak' ? py - 30 : py + 58;

      if (labelX + boxW > W - 4) labelX = px - boxW - 10;
      if (labelY - boxH < 4) labelY = py + 58;
      if (labelY > H - 4) labelY = py - 30;

      // Background
      ctx.fillStyle = '#020c07';
      ctx.globalAlpha = 0.85;
      ctx.beginPath();
      ctx.roundRect(labelX - padding, labelY - 44, boxW, boxH, 4);
      ctx.fill();
      ctx.globalAlpha = 1;

      // Border
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.6;
      ctx.beginPath();
      ctx.roundRect(labelX - padding, labelY - 44, boxW, boxH, 4);
      ctx.stroke();
      ctx.globalAlpha = 1;

      // Text
      ctx.fillStyle = color;
      ctx.textAlign = 'left';
      ctx.fillText(coordText, labelX, labelY - 8);
    });

    ctx.restore();
  }

  function formatAsPiFraction(x) {
    // Try to express x as (n/d)*Ï€ with small denominators
    const denominators = [1, 2, 3, 4, 6, 8, 12];
    for (const d of denominators) {
      const n = Math.round(x * d / Math.PI);
      if (Math.abs(n * Math.PI / d - x) < 0.001) {
        if (n === 0) return '0';
        if (d === 1) return n === 1 ? 'Ï€' : n === -1 ? '-Ï€' : `${n}Ï€`;
        if (n === 1) return `Ï€/${d}`;
        if (n === -1) return `-Ï€/${d}`;
        return `${n}Ï€/${d}`;
      }
    }
    // Fallback: decimal rounded to 2 places
    return (x).toFixed(2);
  }

  function drawScope() {
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    // Background
    ctx.fillStyle = '#020c07';
    ctx.fillRect(0, 0, W, H);

    // Grid
    drawGrid(W, H);

    // Target wave
    drawWave(targetA, targetB, targetC, targetD, '#00ff9f', 2.5, false, W, H);

    // Peak/valley markers on target wave
    drawPeakValleyMarkers(targetA, targetB, targetC, targetD, '#00ff9f', W, H);

    // Player wave (only after attempt)
    if (showPlayerWave) {
      drawWave(playerA, playerB, playerC, playerD, '#ffaa00', 2, true, W, H);
      drawPeakValleyMarkers(playerA, playerB, playerC, playerD, '#ffaa00', W, H);
    }
  }

  function drawGrid(W, H) {
    const MARGIN_LEFT = 36;
    const MARGIN_BOTTOM = 24;
    const MARGIN_TOP = 16;
    const MARGIN_RIGHT = 16;

    const plotW = W - MARGIN_LEFT - MARGIN_RIGHT;
    const plotH = H - MARGIN_BOTTOM - MARGIN_TOP;

    // Store as globals for wave drawing to share
    canvas._cx = MARGIN_LEFT + plotW / 2;
    canvas._cy = MARGIN_TOP + plotH / 2;
    canvas._xScale = plotW / (4 * Math.PI);
    canvas._yScale = plotH / 14;

    const cx = canvas._cx, cy = canvas._cy;
    const xScale = canvas._xScale, yScale = canvas._yScale;

    // Grid
    ctx.strokeStyle = '#0a200f';
    ctx.lineWidth = 1;

    for (let i = -4; i <= 4; i++) {
      const x = cx + i * Math.PI * xScale;
      ctx.beginPath(); ctx.moveTo(x, MARGIN_TOP); ctx.lineTo(x, H - MARGIN_BOTTOM); ctx.stroke();
    }
    for (let i = -6; i <= 6; i++) {
      const y = cy - i * yScale;
      ctx.beginPath(); ctx.moveTo(MARGIN_LEFT, y); ctx.lineTo(W - MARGIN_RIGHT, y); ctx.stroke();
    }

    // Axes
    ctx.strokeStyle = '#1a4a2a';
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(MARGIN_LEFT, cy); ctx.lineTo(W - MARGIN_RIGHT, cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx, MARGIN_TOP); ctx.lineTo(cx, H - MARGIN_BOTTOM); ctx.stroke();

    // Axis arrow tips
    ctx.fillStyle = '#1a4a2a';
    // Right arrow
    ctx.beginPath();
    ctx.moveTo(W - MARGIN_RIGHT, cy);
    ctx.lineTo(W - MARGIN_RIGHT - 6, cy - 4);
    ctx.lineTo(W - MARGIN_RIGHT - 6, cy + 4);
    ctx.fill();
    // Up arrow
    ctx.beginPath();
    ctx.moveTo(cx, MARGIN_TOP);
    ctx.lineTo(cx - 4, MARGIN_TOP + 6);
    ctx.lineTo(cx + 4, MARGIN_TOP + 6);
    ctx.fill();

    // X-axis label
    ctx.fillStyle = '#2a6a3a';
    ctx.font = '11px Share Tech Mono';
    ctx.textAlign = 'left';
    ctx.fillText('x', W - MARGIN_RIGHT + 4, cy + 4);

    // Y-axis label
    ctx.textAlign = 'center';
    ctx.fillText('f(x)', cx, MARGIN_TOP - 4);

    // X-axis tick labels (Ï€ fractions)
    ctx.fillStyle = '#2a5a3a';
    ctx.font = '10px Share Tech Mono';
    ctx.textAlign = 'center';

    const piTicks = [-2, -1, 1, 2];
    piTicks.forEach(n => {
      const x = cx + n * Math.PI * xScale;
      const label = n === 1 ? 'Ï€' : n === -1 ? '-Ï€' : `${n}Ï€`;
      ctx.fillText(label, x, H - MARGIN_BOTTOM + 14);
      // Tick mark
      ctx.strokeStyle = '#1a4a2a';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(x, cy - 3); ctx.lineTo(x, cy + 3); ctx.stroke();
    });

    // Y-axis tick labels
    ctx.textAlign = 'right';
    [-4, -2, 2, 4].forEach(n => {
      const y = cy - n * yScale;
      ctx.fillText(n, MARGIN_LEFT - 6, y + 4);
      // Tick mark
      ctx.strokeStyle = '#1a4a2a';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(cx - 3, y); ctx.lineTo(cx + 3, y); ctx.stroke();
    });

    // Origin label
    ctx.fillStyle = '#1e4a2a';
    ctx.textAlign = 'right';
    ctx.fillText('0', cx - 5, cy + 14);
  }

  function drawWave(A, B, C, D, color, lineWidth, dashed, W, H) {
    const cx = canvas._cx, cy = canvas._cy;
    const yScale = canvas._yScale, xScale = canvas._xScale;

    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.shadowColor = color;
    ctx.shadowBlur = 8;

    if (dashed) ctx.setLineDash([6, 4]);
    else ctx.setLineDash([]);

    ctx.beginPath();
    let started = false;

    for (let px = 0; px < W; px++) {
      const x = (px - cx) / xScale;
      const y = A * Math.sin(B * x + C) + D;
      const py = cy - y * yScale;

      if (!started) { ctx.moveTo(px, py); started = true; }
      else ctx.lineTo(px, py);
    }
    ctx.stroke();
    ctx.shadowBlur = 0;
    ctx.setLineDash([]);
  }

  function generateTarget() {
    const ampChoices = [1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5];
    const freqChoices = [0.5, 1, 1.5, 2, 2.5, 3];
    const phaseChoices = [-3, -2, -1, 0, 1, 2, 3];
    const shiftChoices = [-3, -2, -1, 0, 1, 2, 3];

    targetA = ampChoices[Math.floor(Math.random() * ampChoices.length)];
    targetB = freqChoices[Math.floor(Math.random() * freqChoices.length)];
    targetC = phaseChoices[Math.floor(Math.random() * phaseChoices.length)];
    targetD = shiftChoices[Math.floor(Math.random() * shiftChoices.length)];

    // Display equivalent "Hz" for immersion (B maps to frequency)
    // Base 440 Hz * B
    const hz = (440 * targetB).toFixed(0);
    document.getElementById('targetFreqDisplay').textContent = `TARGET FREQ: ${hz} Hz (B=${targetB})`;
  }

  function buildPips() {
    const container = document.getElementById('pips');
    container.innerHTML = '';
    for (let i = 0; i < maxAttempts; i++) {
      const pip = document.createElement('div');
      pip.className = 'pip';
      pip.id = `pip-${i}`;
      container.appendChild(pip);
    }
  }

  function scoreAttempt() {
    // Score each parameter
    const aScore = 1 - Math.abs(playerA - targetA) / 5;
    const bScore = 1 - Math.abs(playerB - targetB) / 4;
    const cScore = 1 - Math.abs(playerC - targetC) / 6;
    const dScore = 1 - Math.abs(playerD - targetD) / 6;
    return Math.max(0, (aScore + bScore + cScore + dScore) / 4);
  }

  function doAttempt() {
    if (attemptsUsed >= maxAttempts || solved) return;
    getPlayerValues();
    showPlayerWave = true;
    drawScope();

    const score = scoreAttempt();
    const pipEl = document.getElementById(`pip-${attemptsUsed}`);

    const exactA = playerA === targetA;
    const exactB = playerB === targetB;
    const exactC = playerC === targetC;
    const exactD = playerD === targetD;
    const perfect = exactA && exactB && exactC && exactD;

    attemptsUsed++;

    if (perfect) {
      pipEl.classList.add('hit');
      solved = true;
      document.getElementById('attemptBtn').disabled = true;
      document.getElementById('feedback').innerHTML = `
        <div class="feedback-score score-perfect">âœ“ MATCH LOCKED</div>
        <div class="feedback-msg">Perfect signal sync â€” all parameters correct!</div>
      `;
      canvas.classList.add('success-flash');
      document.getElementById('targetHint').textContent = 'â–¸ SIGNAL MATCHED â€” GENERATE NEW WAVE TO CONTINUE';
    } else {
      pipEl.classList.add('used');
      // Give helpful hints
      let hints = [];
      if (!exactA) hints.push(`A: ${playerA < targetA ? 'â†‘ too low' : 'â†“ too high'}`);
      if (!exactB) hints.push(`B: ${playerB < targetB ? 'â†‘ too low' : 'â†“ too high'}`);
      if (!exactC) hints.push(`C: ${playerC < targetC ? 'â†‘ too low' : 'â†“ too high'}`);
      if (!exactD) hints.push(`D: ${playerD < targetD ? 'â†‘ too low' : 'â†“ too high'}`);

      const pct = Math.round(score * 100);
      const remaining = maxAttempts - attemptsUsed;

      if (attemptsUsed >= maxAttempts) {
        // Game over - reveal answer
        document.getElementById('attemptBtn').disabled = true;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback-score score-miss">NO SIGNAL</div>
          <div class="feedback-msg">Target: A=${targetA}, B=${targetB}, C=${targetC}, D=${targetD}</div>
          <div class="feedback-msg" style="margin-top:4px;">Generate a new wave to try again.</div>
        `;
      } else {
        const cls = pct >= 75 ? 'score-good' : 'score-miss';
        document.getElementById('feedback').innerHTML = `
          <div class="feedback-score ${cls}">${pct}% MATCH</div>
          <div class="feedback-msg">${hints.join(' Â· ')}</div>
          <div class="feedback-msg" style="margin-top:4px;">${remaining} attempt${remaining !== 1 ? 's' : ''} remaining</div>
        `;
      }
      document.getElementById('targetHint').textContent = 'â–¸ ADJUST PARAMETERS AND TRY AGAIN';
    }

    // Hide player wave again so they must re-attempt to see
    showPlayerWave = false;
  }

  function newWave() {
    attemptsUsed = 0;
    showPlayerWave = false;
    solved = false;
    round++;

    // Reset sliders
    ampSlider.value = 1;
    freqSlider.value = 1;
    phaseSlider.value = 0;
    shiftSlider.value = 0;
    updateLabels();

    generateTarget();
    buildPips();
    drawScope();

    document.getElementById('attemptBtn').disabled = false;
    document.getElementById('feedback').innerHTML = `
      <div class="feedback-score" style="color:#2a4a3a; font-size:0.7rem;">â€” AWAITING ATTEMPT â€”</div>
    `;
    document.getElementById('targetHint').textContent = 'â–¸ SET YOUR PARAMETERS AND HIT ATTEMPT';
    document.getElementById('roundDisplay').textContent = `ROUND ${round}`;
    canvas.classList.remove('success-flash');
  }

  // Init
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();
  generateTarget();
  buildPips();
  updateLabels();
  drawScope();
</script>
</body>
</html>
